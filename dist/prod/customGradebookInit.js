(()=>{var go=Object.defineProperty,ho=Object.defineProperties;var bo=Object.getOwnPropertyDescriptors;var xe=Object.getOwnPropertySymbols;var Nt=Object.prototype.hasOwnProperty,Dt=Object.prototype.propertyIsEnumerable;var Ot=e=>{throw TypeError(e)};var Gt=(e,t,r)=>t in e?go(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,N=(e,t)=>{for(var r in t||(t={}))Nt.call(t,r)&&Gt(e,r,t[r]);if(xe)for(var r of xe(t))Dt.call(t,r)&&Gt(e,r,t[r]);return e},te=(e,t)=>ho(e,bo(t));var Lt=(e,t)=>{var r={};for(var o in e)Nt.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(e!=null&&xe)for(var o of xe(e))t.indexOf(o)<0&&Dt.call(e,o)&&(r[o]=e[o]);return r};var So=(e,t,r)=>t.has(e)||Ot("Cannot "+r);var kt=(e,t,r)=>t.has(e)?Ot("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r);var re=(e,t,r)=>(So(e,t,"access private method"),r);var F={TRACE:-1,DEBUG:0,INFO:1,WARN:2,ERROR:3};function yo(){let e=F.INFO;try{let r=new URLSearchParams(window.location.search).get("debug");r==="trace"?e=F.TRACE:r==="true"?e=F.DEBUG:r==="false"&&(e=F.INFO)}catch(t){console.warn("Failed to parse URL parameters for debug mode:",t)}return e}var z=yo(),n={trace(...e){z<=F.TRACE&&console.log("%c[TRACE]","color: #888888",...e)},debug(...e){z<=F.DEBUG&&console.log("[DEBUG]",...e)},info(...e){z<=F.INFO&&console.log("[INFO]",...e)},warn(...e){z<=F.WARN&&console.warn("[WARN]",...e)},error(...e){z<=F.ERROR&&console.error("[ERROR]",...e)},isTraceEnabled(){return z<=F.TRACE},isDebugEnabled(){return z<=F.DEBUG},getLogLevel(){return z}};function Ut(e,t){console.log("%cCustomized Gradebook Loaded","color:#4CAF50; font-weight:bold;"),console.log(`Environment: ${e}`),console.log(`Build Version: ${t}`),n.isTraceEnabled()?console.log("%cTrace logging: ENABLED (very verbose)","color:#888888; font-weight:bold;"):n.isDebugEnabled()?console.log("%cDebug logging: ENABLED","color:#FF9800; font-weight:bold;"):console.log("Debug logging: disabled")}function Ft(e,t){window.CG={env:e,version:t,traceEnabled:n.isTraceEnabled(),debugEnabled:n.isDebugEnabled(),logLevel:z}}function Mt(e,t){let r=document.querySelector(e);if(r){let o=getComputedStyle(r);return t.style.fontSize=o.fontSize,t.style.fontFamily=o.fontFamily,t.style.fontWeight=o.fontWeight,!0}return!1}function he(e,t){let r;return function(...o){clearTimeout(r),r=setTimeout(()=>e.apply(this,o),t)}}var Eo="#0c7d9d";function Pt({label:e,id:t=null,onClick:r=null,type:o="primary",tooltip:s=null}){let a=document.createElement("button");a.textContent=e,t&&(a.id=t),s&&(a.title=s),Mt(".css-1f65ace-view-link",a)||(a.style.fontSize="14px",a.style.fontFamily="inherit",a.style.fontWeight="600"),a.style.marginLeft="1rem",a.style.padding="0.5rem 1rem",a.style.border="none",a.style.borderRadius="5px",a.style.cursor="pointer",a.style.transition="background 0.3s, color 0.3s";let c=getComputedStyle(document.documentElement),l=c.getPropertyValue("--ic-brand-button--primary-bgd").trim()||Eo,d=c.getPropertyValue("--ic-brand-button--primary-text").trim()||"#ffffff",u=c.getPropertyValue("--ic-brand-button--secondary-bgd").trim()||"#e0e0e0",f=c.getPropertyValue("--ic-brand-button--secondary-text").trim()||"#ffffff";return o==="primary"?(a.style.background=l,a.style.color=d):o==="secondary"&&(a.style.background=u,a.style.color=f,a.style.border="1px solid #ccc"),r&&a.addEventListener("click",r),a}function Bt(){let e=document.createElement("div");return e.style.display="flex",e.style.flexDirection="row",e.style.gap="0.01rem",e.style.marginLeft="1rem",e}var Vt,qt,wr=(qt=(Vt=window.CG_CONFIG)==null?void 0:Vt.ENABLE_STUDENT_GRADE_CUSTOMIZATION)!=null?qt:!0,zt,Ht,Ar=(Ht=(zt=window.CG_CONFIG)==null?void 0:zt.REMOVE_ASSIGNMENT_TAB)!=null?Ht:!1,jt,Yt,$r=(Yt=(jt=window.CG_CONFIG)==null?void 0:jt.PER_STUDENT_UPDATE_THRESHOLD)!=null?Yt:25,Kt,Wt,_r=(Wt=(Kt=window.CG_CONFIG)==null?void 0:Kt.MASTERY_REFRESH_ENABLED)!=null?Wt:!0,Jt,Xt,v=(Xt=(Jt=window.CG_CONFIG)==null?void 0:Jt.ENABLE_OUTCOME_UPDATES)!=null?Xt:!0,Qt,Zt,I=(Zt=(Qt=window.CG_CONFIG)==null?void 0:Qt.ENABLE_GRADE_OVERRIDE)!=null?Zt:!0,Co=e=>Number((e*25).toFixed(2)),er,tr,M=(tr=(er=window.CG_CONFIG)==null?void 0:er.OVERRIDE_SCALE)!=null?tr:Co,rr,nr,je=(nr=(rr=window.CG_CONFIG)==null?void 0:rr.UPDATE_AVG_BUTTON_LABEL)!=null?nr:"Update Current Score",or,sr,R=(sr=(or=window.CG_CONFIG)==null?void 0:or.AVG_OUTCOME_NAME)!=null?sr:"Current Score",ar,ir,_=(ir=(ar=window.CG_CONFIG)==null?void 0:ar.AVG_ASSIGNMENT_NAME)!=null?ir:"Current Score Assignment",cr,lr,se=(lr=(cr=window.CG_CONFIG)==null?void 0:cr.AVG_RUBRIC_NAME)!=null?lr:"Current Score Rubric",dr,ur,H=(ur=(dr=window.CG_CONFIG)==null?void 0:dr.DEFAULT_MAX_POINTS)!=null?ur:4,pr,mr,Te=(mr=(pr=window.CG_CONFIG)==null?void 0:pr.DEFAULT_MASTERY_THRESHOLD)!=null?mr:3,wo=[{description:"Exemplary",points:4},{description:"Beyond Target",points:3.5},{description:"Target",points:3},{description:"Approaching Target",points:2.5},{description:"Developing",points:2},{description:"Beginning",points:1.5},{description:"Needs Partial Support",points:1},{description:"Needs Full Support",points:.5},{description:"No Evidence",points:0}],fr,gr,W=(gr=(fr=window.CG_CONFIG)==null?void 0:fr.OUTCOME_AND_RUBRIC_RATINGS)!=null?gr:wo,Ao=[],hr,br,xr=(br=(hr=window.CG_CONFIG)==null?void 0:hr.EXCLUDED_OUTCOME_KEYWORDS)!=null?br:Ao,$o=["Standards Based","SBG","Mastery",/\[SBG\]/i,/^SBG[-\s]/i],Sr,yr,Tr=(yr=(Sr=window.CG_CONFIG)==null?void 0:Sr.STANDARDS_BASED_COURSE_PATTERNS)!=null?yr:$o,Er,Cr,vr=(Cr=(Er=window.CG_CONFIG)==null?void 0:Er.MASTERY_REFRESH_DELAY_MS)!=null?Cr:5e3;function Ye(e){let t=e.match(/^\/courses\/(\d+)\b/);return t?t[1]:null}function x(){let e=ENV==null?void 0:ENV.COURSE_ID,t=Ye(window.location.pathname),r=e||t;return r||(n.error("Course ID not found on page."),null)}function j(){let e=ENV!=null&&ENV.current_user_id?String(ENV.current_user_id):"unknown_user",t=`roleGroup_${e}`,r=`roleGroup_debug_${e}`,o=sessionStorage.getItem(t);if(o)return o;let s=new Set;Array.isArray(ENV==null?void 0:ENV.current_user_roles)&&ENV.current_user_roles.forEach(d=>s.add(String(d))),Array.isArray(ENV==null?void 0:ENV.current_user_types)&&ENV.current_user_types.forEach(d=>s.add(String(d))),ENV!=null&&ENV.current_user_is_admin&&s.add("admin"),ENV!=null&&ENV.current_user_is_student&&s.add("student"),ENV!=null&&ENV.current_user_is_teacher&&s.add("teacher"),ENV!=null&&ENV.current_user_is_observer&&s.add("observer");let a=Array.from(s).map(d=>d.toLowerCase());n.debug("[role debug] userId:",e),n.debug("[role debug] normalized roles:",a);let i=["teacher","admin","root_admin","designer","ta","accountadmin"],c=["student","observer"],l="other";return a.some(d=>c.includes(d))?l="student_like":a.some(d=>i.includes(d))&&(l="teacher_like"),sessionStorage.setItem(t,l),sessionStorage.setItem(r,JSON.stringify({userId:e,normRoles:a,decided:l})),l}var J=class extends Error{constructor(t,r,o){super(t),this.name="CanvasApiError",this.statusCode=r,this.responseText=o}},P=class extends Error{constructor(t="User cancelled the operation"){super(t),this.name="UserCancelledError"}},X=class extends Error{constructor(t,r){super(t),this.name="TimeoutError",this.timeoutMs=r}},ae=class extends Error{constructor(t,r){super(t),this.name="ValidationError",this.field=r}};function Ke(e,t,r={}){let o=new Date().toISOString(),s=N({timestamp:o,context:t,name:e.name,message:e.message},r);n.error(`[${t}] ${e.name}: ${e.message}`,s),n.isDebugEnabled()&&e.stack&&n.error("Stack trace:",e.stack),e instanceof J?(n.error(`  Status: ${e.statusCode}`),n.isDebugEnabled()&&e.responseText&&n.error(`  Response: ${e.responseText}`)):e instanceof X?n.error(`  Timeout: ${e.timeoutMs}ms`):e instanceof ae&&e.field&&n.error(`  Field: ${e.field}`)}function We(e){if(e instanceof P)return e.message||"Operation cancelled.";if(e instanceof X)return"The operation took too long and timed out. Please try again.";if(e instanceof ae)return e.message;if(e instanceof J)return e.statusCode===401||e.statusCode===403?"You don't have permission to perform this action.":e.statusCode===404?"The requested resource was not found.":e.statusCode>=500?"Canvas server error. Please try again later.":`Canvas API error: ${e.message}`;let t=e.message||"An unknown error occurred";return["fetch","JSON","undefined","null","parse","response"].some(s=>t.toLowerCase().includes(s.toLowerCase()))?"An unexpected error occurred. Please try again or contact support.":t}function ve(e,t,r={}){let{showAlert:o=!1,banner:s=null,metadata:a={}}=r;Ke(e,t,a);let i=We(e);return s&&typeof s.setText=="function"&&s.setText(i),o&&!(e instanceof P)&&alert(i),i}async function Ir(e,t={},r="fetch"){try{let o=await fetch(e,t);if(!o.ok){let s=await o.text();throw new J(`HTTP ${o.status}: ${o.statusText}`,o.status,s)}return o}catch(o){throw o instanceof J?o:new J(`Network error: ${o.message}`,0,null)}}async function Rr(e,t="parseJSON"){let r=await e.text();try{return JSON.parse(r)}catch(o){throw n.isDebugEnabled()&&n.error(`[${t}] Failed to parse JSON:`,r),new J("Invalid JSON response from Canvas API",e.status,r)}}var g={IDLE:"IDLE",CHECKING_SETUP:"CHECKING_SETUP",CREATING_OUTCOME:"CREATING_OUTCOME",CREATING_ASSIGNMENT:"CREATING_ASSIGNMENT",CREATING_RUBRIC:"CREATING_RUBRIC",CALCULATING:"CALCULATING",UPDATING_GRADES:"UPDATING_GRADES",POLLING_PROGRESS:"POLLING_PROGRESS",VERIFYING:"VERIFYING",VERIFYING_OVERRIDES:"VERIFYING_OVERRIDES",COMPLETE:"COMPLETE",ERROR:"ERROR"},Gr={[g.IDLE]:[g.CHECKING_SETUP],[g.CHECKING_SETUP]:[g.CREATING_OUTCOME,g.CREATING_ASSIGNMENT,g.CREATING_RUBRIC,g.CALCULATING,g.ERROR],[g.CREATING_OUTCOME]:[g.CHECKING_SETUP,g.ERROR],[g.CREATING_ASSIGNMENT]:[g.CHECKING_SETUP,g.ERROR],[g.CREATING_RUBRIC]:[g.CHECKING_SETUP,g.ERROR],[g.CALCULATING]:[g.UPDATING_GRADES,g.COMPLETE,g.ERROR],[g.UPDATING_GRADES]:[g.POLLING_PROGRESS,g.VERIFYING,g.ERROR],[g.POLLING_PROGRESS]:[g.POLLING_PROGRESS,g.VERIFYING,g.ERROR],[g.VERIFYING]:[g.VERIFYING,g.VERIFYING_OVERRIDES,g.ERROR],[g.VERIFYING_OVERRIDES]:[g.VERIFYING_OVERRIDES,g.COMPLETE,g.ERROR],[g.COMPLETE]:[g.IDLE],[g.ERROR]:[g.IDLE]},Ie=class{constructor(t=g.IDLE,r={}){this.currentState=t,this.context=N({courseId:null,outcomeId:null,assignmentId:null,rubricId:null,rubricCriterionId:null,rollupData:null,averages:null,progressId:null,startTime:null,numberOfUpdates:0,banner:null,error:null,retryCount:0,updateMode:null},r),this.eventListeners={},this.stateHistory=[t]}getCurrentState(){return this.currentState}getContext(){return N({},this.context)}updateContext(t){this.context=N(N({},this.context),t)}canTransition(t){return(Gr[this.currentState]||[]).includes(t)}transition(t,r={}){var s;if(!this.canTransition(t))throw new Error(`Invalid transition from ${this.currentState} to ${t}. Valid transitions: ${((s=Gr[this.currentState])==null?void 0:s.join(", "))||"none"}`);let o=this.currentState;this.currentState=t,this.stateHistory.push(t),this.updateContext(r),n.debug(`State transition: ${o} \u2192 ${t}`),this.emit("stateChange",{from:o,to:t,context:this.getContext()})}on(t,r){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(r)}emit(t,r){(this.eventListeners[t]||[]).forEach(s=>{try{s(r)}catch(a){n.error(`Error in event listener for ${t}:`,a)}})}getStateHistory(){return[...this.stateHistory]}reset(){this.currentState=g.IDLE,this.context={courseId:this.context.courseId,outcomeId:null,assignmentId:null,rubricId:null,rubricCriterionId:null,rollupData:null,averages:null,progressId:null,startTime:null,numberOfUpdates:0,banner:null,error:null,retryCount:0,updateMode:null},this.stateHistory=[g.IDLE],n.debug("State machine reset to IDLE"),this.emit("reset",{})}};var B,Nr,ie,C=class{constructor(){kt(this,B);if(this.csrfToken=re(this,B,Nr).call(this,"_csrf_token"),!this.csrfToken)throw new Error("CSRF token not found - user may not be authenticated");n.debug("CanvasApiClient initialized with cached CSRF token")}async get(t,r={},o="get"){if(!t.includes("per_page=")){let s=t.includes("?")?"&":"?";t=`${t}${s}per_page=100`}return re(this,B,ie).call(this,t,"GET",null,r,o)}async post(t,r,o={},s="post"){return re(this,B,ie).call(this,t,"POST",r,o,s)}async put(t,r,o={},s="put"){return re(this,B,ie).call(this,t,"PUT",r,o,s)}async delete(t,r={},o="delete"){return re(this,B,ie).call(this,t,"DELETE",null,r,o)}async graphql(t,r={},o="graphql"){let s="/api/graphql",a={query:t,variables:r},i={headers:{"Content-Type":"application/json"}};return re(this,B,ie).call(this,s,"POST",a,i,o)}};B=new WeakSet,Nr=function(t){let r=document.cookie.split(";").map(o=>o.trim());for(let o of r){let[s,a]=o.split("=",2);if(s===t)return decodeURIComponent(a)}return null},ie=async function(t,r,o,s={},a="request"){let i=te(N({"Content-Type":"application/json"},s.headers),{"X-CSRF-Token":this.csrfToken}),c=null;o&&((i["Content-Type"]||"application/json").includes("application/json")?(o.authenticity_token||(o=te(N({},o),{authenticity_token:this.csrfToken})),c=JSON.stringify(o)):c=o);let f=s,{headers:l}=f,d=Lt(f,["headers"]),u=await Ir(t,N({method:r,credentials:"same-origin",headers:i,body:c},d),a);return await Rr(u,a)};async function Dr(e,t){if(!I)return n.debug("Grade override is disabled in config, skipping"),!1;try{return n.debug("Enabling final grade override for course"),await t.put(`/api/v1/courses/${e}/settings`,{allow_final_grade_override:!0},{},"enableCourseOverride"),n.info("Final grade override enabled for course"),!0}catch(r){throw n.error("Failed to enable final grade override:",r),r}}async function Je(e,t){var r;if(!I)return n.debug("Grade override is disabled in config, skipping fetch"),new Map;try{let o=await t.get(`/courses/${e}/gradebook/final_grade_overrides`,{},"fetchOverrideGrades"),s=new Map,a=o.final_grade_overrides||{};for(let[i,c]of Object.entries(a)){let l=(r=c==null?void 0:c.course_grade)==null?void 0:r.percentage;l!=null&&(s.set(i,l),n.trace(`Override grade for user ${i}: ${l}%`))}return n.debug(`Fetched ${s.size} override grades from Canvas API`),s}catch(o){throw n.error("Failed to fetch override grades:",o),o}}async function Or(e,t,r,o,s=.01){if(!I)return n.debug("Grade override is disabled in config, skipping verification"),[];try{let a=await Je(e,o),i=[],c=0;n.debug(`Verifying ${t.length} students' override grades...`);for(let{userId:l,average:d}of t){let u=M(d),f=a.get(String(l)),p=r.get(String(l));if(n.trace(`User ${l}: expected=${u}%, actual=${f}%`),f==null){i.push({userId:l,enrollmentId:p,expected:u,actual:null,reason:"No override grade found"}),n.trace(`  \u274C No override grade found for user ${l}`);continue}let m=Math.abs(f-u);m>s?(i.push({userId:l,enrollmentId:p,expected:u,actual:f,diff:m}),n.trace(`  \u274C Mismatch: expected ${u}%, got ${f}% (diff: ${m.toFixed(2)}%)`)):(c++,n.trace(`  \u2713 Match: ${f}%`))}return n.debug(`Override verification complete: ${c} matches, ${i.length} mismatches`),i.length>0&&n.debug("Mismatches found:",i.map(l=>({userId:l.userId,expected:l.expected,actual:l.actual,diff:l.diff}))),i}catch(a){throw n.error("Failed to verify override scores:",a),a}}function _o(e){var r,o;let t={};return((o=(r=e==null?void 0:e.linked)==null?void 0:r.outcomes)!=null?o:[]).forEach(s=>{t[String(s.id)]=s.title}),t}function xo(e,t){var o;let r=e.find(s=>{var a;return String((a=s.links)==null?void 0:a.outcome)===String(t)});return(o=r==null?void 0:r.score)!=null?o:null}function To(e,t,r,o){return e.filter(s=>{var c;let a=String((c=s.links)==null?void 0:c.outcome),i=(t[a]||"").toLowerCase();return typeof s.score=="number"&&!r.has(a)&&!o.some(l=>i.includes(l.toLowerCase()))})}function vo(e){let t=e.reduce((r,o)=>r+o.score,0);return Number((t/e.length).toFixed(2))}function Io(e,t){return e!==t}function Ro(e,t,r,o){if(!r||r.size===0)return!1;let s=o(t),a=r.get(String(e));return a==null?!0:Math.abs(a-s)>.01}function Go(e,t,r,o,s,a,i,c){let l=t.reduce((d,u)=>d+u.score,0);if(n.trace(`User ${e}: total=${l}, count=${t.length}, average=${o}`),n.trace(`  Old average: ${r}, New average: ${o}`),I&&i.size>0){let d=c(o),u=i.get(String(e));u==null?n.trace(`  Override: missing (expected ${d}%) - needs update`):Math.abs(u-d)>.01?n.trace(`  Override: mismatch (expected ${d}%, got ${u}%) - needs update`):n.trace(`  Override: matches (${u}%)`)}s||a?s&&a?n.trace(`  \u2713 Including user ${e}: both outcome and override need updates`):s?n.trace(`  \u2713 Including user ${e}: outcome needs update`):n.trace(`  \u2713 Including user ${e}: override needs update`):n.trace(`  \u2717 Skipping user ${e}: no updates needed`)}async function Lr(e,t,r,o){var l,d,u,f;n.info("Calculating student averages..."),n.debug(`Grading mode: ENABLE_OUTCOME_UPDATES=${v}, ENABLE_GRADE_OVERRIDE=${I}`);let s=_o(e),a=new Set([String(t)]),i=new Map;if(I&&r&&o)try{n.debug("Fetching current override grades for initial check..."),i=await Je(r,o),n.debug(`Fetched ${i.size} override grades for comparison`)}catch(p){n.warn("Failed to fetch override grades for initial check, continuing without override checking:",p)}let c=[];for(let p of(l=e==null?void 0:e.rollups)!=null?l:[]){let m=(d=p.links)==null?void 0:d.user;if(!m)continue;let h=xo((u=p.scores)!=null?u:[],t),y=To((f=p.scores)!=null?f:[],s,a,xr);if(y.length===0)continue;let E=vo(y),w=v&&Io(h,E),b=I&&Ro(m,E,i,M);Go(m,y,h,E,w,b,i,M),(w||b)&&c.push({userId:m,average:E})}return n.debug(`Calculation complete: ${c.length} students need updates`),v&&I&&i.size>0?n.debug("  (checked both outcome scores and override grades)"):v?n.debug("  (checked outcome scores only)"):I&&n.debug("  (checked override grades only)"),c}function Y(e,t=Date.now()){if(!e)return 0;let r=e.getContext();if(!r.startTime)return 0;let o=new Date(r.startTime).getTime(),s=t instanceof Date?t.getTime():new Date(t).getTime();return Math.floor((s-o)/1e3)}function Re(e,t){if(!e||!t)return;let r=t.querySelector(".floating-banner__text")||t;Xe(t);let o=/\(Elapsed time:\s*\d+s\)/,s=()=>{let a=Y(e),i=r.textContent||"";o.test(i)?r.textContent=i.replace(o,`(Elapsed time: ${a}s)`):r.textContent=i.trim().length?`${i} (Elapsed time: ${a}s)`:`(Elapsed time: ${a}s)`};s(),t._elapsedTimerId=setInterval(s,1e3)}function Xe(e){e&&e._elapsedTimerId&&(clearInterval(e._elapsedTimerId),delete e._elapsedTimerId)}function Ge(e,t){let r=e.querySelector("#avg-last-update");r||(r=document.createElement("div"),r.id="avg-last-update",r.style.fontSize="12px",r.style.marginTop="4px",r.style.opacity="0.8",e.appendChild(r));let o=localStorage.getItem(`lastUpdateAt_${t}`),s=parseInt(localStorage.getItem(`duration_${t}`),10),a=i=>Number.isFinite(i)?`${Math.floor(i/60)}m ${i%60}s`:"N/A";r.textContent=o?`Last update: ${new Date(o).toLocaleString()} | Duration: ${a(s)}`:"Last update: none yet"}var Qe=new Map;async function Ne(e,t,r){var a,i,c,l,d;let s=await r.graphql(`
    mutation SetOverride($enrollmentId: ID!, $overrideScore: Float!) {
      setOverrideScore(input: { enrollmentId: $enrollmentId, overrideScore: $overrideScore }) {
        grades { customGradeStatusId overrideScore __typename }
        __typename
      }
    }`,{enrollmentId:String(e),overrideScore:Number(t)},"setOverrideScoreGQL");if(s.errors){let u=new Error(`GQL error: ${JSON.stringify(s.errors)}`);throw Ke(u,"setOverrideScoreGQL",{enrollmentId:e,overrideScore:t}),u}return(d=(l=(c=(i=(a=s.data)==null?void 0:a.setOverrideScore)==null?void 0:i.grades)==null?void 0:c[0])==null?void 0:l.overrideScore)!=null?d:null}async function Ze(e,t){let r=String(e);if(Qe.has(r))return Qe.get(r);let o=new Map,s=`/api/v1/courses/${r}/enrollments?type[]=StudentEnrollment&per_page=100`;for(;s;){let a=await t.get(s,{},"getAllEnrollmentIds");for(let i of a)i!=null&&i.user_id&&(i!=null&&i.id)&&o.set(String(i.user_id),String(i.id));s=null}return Qe.set(r,o),o}async function De(e,t,r){return(await Ze(e,r)).get(String(t))||null}async function No(e,t,r,o,s,a){if(!v){n.trace(`Outcome updates disabled, skipping rubric score submission for user ${r}`);return}let i=new Date().toLocaleString();n.trace("Submitting rubric score for student",r);let c={rubric_assessment:{[o.toString()]:{points:s}},submission:{posted_grade:s.toString(),score:s},comment:{text_comment:"Score: "+s+"  Updated: "+i}};n.trace("Submitting rubric score for student",r,c),await a.put(`/api/v1/courses/${e}/assignments/${t}/submissions/${r}`,c,{},`submitRubricScore:${r}`),n.trace("Score submitted successfully for user",r)}async function kr(e,t,r,o,s){if(!v)return n.debug("Outcome updates disabled, skipping bulk update"),"SKIPPED_NO_OUTCOME_UPDATES";let a=new Date().toLocaleString(),i={};n.debug("averages:",o);for(let{userId:d,average:u}of o)n.trace("userId:",d,"score:",u),i[d]={posted_grade:u,text_comment:"Score: "+u+"  Updated: "+a,rubric_assessment:{[r.toString()]:{points:u}}};n.debug("bulk gradeData payload:",i);let l=(await s.post(`/api/v1/courses/${e}/assignments/${t}/submissions/update_grades`,{grade_data:i},{},"beginBulkUpdate")).id;return localStorage.setItem(`progressId_${x()}`,l),n.info("Waiting for grading to complete progress ID:",l),l}async function Ur(e,t,r,o=12e5,s=2e3){let a=Date.now(),i="beginning upload",c=x(),l=localStorage.getItem(`progressId_${c}`);for(Re(r,e);Date.now()-a<o;){let d=await t.get(`/api/v1/progress/${l}`,{},"waitForBulkGrading"),u=Y(r);switch(i=d.workflow_state,n.debug(`Bulk Uploading Status: ${i} (elapsed: ${u}s)`),i!=="completed"&&e.soft(`Bulk uploading status: ${i.toUpperCase()}. (Elapsed time: ${u}s)`),i){case"queued":break;case"running":break;case"failed":throw n.error("Bulk update job failed."),new Error("Bulk update failed.");case"completed":n.info("Bulk upload completed: "+d.updated_at);return;default:break}await new Promise(f=>setTimeout(f,s))}throw new X("Bulk update is taking longer than expected. In a few minutes try updating again. If there are no changes to be made the update completed",o)}async function Fr(e,t,r,o,s,a,i=!1){let l=e.length;n.debug(`Per-student grading mode: ENABLE_OUTCOME_UPDATES=${v}, ENABLE_GRADE_OVERRIDE=${I}`);let d=v&&I?`Updating "${R}" and grade overrides for ${l} students...`:v?`Updating "${R}" scores for ${l} students...`:`Updating grade overrides for ${l} students...`;s.setText(d);let u=[],f={},p=new Set;async function m(b,A=3){let{userId:$,average:oe}=b,K=null;for(let L=1;L<=A;L++)try{if(await No(t,r,$,o,oe,a),I)try{let T=await De(t,$,a);if(T){let $e=M(oe);await Ne(T,$e,a),n.debug(`[override] user ${$} \u2192 enrollment ${T}: ${$e}`)}else n.warn(`[override] no enrollmentId for user ${$}`)}catch(T){n.warn(`[override] failed for user ${$}:`,(T==null?void 0:T.message)||T)}return f[$]=L,L>1&&p.add($),!0}catch(T){K=T,L===1?f[$]=1:f[$]++,n.warn(`Attempt ${L} failed for student ${$}:`,T.message)}return K}let h=[];for(let b=0;b<l;b++){let A=e[b],$=await m(A,3);$!==!0&&h.push(te(N({},A),{error:$.message})),(b%1===0||b===l-1)&&s.setText(`Updating "${R}"  ${b+1} of ${l} students processed`)}n.info(`Retrying ${h.length} students...`);for(let b of h){let A=await m(b,3);A!==!0&&u.push({userId:b.userId,average:b.average,error:A.message})}let y=p.size,E=Object.entries(f).filter(([b,A])=>A>1).map(([b,A])=>({userId:b,attempts:A}));n.info(`${y} students needed more than one attempt.`),console.table(E);let w=!1;return i&&(w=!0),u.length>0&&n.warn("Scores of the following students failed to update:",u),(u.length>0||E.length>0)&&!i&&(w=confirm(`Export grade update attempt counts and failure logs to a file? 


           Note: Your browser settings or extensions may block automatic file downloads.

           If nothing downloads, please check your pop-up or download permissions.`)),w&&Do(E,u),Y()}function Do(e,t){let r=`Unless marked "UPDATE FAILED", the students score was successfully updated but took multiple attempts.
`,o=`User ID,Average Score,Attempts,Status,Error
`,s=Object.fromEntries(t.map(p=>[p.userId,p])),a=new Set([...e.map(p=>p.userId),...Object.keys(s)]),i=Object.fromEntries(e.map(p=>[p.userId,p.attempts])),c=Array.from(a).map(p=>{var b,A;let m=(b=i[p])!=null?b:"",h=s[p],y=(A=h==null?void 0:h.average)!=null?A:"",E=h?"UPDATE FAILED":"",w=h!=null&&h.error?`"${h.error.replace(/"/g,'""')}"`:"";return`${p},${y},${m},${E},${w}`}),l=r+o+c.join(`
`),d=new Blob([l],{type:"text/csv"}),u=URL.createObjectURL(d),f=document.createElement("a");f.href=u,f.download="canvas_upload_error_summary.csv",f.click(),URL.revokeObjectURL(u)}async function Mr(e,t,r,o,s,a,i=5e3,c=50){let l="verifying";for(let d=1;d<=c;d++){let u=Y(a);o.soft(`Status ${l.toUpperCase()}. (Elapsed time: ${u}s)`),Re(a,o);let f=await s.get(`/api/v1/courses/${e}/outcome_rollups?outcome_ids[]=${r}&include[]=outcomes&include[]=users&per_page=100`,{},"verifyUIScores");n.debug("newRollupData: ",f);let p=[];for(let{userId:m,average:h}of t){let y=f.rollups.find(A=>A.links.user.toString()===m.toString());if(!y){p.push({userId:m,reason:"No rollup found."});continue}let E=y.scores[0];if(!E){p.push({userId:m,reason:"No score found."});continue}let w=E.score;Math.abs(w-h)<.001||p.push({userId:m,expected:h,actual:w})}if(p.length===0){n.info("All averages match backend scores."),localStorage.setItem(`lastUpdateAt_${x()}`,new Date().toISOString());let m=Y(a);localStorage.setItem(`duration_${x()}`,m);return}else n.warn("Mismatches found:",p),n.info(`Waiting ${i/1e3} seconds before retrying...`),await new Promise(m=>setTimeout(m,i))}}async function Pr(e,t){let r=await t.get(`/api/v1/courses/${e}/outcome_rollups?include[]=outcomes&include[]=users&per_page=100`,{},"getRollup");return n.debug("rollupData: ",r),r}function et(e){var s,a;let t=R;n.debug("Outcome Title:",t),n.debug("data:",e);let r=(a=(s=e==null?void 0:e.linked)==null?void 0:s.outcomes)!=null?a:[];if(n.debug("outcomes: ",r),r.length===0)return n.warn("No outcomes found in rollup data."),null;let o=r.find(i=>i.title===t);return n.debug("match: ",o),o||n.warn(`Outcome not found: "${t}"`),o!=null?o:null}async function Br(e,t){let o=`MOREnet_${Math.random().toString(36).substring(2,10)}`,s=W.map(p=>`${p.points},"${p.description}"`).join(","),a=`vendor_guid,object_type,title,description,calculation_method,mastery_points
"${o}",outcome,"${R}","Auto-generated outcome: ${R}",latest,"${Te}",${s}`;n.debug("Importing outcome via CSV...");let c=(await t.post(`/api/v1/courses/${e}/outcome_imports?import_type=instructure_csv`,a,{headers:{"Content-Type":"text/csv"}},"createOutcome")).id;n.debug(`Outcome import started: ID ${c}`);let l=0,d=null,u=15,f=2e3;for(;l++<u;){await new Promise(h=>setTimeout(h,f));let p=await t.get(`/api/v1/courses/${e}/outcome_imports/${c}`,{},"createOutcome:poll"),m=p.workflow_state;if(n.debug(`Poll attempt ${l}: ${m}`),m==="succeeded"){d=p;break}else if(m==="failed")throw new Error("Outcome import failed")}if(!d)throw new X("Timed out waiting for outcome import to complete",u*f);n.debug("Outcome fully created")}async function Vr(e,t,r){var s;let o=(s=t.alignments)!=null?s:[];for(let a of o){if(!a.startsWith("assignment_"))continue;let i=a.split("_")[1];try{let c=await r.get(`/api/v1/courses/${e}/assignments/${i}`,{},"getAssignment");if(c.name===_)return n.debug("Assignment found:",c),c}catch(c){n.debug(`Assignment ${i} not accessible:`,c.message);continue}}return n.warn(`Assignment "${_}" not found in alignments`),null}async function qr(e,t){let r={assignment:{name:_,position:1,submission_types:["none"],published:!0,notify_of_update:!0,points_possible:H,grading_type:"gpa_scale",omit_from_final_grade:!0}},o=await t.post(`/api/v1/courses/${e}/assignments`,r,{},"createAssignment");return n.info("Assignment created:",o.name),o.id}async function zr(e,t,r){let o=await r.get(`/api/v1/courses/${e}/assignments/${t}`,{},"getRubric"),s=o.rubric_settings;if(!s||s.title!==se)return null;let a=o.rubric;if(!a||!Array.isArray(a)||a.length===0)return null;let i=a[0].id,c=s.id;return n.debug("Found rubric and first criterion ID:",{rubricId:c,criterionId:i}),{rubricId:c,criterionId:i}}async function Hr(e,t,r,o){let s={};W.forEach((c,l)=>{s[l]={description:c.description,points:c.points}});let a={rubric:{title:se,free_form_criterion_comments:!1,criteria:{0:{description:`${R} criteria was used to create this rubric`,criterion_use_range:!1,points:H,mastery_points:Te,learning_outcome_id:r,ratings:s}}},rubric_association:{association_type:"Assignment",association_id:t,use_for_grading:!0,purpose:"grading",hide_points:!0}},i=await o.post(`/api/v1/courses/${e}/rubrics`,a,{},"createRubric");return n.debug("Rubric created and linked to outcome:",i),i.id}async function Oo(e){let{courseId:t,banner:r}=e.getContext(),o=new C,s=v?`Checking setup for "${R}"...`:"Checking setup for grade overrides...";r.setText(s),n.debug(`Grading mode: ENABLE_OUTCOME_UPDATES=${v}, ENABLE_GRADE_OVERRIDE=${I}`);let a=await Pr(t,o);if(e.updateContext({rollupData:a}),v){let i=et(a),c=i==null?void 0:i.id;if(!c){if(!confirm(`Outcome "${R}" not found.
Would you like to create it?`))throw new P("User declined to create missing outcome.");return g.CREATING_OUTCOME}e.updateContext({outcomeId:c});let l=await Vr(t,i,o);l||(l=(await o.get(`/api/v1/courses/${t}/assignments?search_term=${encodeURIComponent(_)}`,{},"getAssignment:fallback")).find(h=>h.name===_),l&&n.debug("Fallback assignment found by name:",l));let d=l==null?void 0:l.id;if(!d){if(!confirm(`Assignment "${_}" not found.
Would you like to create it?`))throw new P("User declined to create missing assignment.");return g.CREATING_ASSIGNMENT}e.updateContext({assignmentId:d});let u=await zr(t,d,o),f=u==null?void 0:u.rubricId,p=u==null?void 0:u.criterionId;if(!f){if(!confirm(`Rubric "${se}" not found.
Would you like to create it?`))throw new P("User declined to create missing rubric.");return g.CREATING_RUBRIC}e.updateContext({rubricId:f,rubricCriterionId:p})}else{n.debug("Outcome updates disabled, skipping outcome/assignment/rubric checks");let i=et(a),c=i==null?void 0:i.id;c?(e.updateContext({outcomeId:c}),n.debug(`Found outcomeId ${c} for exclusion from average calculation`)):n.debug("No outcome found - will calculate averages without excluding any outcome")}if(I)try{await Dr(t,o)}catch(i){n.warn("Failed to enable course override, continuing anyway:",i)}return g.CALCULATING}async function Lo(e){let{courseId:t,banner:r}=e.getContext(),o=new C;return r.setText(`Creating "${R}" Outcome...`),await Br(t,o),g.CHECKING_SETUP}async function ko(e){let{courseId:t,banner:r}=e.getContext(),o=new C;r.setText(`Creating "${_}" Assignment...`);let s=await qr(t,o);return e.updateContext({assignmentId:s}),g.CHECKING_SETUP}async function Uo(e){let{courseId:t,assignmentId:r,outcomeId:o,banner:s}=e.getContext(),a=new C;s.setText(`Creating "${se}" Rubric...`);let i=await Hr(t,r,o,a);return e.updateContext({rubricId:i}),g.CHECKING_SETUP}async function Fo(e){let{rollupData:t,outcomeId:r,courseId:o,banner:s}=e.getContext(),a=new C,i=v?`Calculating "${R}" scores...`:"Calculating student averages for grade overrides...";s.setText(i);let c=await Lr(t,r,o,a),l=c.length;return e.updateContext({averages:c,numberOfUpdates:l,startTime:new Date().toISOString()}),l===0?(e.updateContext({zeroUpdates:!0}),g.COMPLETE):g.UPDATING_GRADES}async function Mo(e){let{averages:t,courseId:r,assignmentId:o,rubricCriterionId:s,numberOfUpdates:a,banner:i}=e.getContext(),c=new C;if(!v)return n.debug("Outcome updates disabled, skipping UPDATING_GRADES state"),g.VERIFYING;let l=a<$r,d=l?"per-student":"bulk";if(e.updateContext({updateMode:d}),l){let u=`Detected ${a} changes - updating scores one at a time for quicker processing.`;return i.hold(u,3e3),n.debug("Per student update..."),await Fr(t,r,o,s,i,c,!1),n.debug("handleUpdatingGrades complete, transitioning to VERIFYING"),g.VERIFYING}else{let u=`Detected ${a} changes - using bulk update`;i.hold(u,3e3),n.debug(`Bulk update, detected ${a} changes`);let f=await kr(r,o,s,t,c);return e.updateContext({progressId:f}),n.debug(`progressId: ${f}`),n.debug("handleUpdatingGrades complete, transitioning to POLLING_PROGRESS"),g.POLLING_PROGRESS}}async function Po(e){let{banner:t}=e.getContext(),r=new C;return n.debug("Starting bulk update polling..."),await Ur(t,r,e),n.debug("handlePollingProgress complete, transitioning to VERIFYING"),g.VERIFYING}async function Bo(e){let{courseId:t,averages:r,outcomeId:o,banner:s}=e.getContext(),a=new C;return v?(n.debug("Starting outcome score verification..."),await Mr(t,r,o,s,a,e),n.debug("handleVerifying complete, transitioning to VERIFYING_OVERRIDES"),g.VERIFYING_OVERRIDES):(n.debug("Outcome updates disabled, skipping VERIFYING state"),g.VERIFYING_OVERRIDES)}async function Vo(e){let{courseId:t,averages:r,banner:o}=e.getContext(),s=new C;if(!I)return n.debug("Grade override disabled, skipping VERIFYING_OVERRIDES state"),g.COMPLETE;n.debug("Starting grade override submission and verification..."),o.soft("Submitting grade overrides...");let a=0,i=0;for(let{userId:u,average:f}of r)try{let p=await De(t,u,s);if(!p){n.warn(`[override] No enrollmentId for user ${u}`),i++;continue}let m=M(f);await Ne(p,m,s),n.trace(`[override] user ${u} \u2192 enrollment ${p}: ${m}`),a++}catch(p){n.warn(`[override] Failed for user ${u}:`,(p==null?void 0:p.message)||p),i++}n.info(`Grade override submission complete: ${a} succeeded, ${i} failed`);let c=3,l=2e3,d=[];try{let u=await Ze(t,s);for(let f=1;f<=c;f++){if(o.soft(`Verifying grade overrides... (attempt ${f}/${c})`),n.debug(`Override verification attempt ${f}/${c}...`),d=await Or(t,r,u,s),d.length===0){n.info(`All override scores verified successfully on attempt ${f}`);break}f<c?(n.warn(`Found ${d.length} override score mismatches on attempt ${f}, retrying in ${l/1e3}s...`),await new Promise(p=>setTimeout(p,l))):(n.warn(`Found ${d.length} override score mismatches after ${c} attempts`),n.warn("Final mismatches:",d.map(p=>({userId:p.userId,expected:p.expected,actual:p.actual}))))}}catch(u){n.warn("Override verification failed, continuing anyway:",u)}return n.debug("handleVerifyingOverrides complete, transitioning to COMPLETE"),g.COMPLETE}async function qo(e){let{numberOfUpdates:t,banner:r,courseId:o,zeroUpdates:s}=e.getContext(),a=Y(e);Xe(r);let i=v&&I?`${R} and grade overrides`:v?R:"grade overrides";return s||t===0?(r.setText(`No changes to ${i} found.`),alert(`No changes to ${i} have been found. No updates performed.`),setTimeout(()=>{r.remove()},2e3),g.IDLE):(r.setText(`${t} student ${i} updated successfully! (elapsed time: ${a}s)`),localStorage.setItem(`duration_${o}`,a),localStorage.setItem(`lastUpdateAt_${o}`,new Date().toISOString()),alert(`All ${i} have been updated. (elapsed time: ${a}s)
You may need to refresh the page to see the new scores.`),g.IDLE)}async function zo(e){let{error:t,banner:r}=e.getContext();return n.error("Update ended prematurely:",t),r&&(r.setText(`Update ended prematurely: ${t.message}. You can re-run the update to ensure all scores are correctly set.`),setTimeout(()=>r.remove(),5e3)),g.IDLE}var jr={[g.CHECKING_SETUP]:Oo,[g.CREATING_OUTCOME]:Lo,[g.CREATING_ASSIGNMENT]:ko,[g.CREATING_RUBRIC]:Uo,[g.CALCULATING]:Fo,[g.UPDATING_GRADES]:Mo,[g.POLLING_PROGRESS]:Po,[g.VERIFYING]:Bo,[g.VERIFYING_OVERRIDES]:Vo,[g.COMPLETE]:qo,[g.ERROR]:zo};var Yr=(e,t)=>`${e}_${t}`;var Ho=getComputedStyle(document.documentElement).getPropertyValue("--ic-brand-primary").trim()||"#0c7d9d";function ce({text:e="",duration:t=null,top:r="20px",right:o="20px",center:s=!1,backgroundColor:a=Ho,textColor:i="#ffffff",allowMultiple:c=!1,ariaLive:l="polite"}={}){c||document.querySelectorAll(".floating-banner").forEach(k=>k.remove());let d=document.querySelector(".ic-Layout-contentMain")||document.querySelector(".ic-app-header__menu-list-item__link")||document.body,u=getComputedStyle(d),f=u.fontFamily,p=u.fontSize,m=u.fontWeight,h=document.createElement("div");h.className="floating-banner",h.setAttribute("role","status"),l&&l!=="off"&&h.setAttribute("aria-live",l),Object.assign(h.style,{position:"fixed",top:r,background:a,padding:"10px 20px",borderRadius:"8px",boxShadow:"0 4px 8px rgba(0,0,0,0.2)",zIndex:"9999",fontSize:p,color:i,fontFamily:f,fontWeight:m,display:"inline-flex",alignItems:"center",gap:"12px",maxWidth:"min(90vw, 720px)",lineHeight:"1.35",wordBreak:"break-word"}),s?(h.style.left="50%",h.style.transform="translateX(-50%)"):h.style.right=o;let y=document.createElement("span");y.className="floating-banner__text",h.appendChild(y);let E=document.createElement("button");E.type="button",E.setAttribute("aria-label","Dismiss message"),E.textContent="\xD7",Object.assign(E.style,{cursor:"pointer",fontWeight:"bold",border:"none",background:"transparent",color:"inherit",fontSize:p,lineHeight:"1"}),E.onclick=()=>_e(),h.appendChild(E),document.body.appendChild(h);let w=0,b=null,A=null,$=null,oe=()=>Date.now(),K=()=>oe()<w,L=window.location.pathname.includes("/courses/")?x():null,T=k=>{y.textContent=k,L&&localStorage.setItem(Yr("bannerLast",L),k)},$e=()=>{w=0,b!=null&&(T(b),b=null)};h.setText=k=>{K()?b=k:T(k)},h.hold=(k,It=3e3)=>{let Rt=Date.now();if(Rt<w){b=k;return}w=Rt+It,T(k),A&&clearTimeout(A),A=setTimeout(()=>{w=0,b!=null&&(T(b),b=null)},It)},h.soft=k=>{K()||T(k)};function _e(){A&&clearTimeout(A),$&&clearTimeout($),h.style.transition="opacity 150ms",h.style.opacity="0",setTimeout(()=>h.remove(),160)}return h.removeBanner=_e,t==="hold"?h.hold(e,3e3):h.setText(e),typeof t=="number"&&isFinite(t)&&t>=0&&($=setTimeout(_e,t)),E.onclick=()=>{_e()},t==="hold"?h.hold(e,3e3):h.setText(e),h}function Kr(e){if(!n.isDebugEnabled())return;let t=document.getElementById("state-machine-debug-panel");t||(t=document.createElement("div"),t.id="state-machine-debug-panel",t.style.cssText=`
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 10000;
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #00ff00;
        `,document.body.appendChild(t));let r=e.getContext(),o=e.getStateHistory(),s=e.getCurrentState();t.innerHTML=`
        <div style="font-weight: bold; margin-bottom: 8px; color: #ffff00;">
            \u{1F527} STATE MACHINE DEBUG
        </div>
        <div style="margin-bottom: 4px;">
            <strong>Current State:</strong> <span style="color: #00ffff;">${s}</span>
        </div>
        <div style="margin-bottom: 4px;">
            <strong>Transitions:</strong> ${o.length-1}
        </div>
        <div style="margin-bottom: 4px;">
            <strong>Update Mode:</strong> ${r.updateMode||"N/A"}
        </div>
        <div style="margin-bottom: 4px;">
            <strong>Updates:</strong> ${r.numberOfUpdates||0}
        </div>
        <div style="margin-bottom: 8px; font-size: 10px; color: #888;">
            Last 3: ${o.slice(-3).join(" \u2192 ")}
        </div>
        <div style="font-size: 10px; color: #666; cursor: pointer;" onclick="this.parentElement.remove()">
            [Click to close]
        </div>
    `}function tt(){let e=document.getElementById("state-machine-debug-panel");e&&e.remove()}function Wr(){let e=x();if(e)try{let t=`updateFlow_state_${e}`;localStorage.getItem(t)&&(localStorage.removeItem(t),n.debug(`Cleaned up legacy state machine data for course ${e}`))}catch(t){n.error("Failed to clean up localStorage:",t)}}async function Jr(e=null){var a;let t=x();if(!t)throw new ae("Course ID not found","courseId");let r=new Ie,o=v&&I?`Preparing to update "${R}" and grade overrides: checking setup...`:v?`Preparing to update "${R}": checking setup...`:"Preparing to update grade overrides: checking setup...",s=ce({text:o});r.updateContext({courseId:t,banner:s,button:e}),alert("You may minimize this browser or switch to another tab, but please keep this tab open until the process is fully complete.");try{for(r.transition(g.CHECKING_SETUP);r.getCurrentState()!==g.IDLE;){let c=r.getCurrentState();if(c===g.IDLE||c===g.ERROR)break;n.debug(`Executing state: ${c}`);let l=jr[c];if(!l)throw new Error(`No handler found for state: ${c}`);let d=await l(r);d!==c&&r.transition(d),Kr(r)}let i=(a=document.querySelector("#update-scores-button"))==null?void 0:a.parentElement;i&&Ge(i,t),rt(e),tt()}catch(i){if(r.updateContext({error:i}),r.transition(g.ERROR),i instanceof P){let c=We(i);alert(`Update cancelled: ${c}`),s.remove()}else{let c=ve(i,"startUpdateFlow",{banner:s});setTimeout(()=>{s.remove()},3e3)}rt(e),tt()}finally{Wr()}}function Xr(){jo(e=>{let t=x(),r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="flex-end";let o=Pt({label:je,id:"update-scores-button",onClick:async()=>{try{await Jr(o)}catch(a){ve(a,"updateScores",{showAlert:!0})}},type:"primary"});r.appendChild(o),Ge(r,t);let s=Bt();s.appendChild(r),e.appendChild(s)})}function rt(e){if(!e)return;e.textContent=je,e.title="",e.disabled=!1,e.style.cursor="pointer",e.style.opacity="1";let r=getComputedStyle(document.documentElement).getPropertyValue("--ic-brand-button--primary-bgd").trim()||"#0c7d9d";e.style.backgroundColor=r,n.debug("Button reset to normal state")}function jo(e){let t=0,r=setInterval(()=>{let o=window.location.pathname.includes("/gradebook"),s=document.readyState==="complete",a=document.querySelector('.outcome-gradebook-container nav, [data-testid="gradebook-toolbar"]');o&&s&&a?(clearInterval(r),n.debug("Gradebook page and toolbar found."),e(a)):t++>33&&(clearInterval(r),n.warn("Gradebook toolbar not found after 10 seconds, UI not injected."))},300)}var nt=new Set;async function Yo(e,t,r){return await r.get(`/api/v1/courses/${e}/assignments/${t}?include[]=rubric`,{},"fetchAssignmentWithRubric")}function Ko(e){let t=-1/0;if(Array.isArray(e==null?void 0:e.rubric))for(let o of e.rubric)for(let s of(o==null?void 0:o.ratings)||[]){let a=Number(s==null?void 0:s.points);Number.isFinite(a)&&(t=Math.max(t,a))}if(Number.isFinite(t)&&t>0)return n.debug(`[RefreshMastery] Using max points from rubric ratings: ${t}`),t;let r=Number(e==null?void 0:e.points_possible);return Number.isFinite(r)&&r>0?(n.debug(`[RefreshMastery] Using assignment points_possible: ${r}`),r):(n.debug(`[RefreshMastery] Using fallback max points: ${H}`),H)}async function Qr(e,t,r,o){return await o.put(`/api/v1/courses/${e}/assignments/${t}`,{assignment:{points_possible:r}},`updatePoints_${r}`)}async function Zr(e,t,r={}){var s,a;let o=`${e}_${t}`;if(nt.has(o))throw n.warn(`[RefreshMastery] Already running for assignment ${t}`),new Error("Refresh already in progress for this assignment");nt.add(o);try{let i=new C,c=(s=r.delay)!=null?s:vr,l=(a=r.skipRevert)!=null?a:!1;n.info(`[RefreshMastery] Starting refresh for assignment ${t} in course ${e}`);let d=await Yo(e,t,i),u=Ko(d);n.debug(`[RefreshMastery] Determined temp points: ${u}`,{courseId:e,assignmentId:t,tempPoints:u}),n.debug(`[RefreshMastery] Setting points_possible to ${u}`),await Qr(e,t,u,i),n.debug(`[RefreshMastery] Waiting ${c}ms for Canvas to propagate changes`),await new Promise(f=>setTimeout(f,c)),l||(n.debug("[RefreshMastery] Reverting points_possible to 0"),await Qr(e,t,0,i)),n.info(`[RefreshMastery] Successfully refreshed mastery for assignment ${t}`)}catch(i){throw n.error(`[RefreshMastery] Failed to refresh mastery for assignment ${t}:`,i),i}finally{nt.delete(o)}}var Wo=new Set;function en({tooltipId:e,ariaLabel:t="Information",title:r,bodyParagraphs:o=[],footer:s=null,iconSize:a=14,position:i="right",offset:c=8}){if(!e)throw new Error("tooltipId is required for createInfoIconWithTooltip");let l=document.createElement("span");l.className="cg-info-icon-container",l.setAttribute("role","button"),l.setAttribute("tabindex","0"),l.setAttribute("aria-label",t),l.setAttribute("aria-describedby",e),l.style.cssText=`
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 6px;
        cursor: help;
        vertical-align: middle;
    `;let d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.setAttribute("width",a.toString()),d.setAttribute("height",a.toString()),d.setAttribute("viewBox","0 0 16 16"),d.setAttribute("aria-hidden","true"),d.style.cssText=`
        display: block;
        fill: none;
        stroke: currentColor;
        stroke-width: 1.5;
        opacity: 0.7;
    `;let u=document.createElementNS("http://www.w3.org/2000/svg","circle");u.setAttribute("cx","8"),u.setAttribute("cy","8"),u.setAttribute("r","6.5");let f=document.createElementNS("http://www.w3.org/2000/svg","circle");f.setAttribute("cx","8"),f.setAttribute("cy","5.5"),f.setAttribute("r","0.8"),f.setAttribute("fill","currentColor"),f.setAttribute("stroke","none");let p=document.createElementNS("http://www.w3.org/2000/svg","line");p.setAttribute("x1","8"),p.setAttribute("y1","7.5"),p.setAttribute("x2","8"),p.setAttribute("y2","11"),p.setAttribute("stroke-width","1.5"),p.setAttribute("stroke-linecap","round"),d.appendChild(u),d.appendChild(f),d.appendChild(p),l.appendChild(d);let m=document.createElement("div");m.id=e,m.className="cg-info-tooltip",m.setAttribute("role","tooltip"),m.style.cssText=`
        position: fixed;
        display: none;
        background: #2d3b45;
        color: #ffffff;
        padding: 12px 14px 10px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 280px;
        font-size: 13px;
        line-height: 1.5;
        pointer-events: none;
    `;let h="";if(r&&(h+=`<div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">${ot(r)}</div>`),o.forEach((b,A)=>{let $=A===o.length-1&&!s?"0":"6px";h+=`<div style="margin-bottom: ${$};">${ot(b)}</div>`}),s){let b=o.length>0?"10px":"0";h+=`<div style="font-size: 11px; opacity: 0.6; font-style: italic; border-top: 1px solid rgba(255,255,255,0.15); padding-top: 6px; margin-top: ${b};">${ot(s)}</div>`}m.innerHTML=h,document.body.appendChild(m),Wo.add(m);let y=!1,E=()=>{let b=l.getBoundingClientRect();switch(m.style.display="block",i){case"right":m.style.left=`${b.right+c}px`,m.style.top=`${b.top}px`;break;case"left":m.style.right=`${window.innerWidth-b.left+c}px`,m.style.top=`${b.top}px`;break;case"top":m.style.left=`${b.left}px`,m.style.bottom=`${window.innerHeight-b.top+c}px`;break;case"bottom":m.style.left=`${b.left}px`,m.style.top=`${b.bottom+c}px`;break;default:m.style.left=`${b.right+c}px`,m.style.top=`${b.top}px`}y=!0},w=()=>{m.style.display="none",y=!1};return l.addEventListener("mouseenter",E),l.addEventListener("mouseleave",w),l.addEventListener("focus",E),l.addEventListener("blur",w),l.addEventListener("keydown",b=>{b.key==="Escape"&&y&&(w(),b.stopPropagation()),(b.key===" "||b.key==="Enter")&&(b.stopPropagation(),b.preventDefault())}),l.addEventListener("click",b=>{b.stopPropagation(),b.preventDefault()}),{iconContainer:l,tooltip:m}}function ot(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function st(e){return e?Tr.some(t=>typeof t=="string"?e.toLowerCase().includes(t.toLowerCase()):t instanceof RegExp?t.test(e):!1):!1}function tn(e){if(!e||typeof e!="string")return!1;let t=e.trim();return t?W.find(o=>o.description.toLowerCase()===t.toLowerCase())!==void 0:!1}async function Jo(e,t){try{return(await t.get(`/api/v1/courses/${e}/assignments?search_term=${encodeURIComponent(_)}`,{},"checkAvgAssignment")).some(o=>o.name===_)}catch(r){return n.warn(`Could not check assignments for course ${e}:`,r.message),!1}}async function Oe(e,t,r){let{courseId:o,courseName:s}=e,{apiClient:a}=r;if(!o||!s)return n.warn("[CourseModel] determineCourseModel called without required courseId or courseName"),{model:"traditional",reason:"invalid-input"};n.trace(`[CourseModel] Classifying course ${o} "${s}"`);let i=st(s);if(n.trace(`[CourseModel] Rule 1 - Pattern match: ${i?"YES":"NO"}`),i)return n.debug(`[CourseModel] \u2705 Course "${s}" \u2192 standards (name-pattern)`),{model:"standards",reason:"name-pattern"};if(!a)return n.warn(`[CourseModel] No apiClient provided for course ${o}, defaulting to traditional`),{model:"traditional",reason:"no-api-client"};n.trace("[CourseModel] Rule 2 - Checking AVG Assignment presence...");let c=await Jo(o,a);return n.trace(`[CourseModel] Rule 2 - AVG Assignment: ${c?"FOUND":"NOT FOUND"}`),c?(n.debug(`[CourseModel] \u2705 Course "${s}" \u2192 standards (avg-assignment)`),{model:"standards",reason:"avg-assignment"}):(n.debug(`[CourseModel] \u274C Course "${s}" \u2192 traditional`),{model:"traditional",reason:"no-match"})}function rn(e){var o,s,a,i,c,l,d,u,f,p,m,h,y,E;if(!e)return null;let t=null,r=null;return e.grades&&(t=(o=e.grades.current_score)!=null?o:e.grades.final_score,r=(c=(i=(a=(s=e.grades.current_grade)!=null?s:e.grades.final_grade)!=null?a:null)==null?void 0:i.trim())!=null?c:null),t==null&&(t=(u=(d=(l=e.computed_current_score)!=null?l:e.calculated_current_score)!=null?d:e.computed_final_score)!=null?u:e.calculated_final_score),r===null&&t!==null&&(r=(E=(y=(h=(m=(p=(f=e.computed_current_grade)!=null?f:e.calculated_current_grade)!=null?p:e.computed_final_grade)!=null?m:e.calculated_final_grade)!=null?h:null)==null?void 0:y.trim())!=null?E:null),t===null&&r===null?null:{score:t,letterGrade:r}}async function nn(e,t){try{let r=await t.get(`/api/v1/courses/${e}/enrollments?user_id=self&type[]=StudentEnrollment`,{},"fetchSingleEnrollment");n.trace(`[EnrollmentService] Fetched ${r.length} enrollment(s) for course ${e}`);let o=r.find(s=>s.type==="StudentEnrollment"||s.type==="student"||s.role==="StudentEnrollment");return o?(n.trace(`[EnrollmentService] Found student enrollment for course ${e}`),o):(n.trace(`[EnrollmentService] No student enrollment found for course ${e}`),n.isTraceEnabled()&&r.length>0&&n.trace("[EnrollmentService] Available enrollment types:",r.map(s=>s.type||s.role)),null)}catch(r){return n.warn(`[EnrollmentService] Failed to fetch enrollment for course ${e}:`,r.message),null}}function be(){let e=window.location.pathname;return e==="/"||e.startsWith("/dashboard")}function le(){let e=window.location.pathname;return e==="/grades"||e.includes("/grades")&&!e.includes("/courses/")}function Le(){return window.location.href.includes("/courses/")&&window.location.pathname.includes("/grades")}function on(){let e=window.location.pathname;return window.location.href.includes("/courses/")&&(e.includes("/grades")||e.includes("/assignments")||/^\/courses\/\d+$/.test(e))}function Se(){let e=window.location.pathname;return/^\/courses\/\d+\/grades\/\d+/.test(e)}function sn(){return window.location.pathname.includes("/speed_grader")}function ke(){let e=window.location.pathname,t=/^\/courses\/\d+\/grades\/(\d+)/,r=e.match(t);return r||n.trace("[getStudentIdFromUrl] No studentId found in URL",{path:e,expectedPattern:t.toString()}),r?r[1]:null}function an(){return Se()?ke():ENV!=null&&ENV.current_user_id?String(ENV.current_user_id):null}var Ue=Object.freeze({ASSIGNMENT:"assignment",ENROLLMENT:"enrollment"});async function Xo(e,t,r){try{let s=(await r.get(`/api/v1/courses/${e}/assignments?search_term=${encodeURIComponent(_)}`,{},"fetchAvgAssignment")).find(l=>l.name===_);if(!s)return n.trace(`AVG assignment "${_}" not found in course ${e}`),null;n.trace(`AVG assignment found: ${s.id}, ${s.name}`),n.trace(`looking for assignment submission for student: ${t}`);let a=await r.get(`/api/v1/courses/${e}/assignments/${s.id}/submissions/${t}`,{},"fetchAvgSubmission");n.trace("[fetchAvgAssignmentScore] Submission fetched",{courseId:e,studentId:t,assignmentId:s.id,score:a==null?void 0:a.score,grade:a==null?void 0:a.grade});let i=a==null?void 0:a.score,c=a==null?void 0:a.grade;return i==null?(n.trace(`No score found for AVG assignment in course ${e}`),null):(c==null&&n.trace(`No grade found for AVG assignment in course ${e}`),n.trace(`AVG assignment score for course ${e}: ${i}, grade: ${c}`),{score:i,grade:c})}catch(o){return n.warn(`Failed to fetch AVG assignment score for course ${e}:`,o.message),null}}async function Qo(e,t){let r=await nn(e,t);if(!r)return null;let o=rn(r);return!o||o.score===null||o.score===void 0?(n.trace(`No enrollment score found for course ${e}`),null):(n.trace(`Enrollment data for course ${e}: ${o.score}% (${o.letterGrade||"no letter grade"})`),{score:o.score,letterGrade:o.letterGrade})}async function cn(e,t){n.trace(`[Grade Fetch] Course ${e}: Starting grade fetch with fallback hierarchy`),n.trace(`[Grade Fetch] Course ${e}: Checking priority 1 - AVG assignment...`);let r=an();if(!r)return n.trace(`[Grade Fetch] Course ${e}: No target studentId available for submission lookup`),null;let o=await Xo(e,r,t);if((o==null?void 0:o.score)!=null){let{score:a,grade:i}=o;return n.trace(`[Grade Fetch] Course ${e}: AVG assignment found! score=${a}, letterGrade=${i!=null?i:"(none)"}`),{score:a,letterGrade:i!=null?i:null,source:Ue.ASSIGNMENT}}n.trace(`[Grade Fetch] Course ${e}: AVG assignment not found, checking priority 2...`),n.trace(`[Grade Fetch] Course ${e}: Checking priority 2 - enrollment grade...`);let s=await Qo(e,t);return s!==null?(n.trace(`[Grade Fetch] Course ${e}: Enrollment grade found! score=${s.score}, letterGrade=${s.letterGrade}`),{score:s.score,letterGrade:s.letterGrade,source:Ue.ENROLLMENT}):(n.trace(`[Grade Fetch] Course ${e}: Enrollment grade not found`),n.trace(`[Grade Fetch] Course ${e}: No grade available from any source`),null)}function ne(e,t){let r=typeof e=="number"?e.toFixed(2):String(e);return t?`${r} (${t})`:r}function Zo(e){return e/100*H}var de={ASSIGNMENT:"assignment",ENROLLMENT:"enrollment",PERCENTAGE:"percentage"};function ln(e){let{score:t,letterGrade:r=null,source:o=de.PERCENTAGE,includeAriaLabel:s=!0}=e,a,i;if(o===de.ASSIGNMENT){let c=t.toFixed(2),l=typeof r=="string"&&/^[0-9]+(\.[0-9]+)?$/.test(r.trim());l&&n.trace(`[Grade Display] Suppressing numeric letterGrade "${r}" for assignment source`),r&&!l?(a=`${c} (${r})`,i=`Grade: ${c}, letter grade ${r}`):(a=c,i=`Grade: ${c}`),n.trace(`[Grade Display] Assignment grade: display=${a}`)}else if(o===de.ENROLLMENT){let c=tn(r);if(r?n.trace(`[Grade Display] Checking "${r}" against rating scale: ${c?"MATCH FOUND":"NO MATCH"}`):n.trace("[Grade Display] Letter grade is empty/null/undefined"),c){let l=Zo(t),d=l.toFixed(2);a=`${d} (${r})`,i=`Grade: ${d}, letter grade ${r}`,n.trace(`[Grade Display] Converted to points: ${t}% -> ${l} -> display="${a}"`)}else{let l=`${t.toFixed(2)}%`;r?(a=`${l} (${r})`,i=`Grade: ${l}, letter grade ${r}`,n.trace(`[Grade Display] Letter grade "${r}" not in rating scale, using percentage: display="${a}"`)):(a=l,i=`Grade: ${l}`,n.trace(`[Grade Display] No letter grade, using percentage: display="${a}"`))}}else{let c=`${t.toFixed(2)}%`;r?(a=`${c} (${r})`,i=`Grade: ${c}, letter grade ${r}`):(a=c,i=`Grade: ${c}`),n.trace(`[Grade Display] Percentage grade: display=${a}`)}return s?{displayValue:a,ariaLabel:i}:{displayValue:a}}var at="cg_courseSnapshot_",ye="cg_userId",es=600*1e3,Q=Object.freeze({DASHBOARD:"dashboard",ALL_GRADES:"allGrades",COURSE_GRADES:"courseGrades"});function it(){return be()||le()||Le()||Se()||sn()}function ct(){let e=ENV!=null&&ENV.current_user_id?String(ENV.current_user_id):null;if(!e)return n.warn("[Snapshot] Cannot validate user ownership - ENV.current_user_id not available"),!1;let t=sessionStorage.getItem(ye);if(!t)return sessionStorage.setItem(ye,e),n.debug(`[Snapshot] Initialized user ownership tracking for user ${e}`),!0;if(t!==e){n.warn(`[Snapshot] User changed from ${t} to ${e} - clearing all snapshots`);let r=Me();return sessionStorage.setItem(ye,e),n.info(`[Snapshot] Cleared ${r} snapshots due to user change`),!0}return!0}function dn(){let e=ENV!=null&&ENV.current_user_id?String(ENV.current_user_id):null;if(!e)return n.warn("[Snapshot] Cannot validate snapshots - ENV.current_user_id not available"),0;let t=sessionStorage.getItem(ye);if(!t||t!==e){n.warn(`[Snapshot] User validation failed on init (cached=${t}, current=${e}) - clearing all snapshots`);let a=Me();return sessionStorage.setItem(ye,e),a}let o=Object.keys(sessionStorage).filter(a=>a.startsWith(at)),s=0;return o.forEach(a=>{try{let i=JSON.parse(sessionStorage.getItem(a));if(i.userId&&i.userId!==e){n.warn(`[Snapshot] Removing snapshot with mismatched userId: ${a}`),sessionStorage.removeItem(a),s++;return}i.expiresAt&&Date.now()>i.expiresAt&&(n.debug(`[Snapshot] Removing expired snapshot: ${a}`),sessionStorage.removeItem(a),s++)}catch(i){n.warn(`[Snapshot] Failed to parse snapshot ${a}, removing:`,i.message),sessionStorage.removeItem(a),s++}}),s>0?n.info(`[Snapshot] Cleared ${s} invalid/expired snapshots on init`):n.debug("[Snapshot] All existing snapshots validated successfully"),s}function G(e){if(!ct())return null;let t=`${at}${e}`,r=sessionStorage.getItem(t);if(!r)return n.trace(`[Snapshot] Cache MISS for course ${e}`),null;try{let o=JSON.parse(r),s=ENV!=null&&ENV.current_user_id?String(ENV.current_user_id):null;return o.userId&&o.userId!==s?(n.warn(`[Snapshot] User ID mismatch for course ${e}, removing snapshot`),sessionStorage.removeItem(t),null):o.expiresAt&&Date.now()>o.expiresAt?(n.debug(`[Snapshot] Snapshot expired for course ${e}, removing`),sessionStorage.removeItem(t),null):(n.trace(`[Snapshot] Cache HIT for course ${e}: isStandardsBased=${o.isStandardsBased}, score=${o.score}, source=${o.gradeSource}`),o)}catch(o){return n.warn(`[Snapshot] Failed to parse snapshot for course ${e}:`,o.message),sessionStorage.removeItem(t),null}}async function D(e,t,r){if(!ct())return n.warn("[Snapshot] Cannot populate snapshot - user ownership validation failed"),null;if(!it())return n.trace("[Snapshot] Skipping snapshot population - unauthorized page"),null;let o=ENV!=null&&ENV.current_user_id?String(ENV.current_user_id):null;if(!o)return n.warn("[Snapshot] Cannot populate snapshot - ENV.current_user_id not available"),null;let s=j();n.debug(`[Snapshot] Populating snapshot for course ${e} "${t}" (user role: ${s})`);try{n.trace(`[Snapshot] Step 1: Fetching grade for ${e}...`);let a=await cn(e,r);a?n.trace(`[Snapshot] Course ${e} grade: score=${a.score}, letterGrade=${a.letterGrade}, source=${a.source}`):n.trace(`[Snapshot] No grade data available for course ${e} (user may not be enrolled)`),n.trace(`[Snapshot] Step 2: Classifying course model for ${e}...`);let i=await Oe({courseId:e,courseName:t},null,{apiClient:r});n.trace(`[Snapshot] Course ${e} classification: model=${i.model}, reason=${i.reason}`);let c=i.model==="standards",l=null,d=null,u=null,f=null,p=null,m=null;if(a){n.trace(`[Snapshot] Step 3: Calculating display values for ${e}...`),f=a.score,p=a.letterGrade,m=a.source,l=a.score,d=a.letterGrade,u="percentage";let E=a.source===Ue.ASSIGNMENT?de.ASSIGNMENT:de.ENROLLMENT,w=ln({score:a.score,letterGrade:a.letterGrade,source:E,includeAriaLabel:!1});if(w.displayValue.includes("(")&&!w.displayValue.includes("%")){u="points";let b=w.displayValue.match(/^([\d.]+)\s*\(([^)]+)\)/);b&&(l=parseFloat(b[1]),d=b[2])}else if(w.displayValue.includes("%")){u="percentage";let b=w.displayValue.match(/^([\d.]+)%/);b&&(l=parseFloat(b[1]))}else u="points",l=parseFloat(w.displayValue);n.trace(`[Snapshot] Display values: displayScore=${l}, displayType=${u}, displayLetterGrade=${d}`)}else n.trace("[Snapshot] Step 3: Skipping display value calculation (no grade data)");let h={courseId:e,courseName:t,model:i.model,modelReason:i.reason,isStandardsBased:c,score:f,letterGrade:p,gradeSource:m,displayScore:l,displayLetterGrade:d,displayType:u,timestamp:Date.now(),userId:o,expiresAt:Date.now()+es},y=`${at}${e}`;return sessionStorage.setItem(y,JSON.stringify(h)),a?n.debug(`[Snapshot] \u2705 Populated snapshot for course ${e}: model=${i.model} (${i.reason}), display=${l} (${u}), source=${m}, expiresAt=${new Date(h.expiresAt).toISOString()}`):n.debug(`[Snapshot] \u2705 Populated snapshot for course ${e}: model=${i.model} (${i.reason}), no grade data, expiresAt=${new Date(h.expiresAt).toISOString()}`),h}catch(a){return n.warn(`[Snapshot] Failed to populate snapshot for course ${e}:`,a.message),null}}function Ee(e,t){if(!it())return n.trace(`[Refresh] Course ${e}: Unauthorized page, no refresh allowed`),!1;let r=G(e);if(!r)return n.trace(`[Refresh] Course ${e}: No snapshot exists, needs population`),!0;if(r.isStandardsBased)return n.trace(`[Refresh] Course ${e}: Standards-based, no refresh needed (page=${t})`),!1;let s=[Q.ALL_GRADES,Q.COURSE_GRADES].includes(t),a=s?`page ${t} requires fresh grade`:`page ${t} uses cached grade`;return n.trace(`[Refresh] Course ${e}: Non-standards-based, ${a}`),s}async function Fe(e,t,r,o,s=!1){return ct()?!s&&!it()?(n.trace("[Refresh] Cannot refresh snapshot - unauthorized page"),G(e)):s?(n.debug(`[Refresh] Force refresh for course ${e} (page=${o})`),await D(e,t,r)):Ee(e,o)?(n.debug(`[Refresh] Refreshing snapshot for course ${e} (page=${o})`),await D(e,t,r)):(n.trace(`[Refresh] Using existing snapshot for course ${e} (page=${o})`),G(e)):(n.warn("[Refresh] Cannot refresh snapshot - user ownership validation failed"),null)}function Me(){let t=Object.keys(sessionStorage).filter(r=>r.startsWith("cg_"));return t.forEach(r=>sessionStorage.removeItem(r)),n.debug(`[Snapshot] Cleared all snapshots (${t.length} entries removed)`),t.length}var Z="cg-refresh-mastery-menuitem",un="cg-refresh-mastery-style",pn=null,lt=null;function ts(e){let t=e.getBoundingClientRect();return t.width>0&&t.height>0}function rs(e){return[...e.querySelectorAll('[role="menuitem"]')].map(o=>(o.innerText||o.textContent||"").trim()).includes("SpeedGrader")}function ns(e){var s;if(!e)return n.warn("[RefreshMastery] No kebab button reference available"),null;let t=e.closest(".slick-header-column.assignment");if(!t)return n.warn("[RefreshMastery] Could not find parent .slick-header-column.assignment"),null;let r=t.className.match(/\bassignment_(\d+)\b/);if(r)return Number(r[1]);let o=t.querySelector('a[href*="/assignments/"]');if(o){let a=(s=o.getAttribute("href"))==null?void 0:s.match(/\/assignments\/(\d+)/);if(a)return Number(a[1])}return n.warn("[RefreshMastery] Could not extract assignment ID from header column"),null}function os(e){try{e.setAttribute("tabindex","-1"),e.focus({preventScroll:!0})}catch(r){}let t=e.querySelector('[role="menuitem"]');if(t)try{t.focus({preventScroll:!0})}catch(r){}}function ss(e){let t=e.querySelector('a[role="menuitem"].css-1kq4kmj-menuItem')||e.querySelector('button[role="menuitem"].css-1kq4kmj-menuItem')||e.querySelector('span[role="menuitem"].css-1kq4kmj-menuItem');if(!t)return n.warn("[RefreshMastery] Could not find menu item template to clone"),null;let r=t.cloneNode(!0);r.id=Z,r.removeAttribute("href"),r.tagName.toLowerCase()==="a"&&r.setAttribute("href","#"),r.tagName.toLowerCase()==="button"&&(r.type="button");let o=document.createTreeWalker(r,NodeFilter.SHOW_TEXT),s=null;for(;o.nextNode();){let a=o.currentNode.nodeValue;if(a&&a.trim().length>0){s=o.currentNode;break}}if(s){s.nodeValue="Refresh Mastery";let{iconContainer:a}=en({tooltipId:"cg-refresh-mastery-tooltip",ariaLabel:"About Refresh Mastery",title:"Refresh Mastery",bodyParagraphs:["Temporarily gives this assignment points so Canvas recalculates mastery results.","Does not change student grades.","Points possible are automatically set back to zero.","This does not update rubric scores, so outcome results are unchanged."],footer:"MOREnet Gradebook Customization",iconSize:14,position:"right",offset:8}),i=s.parentElement;i&&i.appendChild(a)}return r}function as(){let e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width","16"),e.setAttribute("height","16"),e.setAttribute("viewBox","0 0 16 16"),e.setAttribute("role","status"),e.setAttribute("aria-label","Loading"),e.style.cssText=`
        display: inline-block;
        vertical-align: middle;
        margin-left: 6px;
        animation: cg-spinner-rotate 0.8s linear infinite;
    `;let t=document.createElementNS("http://www.w3.org/2000/svg","circle");return t.setAttribute("cx","8"),t.setAttribute("cy","8"),t.setAttribute("r","6"),t.setAttribute("fill","none"),t.setAttribute("stroke","currentColor"),t.setAttribute("stroke-width","2"),t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-dasharray","28"),t.setAttribute("stroke-dashoffset","10"),e.appendChild(t),e}async function is(e,t){try{n.debug(`[RefreshMastery] Updating gradebook settings for assignment ${t}`);let r=new C,o={gradebook_settings:{enter_grades_as:{[t]:"gradingScheme"}}};n.debug("[RefreshMastery] Sending gradebook settings update:",o),await r.put(`/api/v1/courses/${e}/gradebook_settings`,o,{},"updateGradebookSettings"),n.info(`[RefreshMastery] Successfully updated gradebook settings for assignment ${t}`)}catch(r){n.warn("[RefreshMastery] Failed to update gradebook settings (non-critical):",r)}}async function cs(e){if(!e||!rs(e)||(os(e),e.querySelector(`#${Z}`)))return;let t=ss(e);t&&(t.setAttribute("tabindex","0"),t.addEventListener("mouseenter",()=>{try{t.focus({preventScroll:!0})}catch(r){t.focus()}}),t.addEventListener("click",async r=>{var c;r.preventDefault();let o=x(),s=ns(pn);if(!o||!s){n.error("[RefreshMastery] Missing courseId or assignmentId",{courseId:o,assignmentId:s}),ce({text:"Refresh Mastery failed (missing context)",duration:3e3});return}let a=((c=t.querySelector("span"))==null?void 0:c.textContent)||"Refresh Mastery",i=t.querySelector("span");if(t.setAttribute("aria-disabled","true"),t.setAttribute("aria-busy","true"),t.style.pointerEvents="none",i){i.textContent="Refreshing";let l=as();i.appendChild(l)}try{n.info(`[RefreshMastery] Starting refresh for assignment ${s}`),await Zr(o,s),n.info(`[RefreshMastery] Successfully refreshed assignment ${s}`),await is(o,s),ce({text:"\u2713 Mastery Levels updated - Reload the page in ~30 seconds to see changes",duration:5e3})}catch(l){n.error("[RefreshMastery] Refresh failed:",l),ce({text:"\u2717 Refresh Mastery failed - Please try again",duration:3500})}finally{i&&(i.textContent=a),t.removeAttribute("aria-disabled"),t.removeAttribute("aria-busy"),t.style.pointerEvents=""}}),e.appendChild(t),n.debug("[RefreshMastery] Injected menu item"))}function ls(){if(document.getElementById(un))return;let e=document.createElement("style");e.id=un,e.textContent=`
        #${Z}:hover,
        #${Z}:focus {
            color: white !important;
        }
        #${Z}:hover *,
        #${Z}:focus * {
            color: white !important;
        }

        /* Info icon visibility on hover/focus */
        #${Z}:hover .cg-info-icon-container,
        #${Z}:focus .cg-info-icon-container,
        .cg-info-icon-container:hover,
        .cg-info-icon-container:focus {
            opacity: 1 !important;
        }

        /* Info icon focus outline */
        .cg-info-icon-container:focus {
            outline: 2px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
            border-radius: 50%;
        }

        /* Spinner rotation animation */
        @keyframes cg-spinner-rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    `,document.head.appendChild(e),n.debug("[RefreshMastery] Injected CSS styles")}async function mn(){var o,s;if(!_r){n.debug("[RefreshMastery] Feature disabled via config");return}n.info("[RefreshMastery] Initializing kebab menu injection");let e=x();if(!e){n.warn("[RefreshMastery] Cannot get course ID, skipping initialization");return}let t=G(e);if(!t){n.debug("[RefreshMastery] No snapshot found, populating for course type detection...");let a=new C,i=((s=(o=document.querySelector(".course-title, h1, #breadcrumbs li:last-child"))==null?void 0:o.textContent)==null?void 0:s.trim())||"Course";t=await D(e,i,a)}if(t)lt=t.model==="standards",n.debug(`[RefreshMastery] Course ${e} is ${t.model} (reason: ${t.modelReason})`);else{lt=!1,n.warn("[RefreshMastery] Could not determine course type, skipping initialization");return}if(!lt){n.debug("[RefreshMastery] Course is traditional, skipping initialization");return}n.info("[RefreshMastery] Course is standards-based, proceeding with initialization"),ls(),document.addEventListener("click",a=>{let i=a.target.closest('button[aria-haspopup="true"][data-popover-trigger="true"]');i&&(pn=i,n.debug("[RefreshMastery] Tracked kebab button click"))},!0),new MutationObserver(()=>{let a=[...document.querySelectorAll('[role="menu"]')].filter(ts),i=a[a.length-1];i&&cs(i).catch(c=>{n.warn("[RefreshMastery] Error injecting menu item:",c)})}).observe(document.body,{childList:!0,subtree:!0}),n.info("[RefreshMastery] Kebab menu injection initialized successfully")}function dt(e,t=!0){let r=e.querySelectorAll('a[href*="/courses/"]');return t?Array.from(r).filter(o=>!(o.closest(".ic-app-header")||o.closest('[role="navigation"]')||o.closest(".menu"))):Array.from(r)}function ds(e){if(!e)return null;let t=e.textContent.trim();if(!t)return null;let r=t.match(/(\d+(?:\.\d+)?)\s*%/);return r?parseFloat(r[1]):null}function fn(e){try{let t=e.querySelector('a[href*="/courses/"]');if(!t)return n.trace("[DOM Extractor] No course link found in row"),null;let r=t.textContent.trim(),o=t.getAttribute("href"),s=Ye(o);if(!s)return n.trace(`[DOM Extractor] Could not extract course ID from href: ${o}`),null;let a=e.querySelector(".percent"),i=ds(a),c=st(r);return n.trace(`[DOM Extractor] Extracted course: ${r} (${s}), grade=${i}%, matchesPattern=${c}`),{courseId:s,courseName:r,percentage:i,matchesPattern:c,courseUrl:`/courses/${s}/grades`}}catch(t){return n.warn("[DOM Extractor] Failed to extract course data from row:",t),null}}function gn(){let e=document.querySelector("table.course_details.student_grades");if(!e)return n.trace("[DOM Extractor] Grades table not found"),[];let t=e.querySelectorAll("tbody tr");return n.trace(`[DOM Extractor] Found ${t.length} table rows`),Array.from(t)}var ut=["[data-course-id]",".ic-DashboardCard",'[class*="DashboardCard"]',".course-list-item",'[class*="CourseCard"]','div[id^="dashboard_card_"]',".dashboard-card"],hn=[".ic-DashboardCard__header_hero",'[class*="hero"]','[class*="Hero"]',".ic-DashboardCard__header",'[class*="header"]','[class*="Header"]'];function Pe(){return ut}function bn(e){var s,a;if(e.nodeType!==Node.ELEMENT_NODE)return!1;let t=e;if((s=t.hasAttribute)!=null&&s.call(t,"data-course-id"))return!0;let r=t.className||"";return!!(typeof r=="string"&&(r.includes("DashboardCard")||r.includes("CourseCard")||r.includes("course-list-item")||r.includes("dashboard-card"))||(t.id||"").startsWith("dashboard_card_")||(a=t.querySelector)!=null&&a.call(t,'a[href*="/courses/"]'))}function Sn(){for(let t of ut){let r=document.querySelectorAll(t);if(r.length>0)return n.trace(`Found ${r.length} dashboard cards using selector: ${t}`),r}let e=dt(document.body,!0);return e.length>0?(n.trace(`Found ${e.length} dashboard course links`),e):(n.trace("No dashboard cards found with any selector"),null)}function yn(e){let t=document.querySelector(`[data-course-id="${e}"]`);if(t)return n.trace(`Found card for course ${e} using data-course-id`),t;let r=`/courses/${e}`,o=document.querySelectorAll(`a[href*="${r}"]`);for(let a of o)for(let i of ut){let c=a.closest(i);if(c&&c.querySelector(`a[href*="${r}"]`))return n.trace(`Found card for course ${e} using href strategy with selector: ${i}`),c}let s=dt(document.body,!0).filter(a=>{let i=a.getAttribute("href");return i&&i.includes(r)});for(let a of s){let i=a;for(let c=0;c<5&&(i=i.parentElement,!!i);c++)if(i.className&&(i.className.includes("Card")||i.className.includes("card")||i.className.includes("course")))return n.trace(`Found card for course ${e} using parent traversal`),i}return n.trace(`Dashboard card not found for course ${e}`),null}var En="cg-dashboard-grade";function us(e){let{score:t,letterGrade:r,displayType:o}=e;n.trace(`[Grade Display] Formatting display values: score=${t}, letterGrade=${r}, displayType=${o}`);let s,a;if(o==="points"){let i=t.toFixed(2);r?(s=`${i} (${r})`,a=`Grade: ${i}, letter grade ${r}`):(s=i,a=`Grade: ${i}`)}else{let i=`${t.toFixed(2)}%`;r?(s=`${i} (${r})`,a=`Grade: ${i}, letter grade ${r}`):(s=i,a=`Grade: ${i}`)}return n.trace(`[Grade Display] Formatted: displayValue="${s}"`),{displayValue:s,ariaLabel:a}}function ps(e,t=null){let{source:r,displayType:o}=e,{displayValue:s,ariaLabel:a}=us(e),i=document.createElement("div");i.className=`${En}`,i.setAttribute("data-source",r),i.setAttribute("role","status"),i.setAttribute("aria-label",a),i.textContent=s;let c="rgba(64, 64, 64, 0.85)";if(t){let d=window.getComputedStyle(t).backgroundColor;d&&d!=="transparent"&&d!=="rgba(0, 0, 0, 0)"&&(c=ms(d),n.trace(`Derived badge background from hero color: ${d} -> ${c}`))}return i.style.cssText=`
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 0.875rem;
        line-height: 1.4;
        border-radius: 8px;
        background: ${c};
        color: #fff;
        display: inline-block;
        text-align: center;
        box-sizing: border-box;
        padding: 6px 10px;
        font-weight: 600;
        white-space: nowrap;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 10;
    `,i}function ms(e){let t=fs(e);if(!t)return"rgba(64, 64, 64, 0.75)";let r=Math.max(0,Math.floor(t.r*.7)),o=Math.max(0,Math.floor(t.g*.7)),s=Math.max(0,Math.floor(t.b*.7));return`rgba(${r}, ${o}, ${s}, 0.75)`}function fs(e){let t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(t)return{r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10)};let r=e.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}function gs(e){for(let r of hn){let o=e.querySelector(r);if(o)return window.getComputedStyle(o).position==="static"&&(o.style.position="relative"),n.trace(`Using container for grade badge placement: ${r}`),o}return n.warn("Could not find hero or header element, using card itself (fallback)"),window.getComputedStyle(e).position==="static"&&(e.style.position="relative"),e}function Cn(e,t){hs(e);let r=gs(e);if(!r){n.warn("Could not find suitable container for grade badge"),n.warn("Card element:",e);return}let o=ps(t,r);if(r.appendChild(o),n.isTraceEnabled()){let s=t.displayType==="percentage"?"%":"",a=t.letterGrade?`${t.score}${s} (${t.letterGrade})`:`${t.score}${s}`;n.trace(`Grade badge rendered (${a}, type: ${t.displayType}, source: ${t.source})`),n.trace(`Badge placed in: ${r.className||r.tagName}`)}else n.debug(`Grade badge rendered on card (type: ${t.displayType}, source: ${t.source})`)}function hs(e){let t=e.querySelector(`.${En}`);t&&(t.remove(),n.trace("Existing grade badge removed from card"))}var O={CHILD_LIST:{childList:!0,subtree:!0},CHILD_LIST_AND_ATTRIBUTES:{childList:!0,subtree:!0,attributes:!0},ATTRIBUTES_ONLY:(e=[])=>({attributes:!0,attributeFilter:e}),FULL:{childList:!0,subtree:!0,attributes:!0,characterData:!0}};function wn(e,t={}){let{timeout:r=3e4,config:o=O.CHILD_LIST,target:s=document.body,name:a="Observer"}=t,i=!1,c=new MutationObserver(l=>{if(i)return;e(l)&&(c.disconnect(),i=!0,n.trace(`${a} disconnected (condition met)`))});return c.observe(s,o),n.trace(`${a} started, will auto-disconnect after ${r}ms or when condition met`),setTimeout(()=>{i||(c.disconnect(),i=!0,n.trace(`${a} auto-disconnected (timeout)`))},r),c}function V(e,t={}){let{config:r=O.CHILD_LIST,target:o=document.body,name:s="Observer"}=t,a=new MutationObserver(e);return a.observe(o,r),n.trace(`${s} started (persistent - remember to disconnect manually)`),a}var An=!1,pt=null,$n=3;async function _n(e){var t;try{let r=await e.get("/api/v1/courses?enrollment_state=active&include[]=total_scores",{},"fetchActiveCourses");n.trace("Raw courses response:",r),n.trace(`Number of courses returned: ${(r==null?void 0:r.length)||0}`),r&&r.length>0&&(n.trace("First course structure:",r[0]),n.trace("First course enrollments:",r[0].enrollments));let s=r.filter(a=>{let i=a.enrollments||[],c=i.some(l=>l.type==="student"||l.type==="StudentEnrollment"||l.role==="StudentEnrollment");return n.isTraceEnabled()&&i.length>0&&n.trace(`Course ${a.id} (${a.name}): enrollments =`,i.map(l=>l.type)),c}).map(a=>{let c=(a.enrollments||[]).find(l=>l.type==="student"||l.type==="StudentEnrollment"||l.role==="StudentEnrollment");return{id:String(a.id),name:a.name,enrollmentData:c||null}});if(n.info(`Found ${s.length} active student courses out of ${r.length} total courses`),n.isTraceEnabled()&&s.length>0){let a=s[0];n.trace("First course enrollment data:",a.enrollmentData),(t=a.enrollmentData)!=null&&t.grades&&n.trace("First course grades object:",a.enrollmentData.grades)}return s}catch(r){return n.error("Failed to fetch active courses:",r),[]}}async function bs(e,t,r){try{let o=yn(e);if(!o){n.trace(`Card element not found for course ${e}, skipping`);return}let s=G(e);if(s||(n.trace(`No snapshot for course ${e}, populating...`),s=await D(e,t,r)),!s){n.trace(`No grade available for course ${e}, skipping`);return}let a={score:s.displayScore,letterGrade:s.displayLetterGrade,source:s.gradeSource,displayType:s.displayType};Cn(o,a);let i=s.displayLetterGrade?`${s.displayScore} (${s.displayLetterGrade})`:`${s.displayScore}`;n.trace(`Grade displayed for course ${e}: ${i} ${s.displayType} (source: ${s.gradeSource})`)}catch(o){n.warn(`Failed to update grade for course ${e}:`,o.message)}}async function xn(){try{let e=performance.now(),t=new C,r=await _n(t);if(r.length===0){n.info("No active student courses found");return}n.info(`Updating grades for ${r.length} courses`);let o=$n,s=r.map(y=>({id:y.id,name:y.name})),a=0,i=0,c=0;async function l(){for(;s.length>0;){let y=s.shift();if(!y)break;try{await bs(y.id,y.name,t),a++,i++,a%5===0&&n.debug(`Progress: ${a}/${r.length} courses processed`)}catch(E){a++,c++,n.warn(`Worker failed to process course ${y.id}:`,E.message)}}}let d=performance.now();n.debug(`Starting ${o} concurrent workers for ${r.length} courses`),await Promise.all(Array.from({length:o},()=>l()));let u=performance.now()-d,f=performance.now()-e,p=u/r.length;n.info("Dashboard grade display update complete"),n.info(`Performance: ${r.length} courses processed in ${f.toFixed(0)}ms total (${u.toFixed(0)}ms processing)`),n.info(`Success: ${i}/${r.length} courses, ${c} errors`),n.info(`Average: ${p.toFixed(0)}ms per course with ${o} concurrent workers`);let h=p*r.length/u;n.debug(`Estimated speedup: ${h.toFixed(1)}x faster than sequential processing`)}catch(e){n.error("Failed to update dashboard grades:",e)}}function Ss(e=5e3){return new Promise(t=>{let r=Date.now(),o=()=>{let s=Sn();if(s&&s.length>0){n.info(`Dashboard cards found: ${s.length}`),n.isTraceEnabled()&&s[0]&&(n.trace("First card element:",s[0]),n.trace("First card classes:",s[0].className),n.trace("First card attributes:",Array.from(s[0].attributes).map(a=>`${a.name}="${a.value}"`))),t(!0);return}if(Date.now()-r>e){n.warn("Timeout waiting for dashboard cards"),n.warn("Tried selectors:",Pe()),n.warn("Current URL:",window.location.href),n.warn("Dashboard container exists:",!!document.querySelector("#dashboard")),t(!1);return}setTimeout(o,100)};o()})}function ys(){pt&&pt.disconnect();let e=document.querySelector("#dashboard")||document.querySelector("#content")||document.body;pt=V(t=>{t.some(o=>Array.from(o.addedNodes).some(s=>{var a;return bn(s)||((a=s.querySelector)==null?void 0:a.call(s,Pe().join(",")))}))&&(n.trace("Dashboard cards detected via MutationObserver, updating grades"),xn())},{config:O.CHILD_LIST,target:e,name:"DashboardGradeDisplay"}),n.trace("Dashboard observer setup complete, observing:",e.id||e.tagName)}function Es(){console.log("=== Dashboard Card Diagnostic ==="),console.log("Current URL:",window.location.href),console.log("Is dashboard page:",window.location.pathname==="/"||window.location.pathname.startsWith("/dashboard"));let e=Pe();console.log("Trying selectors:",e),e.forEach(o=>{try{let s=document.querySelectorAll(o);s.length>0?(console.log(`\u2713 Found ${s.length} elements with selector: ${o}`),console.log("  First element:",s[0])):console.log(`\u2717 No elements found with selector: ${o}`)}catch(s){console.log(`\u2717 Error with selector ${o}:`,s.message)}});let t=document.querySelectorAll('a[href*="/courses/"]');console.log(`Found ${t.length} total course links`);let r=Array.from(t).filter(o=>!o.closest(".ic-app-header")&&!o.closest('[role="navigation"]')&&!o.closest(".menu"));console.log(`Found ${r.length} dashboard course links`),r.length>0&&(console.log("First dashboard link:",r[0]),console.log("First dashboard link parent:",r[0].parentElement)),console.log("=== End Diagnostic ===")}async function Tn(){if(An){n.trace("Dashboard grade display already initialized");return}An=!0,n.info("Initializing dashboard grade display"),window.CG||(window.CG={}),window.CG.diagnosticDashboard=Es,window.CG.testConcurrentPerformance=Cs,n.info("Diagnostic function available: window.CG.diagnosticDashboard()"),n.info("Performance test available: window.CG.testConcurrentPerformance()"),await Ss()||(n.warn("Dashboard cards not found, grade display may not work"),n.warn("Run window.CG.diagnosticDashboard() in console for more info")),await xn(),ys()}async function Cs(){try{n.info("=== Performance Test: Sequential vs Concurrent Processing ===");let e=new C,t=await _n(e);if(t.length===0)return n.warn("No courses found for performance testing"),{error:"No courses found"};n.info(`Testing with ${t.length} courses`),n.info("Test 1: Sequential processing...");let r=performance.now();for(let p of t)try{await D(p.id,p.name,e)}catch(m){n.trace(`Sequential test error for course ${p.id}:`,m.message)}let o=performance.now()-r;n.info(`Sequential: ${o.toFixed(0)}ms total, ${(o/t.length).toFixed(0)}ms per course`),n.info("Test 2: Concurrent processing...");let s=performance.now(),a=$n,i=t.map(p=>({id:p.id,name:p.name}));async function c(){for(;i.length>0;){let p=i.shift();if(!p)break;try{await D(p.id,p.name,e)}catch(m){n.trace(`Concurrent test error for course ${p.id}:`,m.message)}}}await Promise.all(Array.from({length:a},()=>c()));let l=performance.now()-s;n.info(`Concurrent: ${l.toFixed(0)}ms total, ${(l/t.length).toFixed(0)}ms per course`);let d=o/l,u=(o-l)/o*100,f={courses:t.length,concurrency:a,sequential:{total:Math.round(o),perCourse:Math.round(o/t.length)},concurrent:{total:Math.round(l),perCourse:Math.round(l/t.length)},speedup:d.toFixed(2),improvement:u.toFixed(1)+"%",timeSaved:Math.round(o-l)+"ms"};return n.info("=== Performance Test Results ==="),n.info(`Speedup: ${f.speedup}x faster (${f.improvement} improvement)`),n.info(`Time saved: ${f.timeSaved}`),n.info("Full results:",f),f}catch(e){return n.error("Performance test failed:",e),{error:e.message}}}var vn=!1,mt=null,Ce="grading-box-extended";function Be(){let e=document.getElementById(Ce);if(!e){n.trace(`Grading dropdown element #${Ce} not found`);return}if(!e.hasAttribute("disabled")&&!e.hasAttribute("readonly")&&!e.hasAttribute("aria-disabled")){n.trace("Grading dropdown already active");return}e.removeAttribute("disabled"),e.removeAttribute("readonly"),e.removeAttribute("aria-disabled"),e.classList.remove("ui-state-disabled"),n.debug("Grading dropdown activated - removed disabled/readonly attributes")}function ws(){mt&&mt.disconnect();let e=te(N({},O.CHILD_LIST_AND_ATTRIBUTES),{attributeFilter:["disabled","readonly","aria-disabled","class"]});mt=V(t=>{t.forEach(r=>{r.type==="childList"?r.addedNodes.forEach(o=>{o.nodeType===Node.ELEMENT_NODE&&(o.id===Ce?(n.trace("Grading dropdown added to DOM, activating"),Be()):o.querySelector&&o.querySelector(`#${Ce}`)&&(n.trace("Grading dropdown found in added subtree, activating"),Be()))}):r.type==="attributes"&&r.target.id===Ce&&(n.trace(`Grading dropdown attribute changed: ${r.attributeName}`),Be())})},{config:e,target:document.body,name:"GradingDropdownObserver"})}function In(){if(vn){n.trace("SpeedGrader grading dropdown already initialized");return}vn=!0,n.info("Initializing SpeedGrader grading dropdown auto-activator"),Be(),ws(),n.info("SpeedGrader grading dropdown auto-activator started")}var U={GRADE_INPUT_UPDATE_DELAYS:[0,700,1500],RUBRIC_FETCH_DELAYS:[200,250,350],UI_KEEPALIVE_INTERVAL:600,UI_KEEPALIVE_DURATION:12e3,NAVIGATION_RECHECK_DELAY:250,URL_PARSE_RETRY_DELAY:500,URL_PARSE_MAX_ATTEMPTS:3,SUBMIT_GRADE_TIMEOUT:1e4,SUBMIT_GRADE_MAX_RETRIES:2},Ve={CONTAINER_BG:"rgb(245, 245, 245)",CONTAINER_BORDER:"rgb(245, 245, 245)",LABEL_BG:"rgb(245, 245, 245)",SCORE_BG:"rgb(0, 142, 83)"},As={UI_KEEPALIVE_ENABLED:!0},ft=!1,ee=!1,Rn=new Map,ht=null,ue=null,q={attempts:0,successes:0,failures:0,skipped:0},$s=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value").set;function St(){var l,d;let e=window.location.pathname,t=new URLSearchParams(window.location.search),r=e.match(/\/courses\/(\d+)\//),o=r?r[1]:null,s=t.get("assignment_id"),a=t.get("student_id"),i=s&&((l=s.match(/^\d+/))==null?void 0:l[0])||null,c=a&&((d=a.match(/^\d+/))==null?void 0:d[0])||null;return{courseId:o,assignmentId:i,studentId:c}}async function _s(e=U.URL_PARSE_MAX_ATTEMPTS,t=U.URL_PARSE_RETRY_DELAY){for(let r=1;r<=e;r++){let o=St();if(n.trace(`[ScoreSync] Parse attempt ${r}/${e} - courseId: ${o.courseId}, assignmentId: ${o.assignmentId}, studentId: ${o.studentId}`),o.courseId&&o.assignmentId&&o.studentId)return o;r<e&&(n.trace(`[ScoreSync] Missing IDs, waiting ${t}ms before retry...`),await new Promise(s=>setTimeout(s,t)))}return{courseId:null,assignmentId:null,studentId:null}}function Gn(e){let t=localStorage.getItem(e);return t?JSON.parse(t):null}function Nn(e,t){localStorage.setItem(e,JSON.stringify(t))}function Ln(e,t){let r=window.location.hostname;return{assignment:`cg_speedgrader_scoresync_settings::${r}::course::${e}::assignment::${t}`,course:`cg_speedgrader_scoresync_default::${r}::course::${e}`}}function xs(e,t,r){return`${e}:${t}:${r}`}function Dn(e){let t={enabled:!0,method:"min"};return!e||typeof e!="object"?t:{enabled:typeof e.enabled=="boolean"?e.enabled:t.enabled,method:["min","avg","max","sum"].includes(e.method)?e.method:t.method}}function kn(e,t){let r=Ln(e,t),o=Gn(r.assignment);if(o)return Dn(o);let s=Gn(r.course);return s?Dn(s):{enabled:!0,method:"min"}}function On(e,t,r){let o=Ln(e,t);Nn(o.assignment,r),Nn(o.course,r)}function Ts(e,t){let r=Object.values(e).map(o=>o.points).filter(o=>typeof o=="number"&&!isNaN(o));return r.length===0?0:t==="min"?Math.min(...r):t==="max"?Math.max(...r):t==="avg"?r.reduce((o,s)=>o+s,0)/r.length:t==="sum"?r.reduce((o,s)=>o+s,0):Math.min(...r)}function vs(e){return Object.entries(e||{}).map(([t,r])=>{let o=Number(r==null?void 0:r.points);return Number.isFinite(o)?`${t}:${o.toFixed(2)}`:null}).filter(Boolean).sort().join("|")}function Is(){let e=Array.from(document.querySelectorAll('input[data-testid="grade-input"]'));if(e.length===0)return null;let t=e.filter(a=>a.offsetParent!==null&&!a.disabled);if(t.length===0)return null;let r=t.filter(a=>a.closest('[data-testid="speedgrader-grading-panel"]')!==null),o=r.length>0?r:t,s=o.find(a=>a===document.activeElement);return s||o.reduce((a,i)=>{let c=i.getBoundingClientRect(),l=c.width*c.height,d=a.getBoundingClientRect(),u=d.width*d.height;return l>u?i:a},o[0])}function Rs(e){let t=()=>{let r=Is();if(!r){n.trace("[ScoreSync] Grade input not found for update");return}r.focus(),$s.call(r,String(e)),r.setAttribute("value",String(e)),r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0})),r.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",code:"Enter",bubbles:!0})),r.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",code:"Enter",bubbles:!0})),r.dispatchEvent(new Event("blur",{bubbles:!0})),r.dispatchEvent(new Event("focusout",{bubbles:!0}));let o=r.value;n.trace(`[ScoreSync] Applied value=${e}, read back value="${o}"`)};U.GRADE_INPUT_UPDATE_DELAYS.forEach(r=>{setTimeout(t,r)}),n.trace(`[ScoreSync] Grade input update scheduled for score: ${e}`)}async function Gs(e,t,r,o,s,a=U.SUBMIT_GRADE_MAX_RETRIES){var c;n.trace(`[ScoreSync] submitGrade called with score=${o}, retries=${a}`);let i=`/api/v1/courses/${e}/assignments/${t}/submissions/${r}`;for(let l=0;l<=a;l++)try{n.trace(`[ScoreSync] PUT ${i} (attempt ${l+1}/${a+1})`);let d=await s.put(i,{submission:{posted_grade:o.toString()}},{},`submitGrade:${r}`);n.trace("[ScoreSync] Response data:",d);let u=(c=d==null?void 0:d.entered_score)!=null?c:o;return n.info(`[ScoreSync] \u2705 Grade submitted successfully: ${u}`),d}catch(d){if(n.error(`[ScoreSync] Submit attempt ${l+1}/${a+1} failed:`,d),l<a){let u=1e3*(l+1);n.trace(`[ScoreSync] Retrying in ${u}ms...`),await new Promise(f=>setTimeout(f,u))}}return n.error("[ScoreSync] All submit attempts failed"),null}async function Ns(e,t,r){let o=new URLSearchParams;o.append("include[]","rubric_assessment");let s=`/api/v1/courses/${e}/assignments/${t}/submissions/${r}?${o.toString()}`;n.trace(`[ScoreSync] GET ${s}`);try{let a=await fetch(s,{credentials:"same-origin"});if(n.trace(`[ScoreSync] Fetch response status: ${a.status} ${a.statusText}`),!a.ok)return n.error(`[ScoreSync] Failed to fetch submission: ${a.status} ${a.statusText}`),null;let i=await a.json();if(n.trace(`[ScoreSync] Submission data: id=${i.id}, user_id=${i.user_id}, rubric_assessment=${!!i.rubric_assessment}`),i.rubric_assessment){let c=Object.keys(i.rubric_assessment).length;n.trace(`[ScoreSync] Rubric has ${c} criteria`)}return i}catch(a){return n.error("[ScoreSync] Exception in fetchSubmission:",a),null}}async function Ds(e,t,r,o){var s;if(n.info("[ScoreSync] ========== RUBRIC SUBMIT HANDLER CALLED =========="),n.trace(`[ScoreSync] Parameters: courseId=${e}, assignmentId=${t}, studentId=${r}`),ee){n.warn("[ScoreSync] Already processing another submission, skipping"),q.skipped++;return}ee=!0,q.attempts++,n.trace("[ScoreSync] Set inFlight=true");try{n.trace("[ScoreSync] Fetching settings...");let a=kn(e,t);if(n.trace(`[ScoreSync] Settings: enabled=${a.enabled}, method=${a.method}`),!a.enabled){n.info("[ScoreSync] SKIPPED - Score sync disabled for this assignment"),q.skipped++,ee=!1;return}n.trace("[ScoreSync] Waiting briefly for GraphQL commit, then polling rubric assessment...");let i=null;for(let h=0;h<U.RUBRIC_FETCH_DELAYS.length;h++){await new Promise(E=>setTimeout(E,U.RUBRIC_FETCH_DELAYS[h])),i=await Ns(e,t,r);let y=i==null?void 0:i.rubric_assessment;if(y&&Object.keys(y).length>0)break}if(n.trace("[ScoreSync] Fetching submission with rubric assessment complete"),!i){n.error("[ScoreSync] FAILED - fetchSubmission returned null"),q.failures++,ee=!1;return}if(n.trace(`[ScoreSync] Submission fetched: id=${i.id}, workflow_state=${i.workflow_state}`),n.trace(`[ScoreSync] Rubric assessment present: ${!!i.rubric_assessment}`),!i.rubric_assessment){n.warn("[ScoreSync] FAILED - No rubric assessment found in submission"),q.failures++,ee=!1;return}let c=Object.values(i.rubric_assessment).map(h=>h.points);n.trace(`[ScoreSync] Rubric points: [${c.join(", ")}]`);let l=xs(e,t,r),d=vs(i.rubric_assessment),u=Rn.get(l);if(n.trace(`[ScoreSync] Context: ${l}`),n.trace(`[ScoreSync] Current rubric fingerprint: ${d}`),n.trace(`[ScoreSync] Last fingerprint for context: ${u||"none"}`),d===u){n.info("[ScoreSync] SKIPPED - Rubric unchanged (fingerprint match - prevents duplicate submission)"),n.trace("[ScoreSync] This is likely a navigation event or Canvas fetching existing rubric data"),q.skipped++,ee=!1;return}n.trace("[ScoreSync] Fingerprint differs from last - this is a NEW or CHANGED rubric assessment"),Rn.set(l,d),n.trace("[ScoreSync] Fingerprint updated for context");let f=Ts(i.rubric_assessment,a.method);n.info(`[ScoreSync] Calculated score: ${f} (method: ${a.method})`),n.trace("[ScoreSync] Submitting grade to Canvas API...");let p=await Gs(e,t,r,f,o);if(!p){n.error("[ScoreSync] FAILED - submitGrade returned null"),q.failures++;return}n.trace(`[ScoreSync] Grade submission result: entered_score=${p.entered_score}, score=${p.score}, workflow_state=${p.workflow_state}`);let m=(s=p==null?void 0:p.entered_score)!=null?s:f;n.trace(`[ScoreSync] Updating UI with final score: ${m}`),Rs(m),Fs(m),q.successes++,n.info("[ScoreSync] \u2705 SCORE SYNC COMPLETE")}catch(a){n.error("[ScoreSync] ERROR in handleRubricSubmitInternal:",a),q.failures++}finally{ee=!1,n.trace("[ScoreSync] Set inFlight=false")}}async function Os(e,t,r,o){let s=new Promise((a,i)=>setTimeout(()=>i(new Error("Rubric submit handler timeout")),U.SUBMIT_GRADE_TIMEOUT));try{await Promise.race([Ds(e,t,r,o),s])}catch(a){n.error("[ScoreSync] Timeout or error in handleRubricSubmit:",a),q.failures++,ee=!1}}function Ls(e,t,r){return!e.includes("/api/graphql")||t!=="POST"?!1:/"operationName"\s*:\s*"[^"]*SaveRubricAssessment[^"]*"/i.test(r)||/mutation\s+\w*SaveRubricAssessment/i.test(r)}async function ks(e,t){if(typeof(t==null?void 0:t.body)=="string")return t.body;if(e instanceof Request)try{return await e.clone().text()}catch(r){n.trace(`[ScoreSync] Could not read Request body: ${r.message}`)}return""}function Us(){if(n.trace("[ScoreSync] Installing fetch hook..."),window.__CG_SCORESYNC_FETCH_HOOKED__){n.warn("[ScoreSync] Fetch hook already installed");return}window.__CG_SCORESYNC_FETCH_HOOKED__=!0;let e=window.fetch,t=0;window.fetch=async function(...r){let o=++t,s=r[0],a=r[1],i=s instanceof Request,c=i?s.url:String(s),l=(i?s.method:(a==null?void 0:a.method)||"GET").toUpperCase(),d=await e(...r);if(c.includes("/api/v1/")&&c.includes("/submissions/"))return d;if(d.ok&&c.includes("/api/graphql")&&l==="POST"){let u=await ks(s,a),f=u.match(/"operationName"\s*:\s*"([^"]+)"/),p=f?f[1]:"unknown";if(n.trace(`[ScoreSync] GraphQL operation: ${p}`),Ls(c,l,u)){n.info("[ScoreSync] \u2705 RUBRIC SUBMISSION DETECTED"),n.trace(`[ScoreSync] Call #${o}: Operation: ${p}`);let m=St();n.trace(`[ScoreSync] Call #${o}: Parsed IDs - courseId: ${m.courseId}, assignmentId: ${m.assignmentId}, studentId: ${m.studentId}`),m.courseId&&m.assignmentId&&m.studentId?(n.trace(`[ScoreSync] Call #${o}: Triggering handleRubricSubmit...`),Os(m.courseId,m.assignmentId,m.studentId,ht)):n.warn(`[ScoreSync] Call #${o}: Missing IDs, cannot handle rubric submit`)}}return d},n.info("[ScoreSync] \u2705 Fetch hook installed successfully")}function Fs(e){let t=document.querySelector("[data-cg-assignment-score]");t&&(t.textContent=e)}function Un(e,t){try{n.trace("[ScoreSync] createUIControls called"),n.trace('[ScoreSync] Looking for Canvas flex container: span[dir="ltr"][wrap="wrap"]');let r=document.querySelector('span[dir="ltr"][wrap="wrap"][direction="row"]');if(!r){if(n.trace("[ScoreSync] Flex container not found, trying fallback selector"),!document.querySelector("span.css-jf6rsx-view--flex-flex"))return n.trace("[ScoreSync] Canvas flex container not found in DOM"),!1;n.trace("[ScoreSync] Found flex container via fallback selector")}let o=r||document.querySelector("span.css-jf6rsx-view--flex-flex"),s=document.querySelector("[data-cg-scoresync-ui]");s&&(n.trace("[ScoreSync] Removing existing UI controls before re-creation"),s.remove()),n.trace("[ScoreSync] Canvas flex container found, creating UI controls");let a=kn(e,t);n.trace(`[ScoreSync] Settings loaded: enabled=${a.enabled}, method=${a.method}`);let i=document.createElement("div");i.setAttribute("data-cg-scoresync-ui","true"),i.setAttribute("data-cg-enabled",a.enabled?"true":"false"),i.style.cssText=`
            display: inline-flex;
            align-items: stretch;
            gap: 0.75rem;
            margin-left: 0.75rem;
            padding-left: 0.75rem;
            padding-right: 0;
            height: 3rem;
            border-radius: 0.35rem;
            background: ${Ve.CONTAINER_BG};
            border: 1px solid ${Ve.CONTAINER_BORDER};
            flex-shrink: 0;
            font: inherit;
            color: inherit;
            transition: opacity 0.2s ease;
            opacity: ${a.enabled?"1":"0.6"};
            overflow: hidden;
        `,i.innerHTML=`
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0; white-space: nowrap;">
                <input type="checkbox" data-cg-toggle ${a.enabled?"checked":""}
                       style="margin: 0; transform: scale(1.25); transform-origin: center; cursor: pointer;">
                <span style="font-weight: 600;">Score Sync</span>
            </label>
            <select class="ic-Input" data-cg-method ${a.enabled?"":"disabled"}
                    style="width: auto; min-width: 4rem; height: 2.375rem; min-height: 2.375rem; padding-top: 0.25rem; padding-bottom: 0.25rem; align-self: center;">
                <option value="min" ${a.method==="min"?"selected":""}>MIN</option>
                <option value="avg" ${a.method==="avg"?"selected":""}>AVG</option>
                <option value="max" ${a.method==="max"?"selected":""}>MAX</option>
                <option value="sum" ${a.method==="sum"?"selected":""}>SUM</option>
            </select>
            <div style="display: flex; height: 100%; flex-shrink: 0; margin: 0;">
                <div style="display: flex; align-items: center; padding-left: 0.75rem; padding-right: 0.75rem; height: 100%; background-color: ${Ve.LABEL_BG};">
                    <span style="font-weight: 600; white-space: nowrap;">Assignment Score</span>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; padding: 0 0.75rem; height: 100%; background-color: ${Ve.SCORE_BG};">
                    <span style="color: #fff; font-weight: 700; white-space: nowrap;"><span data-cg-assignment-score>--</span> pts</span>
                </div>
            </div>
        `;let c=i.querySelector("[data-cg-toggle]"),l=i.querySelector("[data-cg-method]");return c.addEventListener("change",()=>{a.enabled=c.checked,On(e,t,a),i.setAttribute("data-cg-enabled",a.enabled?"true":"false"),i.style.opacity=a.enabled?"1":"0.6",l.disabled=!a.enabled,l.style.cursor=a.enabled?"pointer":"not-allowed",n.info(`[ScoreSync] Score sync ${a.enabled?"enabled":"disabled"}`)}),l.addEventListener("change",()=>{a.method=l.value,On(e,t,a),n.info(`[ScoreSync] Method changed to: ${a.method}`)}),n.trace("[ScoreSync] Appending UI container as flex item"),o.appendChild(i),n.info("[ScoreSync] \u2705 UI controls created and inserted into DOM"),!0}catch(r){return n.error("[ScoreSync] Failed to create UI controls:",r),!1}}function bt(){let{courseId:e,assignmentId:t}=St();if(!e||!t){n.trace("[ScoreSync] Cannot ensure UI: missing IDs");return}if(document.querySelector("[data-cg-scoresync-ui]"))return;Un(e,t)?n.info(`[ScoreSync] UI re-injected for course=${e}, assignment=${t}`):n.warn("[ScoreSync] Failed to re-inject UI (container not found)")}function gt(){setTimeout(()=>void bt(),0),setTimeout(()=>void bt(),U.NAVIGATION_RECHECK_DELAY)}function qe(){ue&&clearInterval(ue),ue=setInterval(()=>void bt(),U.UI_KEEPALIVE_INTERVAL),n.trace(`[ScoreSync] Temporary UI keepalive started (${U.UI_KEEPALIVE_INTERVAL}ms checks for ${U.UI_KEEPALIVE_DURATION}ms)`),setTimeout(()=>{ue&&(clearInterval(ue),ue=null,n.trace("[ScoreSync] Temporary UI keepalive stopped (duration expired)"))},U.UI_KEEPALIVE_DURATION)}function Ms(){if(window.__CG_SCORESYNC_HISTORY_HOOKED__)return;window.__CG_SCORESYNC_HISTORY_HOOKED__=!0;let e=history.pushState,t=history.replaceState;history.pushState=function(...r){e.apply(this,r),gt(),qe()},history.replaceState=function(...r){t.apply(this,r),gt(),qe()},window.addEventListener("popstate",()=>{gt(),qe()}),n.trace("[ScoreSync] History API hooks installed")}async function Fn(){var a;if(n.info("[ScoreSync] ========== INITIALIZATION STARTED =========="),ft){n.warn("[ScoreSync] Already initialized, skipping");return}ft=!0,n.trace("[ScoreSync] Initializing SpeedGrader score sync module");let e=j();if(n.trace(`[ScoreSync] User role group: ${e}`),e!=="teacher_like"){n.info(`[ScoreSync] SKIPPED - user is ${e}, not teacher_like`);return}let{courseId:t,assignmentId:r,studentId:o}=await _s();if(!t||!r||!o){n.error("[ScoreSync] FAILED - Missing required IDs after retries:",{courseId:t,assignmentId:r,studentId:o}),n.error("[ScoreSync] Full URL:",window.location.href),n.error("[ScoreSync] Query params:",window.location.search),ft=!1;return}n.trace("[ScoreSync] Creating CanvasApiClient..."),ht=new C,n.trace("[ScoreSync] CanvasApiClient created successfully");let s=G(t);if(n.trace(`[ScoreSync] Course snapshot from cache: ${s?"FOUND":"NOT FOUND"}`),!s){n.trace("[ScoreSync] Populating course snapshot...");let i=((a=document.title.split(":")[0])==null?void 0:a.trim())||"Unknown Course";n.trace(`[ScoreSync] Course name from title: "${i}"`),s=await D(t,i,ht),n.trace(`[ScoreSync] Snapshot population result: ${s?"SUCCESS":"FAILED"}`)}if(!s){n.error("[ScoreSync] FAILED - Could not get course snapshot");return}if(n.info(`[ScoreSync] Course model: ${s.model} (reason: ${s.modelReason})`),s.model!=="standards"){n.info(`[ScoreSync] SKIPPED - course is ${s.model}, not standards-based`);return}n.info("[ScoreSync] \u2705 Course is standards-based, proceeding with initialization"),n.trace("[ScoreSync] Installing fetch hook..."),Us(),n.trace("[ScoreSync] Installing history API hooks..."),Ms(),As.UI_KEEPALIVE_ENABLED&&(n.trace("[ScoreSync] Starting temporary UI keepalive..."),qe()),n.trace("[ScoreSync] Attempting immediate UI creation..."),Un(t,r),n.info("[ScoreSync] ========== INITIALIZATION COMPLETE ==========")}var yt=!1;function Ps(){return document.querySelector('li[aria-controls="assignments"]')}function Bs(){return document.querySelector('li[aria-controls="outcomes"] a[href="#outcomes"]')}function Vs(){return document.querySelector("#right-side-wrapper")||document.querySelector("#right-side")}function Pn(e=20,t=250){let r=Ps();return r?(r.remove(),n.debug("Assignments tab removed"),!0):(e>0?setTimeout(()=>Pn(e-1,t),t):n.trace("Assignments tab not found after retries"),!1)}function Bn(){location.hash!=="#tab-outcomes"&&(history.replaceState(null,"",location.pathname+location.search+"#tab-outcomes"),window.dispatchEvent(new HashChangeEvent("hashchange")));let e=Bs();e?e.click():setTimeout(Bn,300)}function qs(e){let{score:t,letterGrade:r}=e,o=Vs();if(!o){n.trace("Right sidebar not found; deferring...");return}let s=o.querySelector(".student_assignment.final_grade");if(!s){n.trace("Final grade element (.student_assignment.final_grade) not found in sidebar; deferring...");return}if(o.dataset.processed){let l=s.querySelector(".grade"),d=s.querySelector(".letter_grade");l&&(l.textContent=typeof t=="number"?t.toFixed(2):String(t)),d&&r&&(d.textContent=r),n.trace("Grade display updated in existing sidebar");return}let a=s.querySelector(".grade"),i=s.querySelector(".letter_grade");a&&(a.textContent=typeof t=="number"?t.toFixed(2):String(t)),i&&r&&(i.textContent=r),o.dataset.processed="true";let c=ne(t,r);n.debug(`Sidebar grade updated to: ${c}`)}function zs(e){let{score:t,letterGrade:r}=e,o=ne(t,r);document.querySelectorAll("tr.student_assignment.hard_coded.final_grade").forEach(s=>{let a=s.querySelector(".assignment_score .tooltip .grade"),i=s.querySelector(".details .possible.points_possible");if(a&&a.textContent!==o&&(a.textContent=o,a.dataset.normalized="true"),i){let c=i.textContent.trim();/^\d+(\.\d+)?\s*\/\s*\d+(\.\d+)?$/.test(c)&&(i.textContent="")}}),n.debug(`Bottom grade row updated to: ${o}`)}function Hs(e){return yt?!1:(Ar&&(Pn(),Bn()),qs(e),zs(e),yt=!0,!0)}async function Mn(){var s,a;if(yt)return!0;let e=x();if(!e)return n.warn("Cannot get course ID from URL"),!1;let t=((a=(s=document.querySelector(".course-title, h1, #breadcrumbs li:last-child"))==null?void 0:s.textContent)==null?void 0:a.trim())||"Course",r=G(e);if(!r||Ee(e,Q.COURSE_GRADES)){n.trace(`Fetching grade data from API for course ${e}...`);let i=new C;r=await Fe(e,t,i,Q.COURSE_GRADES)}if(!r)return n.trace("No grade data available from snapshot"),!1;if(r.model!=="standards")return n.debug(`Skipping grade page customization - course is ${r.model} (reason: ${r.modelReason})`),!1;let o={score:r.displayScore,letterGrade:r.displayLetterGrade};return n.trace(`Using display grade data from snapshot: score=${o.score}, letterGrade=${o.letterGrade}, type=${r.displayType}`),Hs(o)}async function Vn(){n.debug("Initializing grade page customizer"),await Mn()||wn(async()=>{let t=await Mn();return t&&n.debug("Student grade customization applied after DOM updates"),t},{timeout:3e4,config:O.CHILD_LIST_AND_ATTRIBUTES,target:document.body,name:"GradePageCustomizer"})}var Et=!1;async function js(e){var t;try{let r=await e.get("/api/v1/courses?enrollment_state=active&include[]=total_scores",{},"fetchActiveCourses");n.trace(`[All-Grades] Raw courses response: ${(r==null?void 0:r.length)||0} courses`),n.isTraceEnabled()&&r&&r.length>0&&(n.trace("[All-Grades] First course structure:",r[0]),n.trace("[All-Grades] First course enrollments:",r[0].enrollments));let s=r.filter(a=>{let i=a.enrollments||[],c=i.some(l=>l.type==="student"||l.type==="StudentEnrollment"||l.role==="StudentEnrollment");return n.isTraceEnabled()&&i.length>0&&n.trace(`[All-Grades] Course ${a.id} (${a.name}): enrollments =`,i.map(l=>l.type)),c}).map(a=>{let c=(a.enrollments||[]).find(l=>l.type==="student"||l.type==="StudentEnrollment"||l.role==="StudentEnrollment");return{id:String(a.id),name:a.name,enrollmentData:c||null}});if(n.info(`[All-Grades] Found ${s.length} active student courses out of ${r.length} total courses`),n.isTraceEnabled()&&s.length>0){let a=s[0];n.trace("[All-Grades] First course enrollment data:",a.enrollmentData),(t=a.enrollmentData)!=null&&t.grades&&n.trace("[All-Grades] First course grades object:",a.enrollmentData.grades)}return s}catch(r){return n.error("[All-Grades] Failed to fetch active courses:",r),[]}}async function Ys(e,t){let r=performance.now(),o=e.map(async a=>{let{id:i,name:c}=a,l=Ee(i,Q.ALL_GRADES),d=G(i);if((!d||l)&&(n.trace(`[All-Grades] ${d?"Refreshing":"Populating"} snapshot for course ${i}...`),d=await Fe(i,c,t,Q.ALL_GRADES)),!d)return n.trace(`[All-Grades] No snapshot available for course ${i}, skipping`),null;let u=d.displayScore,f=d.displayLetterGrade,p=d.displayType,m=d.isStandardsBased;return n.trace(`[All-Grades] Course "${c}" (${i}): displayScore=${u}, displayType=${p}, displayLetterGrade=${f}, isStandardsBased=${m}`),{courseId:i,courseName:c,courseUrl:`/courses/${i}/grades`,displayScore:u,displayLetterGrade:f,displayType:p,isStandardsBased:m,gradeSource:d.gradeSource}}),s=(await Promise.all(o)).filter(a=>a!==null);return n.trace(`[All-Grades] Enriched ${s.length} courses in ${(performance.now()-r).toFixed(2)}ms`),s}async function Ks(){let e=performance.now(),t=new C;try{n.trace("[All-Grades] Step 1: Fetching active courses from API...");let r=await js(t);if(r.length===0)return n.warn("[All-Grades] No active student courses found"),[];n.trace(`[All-Grades] Found ${r.length} active student courses`),n.trace("[All-Grades] Step 2: Enriching courses with snapshots...");let o=await Ys(r,t);n.trace(`[All-Grades] Total processing time: ${(performance.now()-e).toFixed(2)}ms`);let s=o.filter(u=>u.displayScore!==null).length,a=o.length-s,i=o.filter(u=>u.gradeSource==="enrollment").length,c=o.filter(u=>u.gradeSource==="snapshot").length,l=o.filter(u=>u.isStandardsBased).length,d=o.length-l;return n.debug(`[All-Grades] Processed ${o.length} courses: ${l} standards-based, ${d} traditional`),n.debug(`[All-Grades] Grade sources: ${i} from enrollment, ${c} from snapshot`),n.isTraceEnabled()&&(n.trace("[All-Grades] Course breakdown:"),o.forEach(u=>{let f=u.isStandardsBased?"SBG":"TRAD",p=u.displayScore!==null?u.isStandardsBased?`${u.displayScore.toFixed(2)} (${u.displayLetterGrade||"N/A"})`:`${u.displayScore.toFixed(2)}%`:"N/A";n.trace(`  [${f}] ${u.courseName}: ${p}`)})),o}catch(r){throw n.error("[All-Grades] Failed to fetch course grades:",r),r}}function Ws(e){let t=document.createElement("table");t.className="ic-Table ic-Table--hover-row ic-Table--striped customized-grades-table",t.style.cssText="width: 100%; margin-top: 1rem;";let r=document.createElement("thead");r.innerHTML=`
        <tr>
            <th class="ic-Table-header" style="text-align: left; padding: 0.75rem;">Course</th>
            <th class="ic-Table-header" style="text-align: right; padding: 0.75rem;">Grade</th>
        </tr>
    `,t.appendChild(r);let o=document.createElement("tbody");for(let s of e){let a=document.createElement("tr");a.className="ic-Table-row";let i=document.createElement("td");i.className="ic-Table-cell",i.style.padding="0.75rem";let c=document.createElement("a");c.href=s.courseUrl,c.textContent=s.courseName,c.style.cssText="color: #0374B5; text-decoration: none;",c.addEventListener("mouseenter",()=>{c.style.textDecoration="underline"}),c.addEventListener("mouseleave",()=>{c.style.textDecoration="none"}),i.appendChild(c);let l=document.createElement("td");l.className="ic-Table-cell",l.style.cssText="text-align: right; padding: 0.75rem; font-weight: bold;",s.displayScore!==null?s.displayType==="points"?(l.textContent=ne(s.displayScore,s.displayLetterGrade),l.style.color="#0B874B",n.trace(`[Table] ${s.courseName}: Rendering as SBG (${s.displayScore.toFixed(2)} ${s.displayLetterGrade})`)):(l.textContent=`${s.displayScore.toFixed(2)}%`,l.style.color="#2D3B45",n.trace(`[Table] ${s.courseName}: Rendering as traditional (${s.displayScore.toFixed(2)}%)`)):(l.textContent="N/A",l.style.color="#73818C",n.trace(`[Table] ${s.courseName}: No grade available`)),n.trace(`[Table] ${s.courseName} details: isStandardsBased=${s.isStandardsBased}, displayType=${s.displayType}, displayScore=${s.displayScore}`),a.appendChild(i),a.appendChild(l),o.appendChild(a)}return t.appendChild(o),t}function Js(e){let t=document.querySelector("table.course_details.student_grades");if(!t){n.warn("Original grades table not found");return}let r=document.getElementById("customized-grades-table");r&&(n.debug("Removing existing customized table to prevent duplicates"),r.remove()),t.style.display="none",t.dataset.customized="true";let o=Ws(e);o.id="customized-grades-table",t.parentNode.insertBefore(o,t.nextSibling),n.info(`Replaced grades table with ${e.length} courses`)}async function qn(){if(Et){n.debug("All-grades customizations already applied");return}try{n.info("Applying all-grades page customizations...");let e=await Ks();if(e.length===0){n.warn("No courses found, skipping customization");return}Js(e);let t=e.filter(o=>o.isStandardsBased).length,r=e.length-t;n.info(`All-grades customization complete: ${e.length} courses (${t} SBG, ${r} traditional)`),Et=!0,document.body.classList.remove("cg_processing_grades")}catch(e){n.error("Failed to apply all-grades customizations:",e),document.body.classList.remove("cg_processing_grades")}}function zn(){n.debug("Initializing all-grades page customizer"),qn(),V(()=>{let e=document.querySelector("table.course_details.student_grades");e&&!e.dataset.customized&&!Et&&(n.debug("Grades table detected, applying customizations..."),qn())},{config:O.CHILD_LIST,target:document.body,name:"AllGradesPageCustomizer"})}async function pe(){document.querySelectorAll(".score-display").forEach(e=>{let t=e.innerHTML,r=t.replace(/<\/b>\s*\/\s*\d+(\.\d+)?\s*pts/i,"</b>");t!==r&&(e.innerHTML=r)}),document.querySelectorAll("span.tooltip").forEach(e=>{Array.from(e.children).forEach(t=>{t.childNodes.length===1&&t.childNodes[0].nodeType===Node.TEXT_NODE&&/^\/\s*\d+(\.\d+)?$/.test(t.textContent.trim())&&t.remove()})}),document.querySelectorAll("span.grade").forEach(e=>{if(e.dataset.normalized==="true")return;let t=e.textContent.trim();if(/\([^)]+\)/.test(t))return;let r=t.match(/^(\d+(?:\.\d+)?)\s*\/\s*\d+(?:\.\d+)?$/);r&&(e.textContent=r[1])}),document.querySelectorAll("span, div, td").forEach(e=>{e.childNodes.length===1&&e.childNodes[0].nodeType===Node.TEXT_NODE&&/\/\s*\d+(\.\d+)?\s*pts/i.test(e.textContent)&&(e.textContent=e.textContent.replace(/\/\s*\d+(\.\d+)?\s*pts/gi,""))}),document.querySelectorAll(".screenreader-only").forEach(e=>{let t=e.textContent,r=t.replace(/out of\s*\d+(\.\d+)?\s*points?\.?/i,"").trim();t!==r&&(e.textContent=r)}),document.querySelectorAll("span.css-1jyml41-text").forEach(e=>{let r=e.textContent.trim().match(/^(\d+(\.\d+)?)[/]\s*\d+(\.\d+)?$/);r&&(e.textContent=r[1])}),document.querySelectorAll("span.points-value strong").forEach(e=>{let r=e.textContent.trim().match(/^(\d+(\.\d+)?)[/]\s*\d+(\.\d+)?$/);r&&(e.textContent=r[1])}),document.querySelectorAll("span.css-7cbhck-text").forEach(e=>{let r=e.textContent.trim().match(/^(\d+(\.\d+)?)[/]\s*\d+(\.\d+)?$/);r&&(e.textContent=r[1])}),document.querySelectorAll('a[data-track-category="dashboard"][data-track-label="recent feedback"]').forEach(e=>{let t=e.querySelector(".recent_feedback_title"),r=e.querySelector(".event-details strong");if(!t||!r)return;let o=t.textContent.trim().replace(/\s+/g," ").toLowerCase(),s=_.trim().replace(/\s+/g," ").toLowerCase();if(o!==s)return;let i=r.textContent.trim().match(/^(\d+(\.\d+)?)\s+out of\s+\d+(\.\d+)?$/i);i&&(r.textContent=i[1])}),Xs()}function Xs(){document.querySelectorAll("tr.student_assignment.hard_coded.group_total").forEach(e=>{let t=e.querySelector(".assignment_score .tooltip .grade");if(t){let o=t.textContent.trim();/^\d+(\.\d+)?%?$/.test(o)&&(t.textContent="")}let r=e.querySelector(".details .possible.points_possible");if(r){let o=r.textContent.trim();/^\d+(\.\d+)?\s*\/\s*\d+(\.\d+)?$/.test(o)&&(r.textContent="")}})}function Ct(){return be()||on()}function Hn(){n.debug("Starting cleanup observers for grade normalization"),Ct()&&pe().catch(t=>{n.warn("Error in initial removeFractionScores:",t)});let e=he(()=>{Ct()&&pe().catch(t=>{n.warn("Error in removeFractionScores:",t)})},100);setTimeout(()=>{Ct()&&V(()=>{e()},{config:O.CHILD_LIST,target:document.body,name:"GradeCleanupObserver"});let t=location.href;setInterval(()=>{location.href!==t&&(t=location.href,e())},1e3)},0)}async function wt(e=0,t=5){if(le()){n.trace("Skipping cleanup observers on all-grades page (no course context)");return}if(be())n.debug("Initializing cleanup observers for dashboard"),Hn();else{let r=x();if(!r){n.trace("Skipping cleanup observers - no course ID");return}let o=G(r);if(!o){if(e<t){let s=Math.min(1e3,200*Math.pow(1.5,e));n.trace(`No snapshot available yet, retrying in ${s}ms (attempt ${e+1}/${t})...`),setTimeout(async()=>{await wt(e+1,t)},s)}else n.trace("Skipping cleanup observers - no snapshot available after max retries");return}if(o.model!=="standards"){n.debug(`Skipping fraction cleanup \u2014 course is ${o.model} (reason: ${o.modelReason})`);return}n.debug("Initializing cleanup observers for standards-based course page"),Hn()}}async function jn(){if(!wr){n.debug("Student grade customization disabled");return}if(j()!=="student_like"){n.debug("User is not student-like, skipping student customizations");return}n.info("Initializing student grade customizations"),le()?(n.debug("On all-grades page, initializing all-grades customizer"),zn()):Le()&&(n.debug("On single-course grades page, initializing grade page customizer"),await Vn()),await wt()}function Yn(e){var o;let t=typeof e=="string"?parseFloat(e):e;if(isNaN(t))return n.trace(`Invalid score for grade level conversion: ${e}`),null;let r=[...W].sort((s,a)=>a.points-s.points);for(let s of r)if(t>=s.points)return s.description;return((o=r[r.length-1])==null?void 0:o.description)||null}var At=!1,me=null,Kn=!1;async function Qs(e,t,r){var o,s;n.trace(`[Teacher] fetchStudentAvgScore: courseId=${e}, studentId=${t}`);try{n.trace(`[Teacher] Searching for AVG assignment "${_}"...`);let a=await r.get(`/api/v1/courses/${e}/assignments?search_term=${encodeURIComponent(_)}`,{},"fetchAvgAssignment");n.trace(`[Teacher] Found ${(a==null?void 0:a.length)||0} assignments matching "${_}"`);let i=a==null?void 0:a.find(u=>u.name===_);if(!i)return n.warn(`[Teacher] AVG assignment "${_}" not found in course ${e}`),null;n.trace(`[Teacher] Found AVG assignment: id=${i.id}, name="${i.name}"`),n.trace(`[Teacher] Fetching submission for student ${t}, assignment ${i.id}...`);let c=await r.get(`/api/v1/courses/${e}/assignments/${i.id}/submissions/${t}`,{},"fetchAvgSubmission");n.trace("[Teacher] Submission fetched",{courseId:e,studentId:t,assignmentId:i.id,score:c==null?void 0:c.score,grade:c==null?void 0:c.grade,workflow_state:c==null?void 0:c.workflow_state});let l=c==null?void 0:c.score;if(l==null)return n.warn(`[Teacher] No score found in AVG assignment submission for student ${t}`),null;n.trace(`[Teacher] Student score found: ${l}`);let d=(s=(o=c==null?void 0:c.grade)!=null?o:c==null?void 0:c.entered_grade)!=null?s:null;return!d||!isNaN(parseFloat(d))?(n.trace(`[Teacher] No valid letter grade from submission API (got: ${d}), calculating from score...`),d=Yn(l),d&&n.trace(`[Teacher] Calculated letter grade from score ${l}: "${d}"`)):n.trace(`[Teacher] Letter grade from submission API: "${d}"`),n.debug(`[Teacher] \u2705 Student ${t} AVG score: ${l}, letter grade: ${d}`),{score:l,letterGrade:d}}catch(a){return n.warn("[Teacher] \u274C Failed to fetch student AVG score:",a.message),null}}function Wn(e){let{score:t,letterGrade:r}=e,o=ne(t,r);n.trace(`updateFinalGradeRow called with score=${t}, letterGrade=${r}, displayValue="${o}"`);let s=[...document.querySelectorAll("tr.student_assignment.hard_coded.final_grade"),...document.querySelectorAll("tr.student_assignment.final_grade"),...document.querySelectorAll("tr.final_grade")];if(s.length===0){n.trace("No final grade rows found");return}n.trace(`Found ${s.length} final grade row(s)`),s.forEach((a,i)=>{let c=a.querySelector(".assignment_score .tooltip .grade")||a.querySelector(".assignment_score .grade")||a.querySelector(".tooltip .grade")||a.querySelector(".grade");if(c){let d=c.textContent.trim();d!==o?(c.textContent=o,c.dataset.normalized="true",n.trace(`Updated final grade row ${i}: "${d}" -> "${o}"`)):n.trace(`Final grade row ${i} already has correct value: "${d}"`)}else n.trace(`Final grade row ${i}: grade element not found`);let l=a.querySelector(".details .possible.points_possible");if(l){let d=l.textContent.trim();/^\d+(\.\d+)?\s*\/\s*\d+(\.\d+)?$/.test(d)&&(l.textContent="")}}),n.debug(`Final grade row updated to: ${o}`)}function Jn(e){let{score:t,letterGrade:r}=e,o=typeof t=="number"?t.toFixed(2):String(t),s=document.querySelector("#right-side-wrapper")||document.querySelector("#right-side");if(!s){n.trace("Right sidebar not found");return}let a=s.querySelector(".student_assignment.final_grade");if(!a){n.trace("Final grade element not found in sidebar");return}let i=a.querySelector(".grade");if(i){let l=i.textContent.trim();(l.includes("/")||l!==o)&&(i.textContent=o,n.trace(`Updated sidebar grade: "${l}" -> "${o}"`))}let c=a.querySelector(".letter_grade");if(c&&r){let l=c.textContent.trim();l!==r&&(c.textContent=r,n.trace(`Updated sidebar letter grade: "${l}" -> "${r}"`))}n.debug(`Sidebar grade updated to: ${o} (${r})`)}function Xn(e,t=0){if(At)return!0;let r=10,o=200,s=document.querySelector("tr.student_assignment.hard_coded.final_grade")!==null,a=(document.querySelector("#right-side-wrapper")||document.querySelector("#right-side"))!==null;return!s||!a?t<r?(n.trace(`DOM not ready (retry ${t+1}/${r}), waiting...`),setTimeout(()=>Xn(e,t+1),o),!1):(n.warn("DOM elements not found after max retries"),!1):(n.trace(`Applying customizations with gradeData: score=${e.score}, letterGrade=${e.letterGrade}`),Wn(e),Jn(e),At=!0,n.debug("Teacher student grade customizations applied successfully"),!0)}function we(e=null){n.debug("Starting cleanup observers for teacher student grade page"),pe().catch(o=>{n.warn("Error in initial removeFractionScores:",o)});let t=he(()=>{pe().catch(o=>{n.warn("Error in removeFractionScores:",o)})},100),r=null;e&&(r=he(()=>{Wn(e),Jn(e)},150)),setTimeout(()=>{V(()=>{t(),r&&r()},{config:O.CHILD_LIST,target:document.body,name:"TeacherStudentGradeCleanupObserver"})},0)}async function $t(){var i,c;n.debug("[Teacher] Initializing teacher student grade page customizer");let e=x(),t=ke();if(!e||!t){n.trace("[Teacher] Cannot get course ID or student ID from URL"),we();return}me&&me!==t&&(n.debug(`[Teacher] Student ID changed from ${me} to ${t}, resetting customizations`),At=!1),me=t,n.debug(`[Teacher] Teacher viewing student ${t} grades for course ${e}`);let r=((c=(i=document.querySelector(".course-title, h1, #breadcrumbs li:last-child"))==null?void 0:i.textContent)==null?void 0:c.trim())||"Course",o=new C,s=G(e);if(s||(n.debug(`[Teacher] No snapshot for course ${e}, populating snapshot...`),s=await D(e,r,o)),!s){n.warn(`[Teacher] Failed to create snapshot for course ${e}`),we();return}if(n.debug(`[Teacher] Course ${e} snapshot: model=${s.model}, reason=${s.modelReason}`),s.model!=="standards"){n.debug(`[Teacher] Skipping teacher student grade customization - course is ${s.model}`),we();return}n.debug(`[Teacher] Fetching AVG assignment score for student ${t}...`);let a=await Qs(e,t,o);if(!a){n.warn(`[Teacher] \u274C No AVG assignment score found for student ${t} - skipping grade customizations`),we();return}n.debug(`[Teacher] \u2705 Applying teacher student grade customizations for student ${t}: score=${a.score}, letterGrade=${a.letterGrade}`),Xn(a),we(a),Zs()}function Zs(){if(Kn){n.trace("[Teacher] URL change detection already set up, skipping");return}Kn=!0,n.debug("[Teacher] Setting up URL change detection for student navigation");let e=location.href;setInterval(()=>{if(location.href!==e){let t=ke();t&&t!==me?(n.debug(`[Teacher] URL changed, detected new student: ${t} (was: ${me})`),e=location.href,$t()):e=location.href}},1e3)}async function ea(){let e=performance.now(),t={approach:"DOM Parsing + Individual API Calls",courses:[],errors:[],metrics:{}};try{let o=gn();if(o.length===0)throw new Error("Grades table not found or has no rows");n.info(`[DOM Approach] Found ${o.length} course rows`);let s=new C,a=[];for(let c of o)a.push(ta(c,s));let i=await Promise.allSettled(a);for(let c of i)c.status==="fulfilled"&&c.value?t.courses.push(c.value):c.status==="rejected"&&t.errors.push(c.reason.message)}catch(o){t.errors.push(o.message),n.error("[DOM Approach] Fatal error:",o)}let r=performance.now();return t.metrics={totalTime:r-e,coursesFound:t.courses.length,errorCount:t.errors.length,avgTimePerCourse:t.courses.length>0?(r-e)/t.courses.length:0},t}async function ta(e,t){let r=fn(e);if(!r)return null;let{courseId:o,courseName:s,percentage:a}=r,i=performance.now(),c=await Qn(o,s,t),l=performance.now()-i;return{courseId:o,courseName:s,percentage:a,isStandardsBased:c,detectionTime:l,source:"DOM"}}async function ra(){let e=performance.now(),t={approach:"Enrollments API",courses:[],errors:[],metrics:{}};try{let o=new C,s=performance.now(),a=new URLSearchParams;a.append("type[]","StudentEnrollment"),a.append("state[]","active"),a.append("include[]","total_scores");let i=await o.get(`/api/v1/users/self/enrollments?${a.toString()}`,{},"testEnrollmentsAPI"),c=performance.now()-s;n.info(`[API Approach] Fetched ${i.length} enrollments in ${c.toFixed(2)}ms`);let l=i.map(u=>na(u,o)),d=await Promise.allSettled(l);for(let u of d)u.status==="fulfilled"&&u.value?t.courses.push(u.value):u.status==="rejected"&&t.errors.push(u.reason.message)}catch(o){t.errors.push(o.message),n.error("[API Approach] Fatal error:",o)}let r=performance.now();return t.metrics={totalTime:r-e,coursesFound:t.courses.length,errorCount:t.errors.length,avgTimePerCourse:t.courses.length>0?(r-e)/t.courses.length:0},t}async function na(e,t){var d,u,f,p,m,h;let r=(d=e.course_id)==null?void 0:d.toString();if(!r)return null;let o=e.grades||{},s=(f=(u=o.current_score)!=null?u:o.final_score)!=null?f:null,a=(p=e.course)==null?void 0:p.name;if(!a)try{a=(await t.get(`/api/v1/courses/${r}`,{},"getCourseDetails")).name}catch(y){n.warn(`[API Approach] Could not fetch course name for ${r}:`,y.message),a=`Course ${r}`}let i=performance.now(),c=await Qn(r,a,t),l=performance.now()-i;return{courseId:r,courseName:a,percentage:s,isStandardsBased:c,detectionTime:l,source:"API",letterGrade:(h=(m=o.current_grade)!=null?m:o.final_grade)!=null?h:null}}async function Qn(e,t,r){return(await Oe({courseId:e,courseName:t},null,{apiClient:r})).model==="standards"}async function oa(){n.info("=".repeat(80)),n.info("ALL-GRADES PAGE DATA SOURCE COMPARISON TEST"),n.info("=".repeat(80)),n.info(`
\u{1F4CA} Running DOM Parsing Approach...`);let e=await ea();n.info(`
\u{1F4CA} Running Enrollments API Approach...`);let t=await ra();n.info(`
`+"=".repeat(80)),n.info("COMPARISON RESULTS"),n.info("=".repeat(80)),console.table([{Approach:e.approach,"Total Time (ms)":e.metrics.totalTime.toFixed(2),"Courses Found":e.metrics.coursesFound,Errors:e.metrics.errorCount,"Avg Time/Course (ms)":e.metrics.avgTimePerCourse.toFixed(2)},{Approach:t.approach,"Total Time (ms)":t.metrics.totalTime.toFixed(2),"Courses Found":t.metrics.coursesFound,Errors:t.metrics.errorCount,"Avg Time/Course (ms)":t.metrics.avgTimePerCourse.toFixed(2)}]),n.info(`
\u{1F4CB} Course Details (DOM Approach):`),console.table(e.courses.map(o=>({"Course ID":o.courseId,"Course Name":o.courseName.substring(0,40),Percentage:o.percentage,"Standards-Based":o.isStandardsBased,"Detection Time (ms)":o.detectionTime.toFixed(2)}))),n.info(`
\u{1F4CB} Course Details (API Approach):`),console.table(t.courses.map(o=>({"Course ID":o.courseId,"Course Name":o.courseName.substring(0,40),Percentage:o.percentage,"Standards-Based":o.isStandardsBased,"Letter Grade":o.letterGrade,"Detection Time (ms)":o.detectionTime.toFixed(2)}))),n.info(`
`+"=".repeat(80)),n.info("RECOMMENDATION"),n.info("=".repeat(80));let r=sa(e,t);return n.info(r),{domResults:e,apiResults:t,recommendation:r}}function sa(e,t){let r=e.metrics.totalTime-t.metrics.totalTime,o=r/e.metrics.totalTime*100,s="";return t.metrics.totalTime<e.metrics.totalTime?(s+=`\u2705 RECOMMENDED: Enrollments API Approach

`,s+=`Reasons:
`,s+=`- Faster by ${Math.abs(r).toFixed(2)}ms (${Math.abs(o).toFixed(1)}%)
`,s+=`- More reliable (single API call for initial data)
`,s+=`- Provides letter grades directly from Canvas
`,s+=`- Less dependent on DOM structure
`):(s+=`\u2705 RECOMMENDED: DOM Parsing Approach

`,s+=`Reasons:
`,s+=`- Faster by ${Math.abs(r).toFixed(2)}ms (${Math.abs(o).toFixed(1)}%)
`,s+=`- No additional API calls for initial data
`,s+=`- Works even if API is slow/unavailable
`),(e.metrics.errorCount>0||t.metrics.errorCount>0)&&(s+=`
\u26A0\uFE0F  Errors detected:
`,s+=`- DOM Approach: ${e.metrics.errorCount} errors
`,s+=`- API Approach: ${t.metrics.errorCount} errors
`),s}typeof window!="undefined"&&(window.CG_testAllGradesDataSources=oa);var aa="cg_admin_dashboard";function Zn(){return/^\/accounts\/\d+\/theme_editor/.test(window.location.pathname)}function ze(){return new URLSearchParams(window.location.search).has(aa)}function fe(){var e;return((e=window.ENV)==null?void 0:e.ACCOUNT_ID)||null}function He(){var e,t;return ro((t=(e=window.ENV)==null?void 0:e.active_brand_config)==null?void 0:t.js_overrides)}function eo(){var e,t;return ro((t=(e=window.ENV)==null?void 0:e.active_brand_config)==null?void 0:t.css_overrides)}function to(){var t;let e=((t=window.ENV)==null?void 0:t.active_brand_config)||{};return{md5:e.md5||null,created_at:e.created_at||null}}function ro(e){return e==null?"":String(e).trim()}var no="cg-theme-editor-tools";function oo(){if(document.querySelector(`.${no}`))return n.trace("[ThemeEditorInjection] Already injected, skipping"),!0;let t=Array.from(document.querySelectorAll("label")).find(i=>/^javascript file/i.test(i.textContent.trim()));if(!t)return n.trace("[ThemeEditorInjection] JavaScript file label not found"),!1;let r=t.closest(".ic-Form-control")||t.closest(".ic-Form-control__control")||t.parentElement;if(!r)return n.warn("[ThemeEditorInjection] Could not find parent container for injection"),!1;let o=document.createElement("div");o.className=no,o.style.cssText=`
        margin-top: 10px;
        padding: 10px;
        border: 2px solid #22dd88;
        border-radius: 6px;
        background: rgba(34, 221, 136, 0.08);
    `;let s=document.createElement("div");s.textContent="Customized Gradebook Tools",s.style.fontWeight="600",s.style.marginBottom="8px";let a=document.createElement("button");return a.type="button",a.className="Button Button--small",a.textContent="Open CG Admin Dashboard",a.addEventListener("click",()=>{let i=fe();if(!i){alert("Account ID not found in ENV.");return}window.open(`/accounts/${i}?cg_admin_dashboard=1`,"_blank")}),o.appendChild(s),o.appendChild(a),r.appendChild(o),n.info("[ThemeEditorInjection] CG Tools button injected successfully"),!0}function S(e,t={}){let r=document.createElement(e);if(t.className&&(r.className=t.className),t.text!=null&&(r.textContent=t.text),t.html!=null&&(r.innerHTML=t.html),t.style&&typeof t.style=="object"&&Object.assign(r.style,t.style),t.attrs&&typeof t.attrs=="object")for(let[o,s]of Object.entries(t.attrs))r.setAttribute(o,s);if(t.on&&typeof t.on=="object")for(let[o,s]of Object.entries(t.on))r.addEventListener(o,s);return r}function Ae(e,t){let r=S("div",{style:{marginTop:"16px",padding:"16px",border:"1px solid #ddd",borderRadius:"10px",background:"#fff"}}),o=S("div",{text:t,style:{fontWeight:"700",marginBottom:"10px"}});return r.appendChild(o),e.appendChild(r),r}function ge(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function so(e,t){let r=new Blob([t],{type:"text/javascript;charset=utf-8"}),o=URL.createObjectURL(r),s=document.createElement("a");s.href=o,s.download=e,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(o)}var ao,ia=((ao=window.CG_CONFIG)==null?void 0:ao.EXPECTED_THEME_JS_URL)||"";function io(e){n.debug("[ThemeStatusPanel] Rendering theme status panels");let t=He(),r=eo(),o=to();ca(e,t,r,o),la(e,t)}function ca(e,t,r,o){let s=Ae(e,"Installed Theme Overrides (ENV.active_brand_config)"),a=S("pre",{style:{margin:"0",padding:"12px",background:"#f8f9fa",border:"1px solid #eee",borderRadius:"8px",fontSize:"13px",overflow:"auto"}});a.textContent=JSON.stringify({js_overrides:t||null,css_overrides:r||null,brand_md5:o.md5,brand_created_at:o.created_at},null,2),s.appendChild(a)}function la(e,t){let r=Ae(e,"CG Script Check"),o=S("div",{text:"Expected CG JS URL:",style:{fontWeight:"600",marginBottom:"6px"}}),s=S("input",{attrs:{type:"text",value:ia,spellcheck:"false"},style:{width:"100%",padding:"8px 10px",border:"1px solid #ccc",borderRadius:"8px",fontSize:"13px"}}),a=S("div",{style:{marginTop:"10px"}});function i(){let c=s.value.trim(),l=c&&t&&c===t;if(a.innerHTML="",!t){a.appendChild(S("div",{text:"\u26A0\uFE0F No JavaScript override is currently installed on this account.",style:{padding:"10px",borderRadius:"8px",border:"1px solid #f3d19e",background:"#fff7e6"}}));return}if(!c){a.appendChild(S("div",{text:"Enter an Expected CG JS URL to compare.",style:{color:"#666"}}));return}l?a.appendChild(S("div",{text:"\u2705 Installed JS matches Expected CG JS URL.",style:{padding:"10px",borderRadius:"8px",border:"1px solid #b7eb8f",background:"#f6ffed"}})):(a.appendChild(S("div",{html:"\u{1F6A8} <strong>Script has changed</strong><br>Installed JS does not match the expected CG script URL.",style:{padding:"10px",borderRadius:"8px",border:"1px solid #ffa39e",background:"#fff1f0"}})),a.appendChild(S("div",{html:`
                    <div style="margin-top:10px; font-size:13px; color:#333;">
                        <div><strong>Installed:</strong> ${ge(t)}</div>
                        <div style="margin-top:6px;"><strong>Expected:</strong> ${ge(c)}</div>
                    </div>
                `})))}s.addEventListener("input",i),r.appendChild(o),r.appendChild(s),r.appendChild(a),i()}async function _t(e,t){n.debug(`[FetchHelpers] Fetching ${e} with ${t}ms timeout`);let r=new AbortController,o=setTimeout(()=>r.abort(),t);try{let s=await fetch(e,{method:"GET",credentials:"omit",signal:r.signal,cache:"no-store"});if(!s.ok)throw new Error(`HTTP ${s.status}`);let a=await s.text();return n.debug(`[FetchHelpers] Successfully fetched ${a.length} bytes`),a}finally{clearTimeout(o)}}var co="/* BEGIN CG MANAGED CODE */",xt="/* END CG MANAGED CODE */";function lo({accountId:e,enableDashboard:t,dashboardLabel:r}){return n.debug("[LoaderGenerator] Building CG-managed block",{accountId:e,enableDashboard:t,dashboardLabel:r}),[co,`/* Generated: ${new Date().toISOString()} */`,`/* Account: ${e!=null?e:"unknown"} */`,"/* Purpose: Configure CG features without altering district loader behavior */","","window.CG_CONFIG = window.CG_CONFIG || {};","window.CG_CONFIG.features = window.CG_CONFIG.features || {};",`window.CG_CONFIG.features.adminDashboard = ${t?"true":"false"};`,`window.CG_CONFIG.features.adminDashboardLabel = ${JSON.stringify(r||"Open CG Admin Dashboard")};`,"","window.__CG_ADMIN_DASHBOARD_ENABLED__ = "+(t?"true":"false")+";","",xt].join(`
`)}function uo({baseLoaderText:e,cgBlock:t}){n.debug("[LoaderGenerator] Upserting CG block into loader");let r=e.indexOf(co),o=e.indexOf(xt);if(r!==-1&&o!==-1&&o>r){n.debug("[LoaderGenerator] Replacing existing CG block");let a=e.slice(0,r).trimEnd(),i=e.slice(o+xt.length).trimStart();return`${a}

${t}

${i}
`}return n.debug("[LoaderGenerator] Appending CG block at end"),`${e.trimEnd()}

${t}
`}function po(e){n.debug("[LoaderGeneratorPanel] Rendering loader generator panel");let t=Ae(e,"Generate Combined Loader (District loader + CG block)"),r=He(),o=S("div",{html:`
            <div style="color:#444; margin-bottom:10px;">
                This tool preserves the existing Theme JavaScript (district loader) and inserts/updates a CG-managed block at the <strong>end</strong> of the file.
            </div>
        `}),s=S("div",{html:`
            <div style="font-size:13px; color:#666; margin-bottom:10px;">
                Detected installed Theme JS URL:
                <div style="margin-top:4px; word-break:break-all;"><code>${ge(r||"(none)")}</code></div>
            </div>
        `}),a=S("div",{style:{marginBottom:"10px"}}),{settingsRow:i,enableDashboard:c,labelInput:l}=da(),{baseLabel:d,baseTA:u,lockRow:f,unlockBtn:p,relockBtn:m,reloadBtn:h}=ua(r),{actions:y,genBtn:E,dlBtn:w,copyBtn:b}=pa(),{outLabel:A,outTA:$,hint:oe}=ma();async function K(L){if(a.innerHTML="",!r){a.appendChild(S("div",{text:"\u26A0\uFE0F No installed Theme JS URL detected. Paste the loader manually.",style:{padding:"10px",borderRadius:"8px",border:"1px solid #f3d19e",background:"#fff7e6"}})),Tt(u,"",!1,p,m);return}a.appendChild(S("div",{html:`\u23F3 Loading current Theme JavaScript from installed URL\u2026 <span style="color:#666">(${ge(L||"auto")})</span>`,style:{padding:"10px",borderRadius:"8px",border:"1px solid #d9d9d9",background:"#fafafa"}}));try{let T;try{T=await _t(r,1e3)}catch($e){T=await _t(r,3e3)}a.innerHTML="",a.appendChild(S("div",{html:'\u2705 Loaded current Theme JavaScript automatically.<br><span style="color:#666; font-size:13px;">Textarea is locked to prevent accidental edits. Click "Unlock to edit" if needed.</span>',style:{padding:"10px",borderRadius:"8px",border:"1px solid #b7eb8f",background:"#f6ffed"}})),Tt(u,T,!0,p,m)}catch(T){n.warn("[LoaderGeneratorPanel] Auto-load failed",T),a.innerHTML="",a.appendChild(S("div",{html:'\u26A0\uFE0F Could not auto-load the current Theme JavaScript (likely CORS).<br><span style="color:#666; font-size:13px;">Please copy/paste the loader contents manually from the Theme Editor.</span>',style:{padding:"10px",borderRadius:"8px",border:"1px solid #f3d19e",background:"#fff7e6"}})),Tt(u,"",!1,p,m)}}p.addEventListener("click",()=>vt(u,!1,p,m)),m.addEventListener("click",()=>vt(u,!0,p,m)),h.addEventListener("click",()=>K("manual reload")),E.addEventListener("click",()=>{fa(u,c,l,$,w,b)}),w.addEventListener("click",()=>{$.value.trim()&&so("loader.js",$.value)}),b.addEventListener("click",async()=>{if($.value.trim())try{await navigator.clipboard.writeText($.value),alert("Copied combined loader to clipboard.")}catch(L){n.error("[LoaderGeneratorPanel] Copy failed",L),alert("Copy failed (clipboard permissions). You can still manually select + copy.")}}),t.appendChild(o),t.appendChild(s),t.appendChild(a),t.appendChild(i),t.appendChild(d),t.appendChild(u),t.appendChild(f),t.appendChild(y),t.appendChild(A),t.appendChild($),t.appendChild(oe),K("auto")}function da(){let e=S("div",{style:{display:"flex",gap:"12px",flexWrap:"wrap",alignItems:"center",marginBottom:"10px"}}),t=S("input",{attrs:{type:"checkbox",checked:"true"}}),r=S("label",{style:{display:"flex",gap:"8px",alignItems:"center",fontSize:"13px"}});r.appendChild(t),r.appendChild(S("span",{text:"Enable Admin Dashboard module"}));let o=S("input",{attrs:{type:"text",value:"Open CG Admin Dashboard",spellcheck:"false"},style:{flex:"1",minWidth:"320px",padding:"8px 10px",border:"1px solid #ccc",borderRadius:"8px",fontSize:"13px"}});return e.appendChild(r),e.appendChild(S("div",{text:"Button label:",style:{fontWeight:"600",fontSize:"13px"}})),e.appendChild(o),{settingsRow:e,enableDashboard:t,labelInput:o}}function ua(e){let t=S("div",{text:"Current Theme JavaScript (district loader):",style:{fontWeight:"700",marginTop:"6px"}}),r=S("textarea",{attrs:{rows:"12",spellcheck:"false"},style:{width:"100%",marginTop:"6px",padding:"10px",border:"1px solid #ccc",borderRadius:"8px",fontSize:"13px",fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',background:"#fafafa"}}),o=S("div",{style:{display:"flex",gap:"10px",marginTop:"10px",flexWrap:"wrap",alignItems:"center"}}),s=S("button",{text:"Unlock to edit",className:"Button Button--small",attrs:{disabled:"true"}}),a=S("button",{text:"Re-lock",className:"Button Button--small",attrs:{disabled:"true"}}),i=S("button",{text:"Reload from installed Theme JS URL",className:"Button Button--small",attrs:e?{}:{disabled:"true"}});return o.appendChild(s),o.appendChild(a),o.appendChild(i),{baseLabel:t,baseTA:r,lockRow:o,unlockBtn:s,relockBtn:a,reloadBtn:i}}function pa(){let e=S("div",{style:{display:"flex",gap:"10px",marginTop:"12px",flexWrap:"wrap"}}),t=S("button",{text:"Generate Combined Loader",className:"Button Button--primary"}),r=S("button",{text:"Download loader.js",className:"Button",attrs:{disabled:"true"}}),o=S("button",{text:"Copy Output",className:"Button",attrs:{disabled:"true"}});return e.appendChild(t),e.appendChild(r),e.appendChild(o),{actions:e,genBtn:t,dlBtn:r,copyBtn:o}}function ma(){let e=S("div",{text:"Combined Output (copy/upload this):",style:{fontWeight:"700",marginTop:"14px"}}),t=S("textarea",{attrs:{rows:"14",spellcheck:"false",readonly:"true"},style:{width:"100%",marginTop:"6px",padding:"10px",border:"1px solid #ccc",borderRadius:"8px",fontSize:"13px",background:"#fafafa",fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace'}}),r=S("div",{html:`
            <div style="margin-top:10px; color:#666; font-size:13px;">
                The CG-managed block is bracketed with:<br>
                <code>/* BEGIN CG MANAGED CODE */</code> \u2026 <code>/* END CG MANAGED CODE */</code>
            </div>
        `});return{outLabel:e,outTA:t,hint:r}}function Tt(e,t,r,o,s){e.value=t||"",vt(e,r,o,s)}function vt(e,t,r,o){t?(e.setAttribute("readonly","true"),e.style.background="#fafafa",r.removeAttribute("disabled"),o.setAttribute("disabled","true")):(e.removeAttribute("readonly"),e.style.background="#fff",r.setAttribute("disabled","true"),o.removeAttribute("disabled"))}function fa(e,t,r,o,s,a){let i=e.value||"";if(!i.trim()){alert("No loader text found. Paste the current Theme JavaScript (district loader) first, or use Reload if available.");return}let c=lo({accountId:fe(),enableDashboard:!!t.checked,dashboardLabel:r.value||"Open CG Admin Dashboard"}),l=uo({baseLoaderText:i,cgBlock:c});o.value=l,s.removeAttribute("disabled"),a.removeAttribute("disabled")}function mo(){n.info("[DashboardRenderer] Rendering admin dashboard page"),document.body.innerHTML="";let e=document.createElement("style");e.textContent=`
        /* Hide all Canvas content */
        #content, #application, .ic-app-main-content,
        #header, #main, .ic-app-header, .ic-app-nav-toggle-and-crumbs,
        .ic-app-course-menu, .ic-app-footer {
            display: none !important;
        }

        /* Reset body styles */
        body {
            margin: 0 !important;
            padding: 0 !important;
            background: #f5f5f5 !important;
            overflow-x: hidden !important;
        }

        /* Ensure admin dashboard is visible */
        #cg-admin-root {
            display: block !important;
            visibility: visible !important;
        }
    `,document.head.appendChild(e),document.title="CG Admin Dashboard";let t=S("div",{attrs:{id:"cg-admin-root"},style:{fontFamily:"system-ui, -apple-system, BlinkMacSystemFont, sans-serif",padding:"32px",maxWidth:"1100px",margin:"0 auto",background:"#fff",minHeight:"100vh",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"}}),r=S("h1",{text:"Customized Gradebook \u2013 Admin Dashboard"}),o=S("p",{html:`Account ID: <strong>${fe()||"unknown"}</strong>`,style:{color:"#666",marginTop:"6px"}}),s=S("div",{html:"\u2705 Virtual admin page rendered via Theme JS<br>Same origin \u2022 Same session \u2022 CSRF intact",style:{marginTop:"16px",padding:"16px",border:"2px solid #22dd88",borderRadius:"10px",background:"rgba(34, 221, 136, 0.08)"}});t.appendChild(r),t.appendChild(o),t.appendChild(s),io(t),po(t),document.body.appendChild(t),n.debug("[DashboardRenderer] Admin dashboard page rendered successfully")}function fo(){if(n.debug("[AdminDashboard] Checking if admin dashboard should initialize"),ze()){n.info("[AdminDashboard] Rendering virtual admin dashboard page"),mo();return}if(Zn()){n.info("[AdminDashboard] Injecting CG Tools button in Theme Editor");let e=0,t=20,o=setInterval(()=>{let s=oo();e++,(s||e>=t)&&(clearInterval(o),s?n.debug("[AdminDashboard] CG Tools button injected successfully"):n.warn("[AdminDashboard] Failed to inject CG Tools button after max attempts"))},250);return}n.trace("[AdminDashboard] Not on Theme Editor or Admin Dashboard page, skipping")}function ga(){let e=window.location.pathname;return e==="/"||e==="/dashboard"||e.startsWith("/dashboard/")}function ha(){return window.location.pathname.includes("/speed_grader")}(function(){if(Ut("prod","2026-02-04 10:42:18 AM (prod, 142ab52)"),Ft("prod","2026-02-04 10:42:18 AM (prod, 142ab52)"),n.info("Running in PROD mode"),n.info("Build environment: prod"),dn(),fo(),ze()){n.info("[Init] On admin dashboard page, skipping normal CG initialization");return}window.location.pathname.includes("/gradebook")&&(Xr(),(async()=>{var o,s;let t=x();if(!t){n.debug("[Init] Cannot get course ID, skipping Refresh Mastery initialization");return}let r=G(t);if(!r){let a=new C,i=((s=(o=document.querySelector(".course-title, h1, #breadcrumbs li:last-child"))==null?void 0:o.textContent)==null?void 0:s.trim())||"Course";r=await D(t,i,a)}if(!r||r.model!=="standards"){n.debug("[Init] Course is traditional, skipping Refresh Mastery initialization");return}n.debug("[Init] Course is standards-based, initializing Refresh Mastery"),await mn()})().catch(t=>{n.warn("[Init] Failed to initialize assignment kebab menu injection:",t)})),ga()&&Tn(),ha()&&(In(),j()==="teacher_like"&&Fn()),jn(),Se()&&j()==="teacher_like"&&$t(),window.CG||(window.CG={}),window.CG.clearAllSnapshots=Me})();})();
