(()=>{var Pe=Object.defineProperty,yr=Object.defineProperties;var _r=Object.getOwnPropertyDescriptors;var ie=Object.getOwnPropertySymbols;var Ve=Object.prototype.hasOwnProperty,Be=Object.prototype.propertyIsEnumerable;var qe=e=>{throw TypeError(e)};var Me=(e,t,r)=>t in e?Pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,R=(e,t)=>{for(var r in t||(t={}))Ve.call(t,r)&&Me(e,r,t[r]);if(ie)for(var r of ie(t))Be.call(t,r)&&Me(e,r,t[r]);return e},ee=(e,t)=>yr(e,_r(t));var ze=(e,t)=>{var r={};for(var n in e)Ve.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&ie)for(var n of ie(e))t.indexOf(n)<0&&Be.call(e,n)&&(r[n]=e[n]);return r};var te=(e,t)=>()=>(e&&(t=e(e=0)),t);var wr=(e,t)=>{for(var r in t)Pe(e,r,{get:t[r],enumerable:!0})};var $r=(e,t,r)=>t.has(e)||qe("Cannot "+r);var He=(e,t,r)=>t.has(e)?qe("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r);var W=(e,t,r)=>($r(e,t,"access private method"),r);function Ar(){let e=U.INFO;try{let r=new URLSearchParams(window.location.search).get("debug");r==="trace"?e=U.TRACE:r==="true"?e=U.DEBUG:r==="false"&&(e=U.INFO)}catch(t){console.warn("Failed to parse URL parameters for debug mode:",t)}return e}function je(e,t){console.log("%cCustomized Gradebook Loaded","color:#4CAF50; font-weight:bold;"),console.log(`Environment: ${e}`),console.log(`Build Version: ${t}`),o.isTraceEnabled()?console.log("%cTrace logging: ENABLED (very verbose)","color:#888888; font-weight:bold;"):o.isDebugEnabled()?console.log("%cDebug logging: ENABLED","color:#FF9800; font-weight:bold;"):console.log("Debug logging: disabled")}function Ye(e,t){window.CG={env:e,version:t,traceEnabled:o.isTraceEnabled(),debugEnabled:o.isDebugEnabled(),logLevel:q}}var U,q,o,S=te(()=>{U={TRACE:-1,DEBUG:0,INFO:1,WARN:2,ERROR:3};q=Ar(),o={trace(...e){q<=U.TRACE&&console.log("%c[TRACE]","color: #888888",...e)},debug(...e){q<=U.DEBUG&&console.log("[DEBUG]",...e)},info(...e){q<=U.INFO&&console.log("[INFO]",...e)},warn(...e){q<=U.WARN&&console.warn("[WARN]",...e)},error(...e){q<=U.ERROR&&console.error("[ERROR]",...e)},isTraceEnabled(){return q<=U.TRACE},isDebugEnabled(){return q<=U.DEBUG},getLogLevel(){return q}}});var Je,Xe,$t,Qe,Ze,At,et,tt,Tt,rt,ot,$,nt,st,A,Ir,at,it,M,ct,dt,we,lt,ut,T,ft,mt,I,gt,pt,K,ht,Et,J,bt,Ct,de,vr,St,yt,k,xr,_t,wt,It,v=te(()=>{$t=(Xe=(Je=window.CG_CONFIG)==null?void 0:Je.ENABLE_STUDENT_GRADE_CUSTOMIZATION)!=null?Xe:!0,At=(Ze=(Qe=window.CG_CONFIG)==null?void 0:Qe.REMOVE_ASSIGNMENT_TAB)!=null?Ze:!1,Tt=(tt=(et=window.CG_CONFIG)==null?void 0:et.PER_STUDENT_UPDATE_THRESHOLD)!=null?tt:25,$=(ot=(rt=window.CG_CONFIG)==null?void 0:rt.ENABLE_OUTCOME_UPDATES)!=null?ot:!0,A=(st=(nt=window.CG_CONFIG)==null?void 0:nt.ENABLE_GRADE_OVERRIDE)!=null?st:!0,Ir=e=>Number((e*25).toFixed(2)),M=(it=(at=window.CG_CONFIG)==null?void 0:at.OVERRIDE_SCALE)!=null?it:Ir,we=(dt=(ct=window.CG_CONFIG)==null?void 0:ct.UPDATE_AVG_BUTTON_LABEL)!=null?dt:"Update Current Score",T=(ut=(lt=window.CG_CONFIG)==null?void 0:lt.AVG_OUTCOME_NAME)!=null?ut:"Current Score",I=(mt=(ft=window.CG_CONFIG)==null?void 0:ft.AVG_ASSIGNMENT_NAME)!=null?mt:"Current Score Assignment",K=(pt=(gt=window.CG_CONFIG)==null?void 0:gt.AVG_RUBRIC_NAME)!=null?pt:"Current Score Rubric",J=(Et=(ht=window.CG_CONFIG)==null?void 0:ht.DEFAULT_MAX_POINTS)!=null?Et:4,de=(Ct=(bt=window.CG_CONFIG)==null?void 0:bt.DEFAULT_MASTERY_THRESHOLD)!=null?Ct:3,vr=[{description:"Exemplary",points:4},{description:"Beyond Target",points:3.5},{description:"Target",points:3},{description:"Approaching Target",points:2.5},{description:"Developing",points:2},{description:"Beginning",points:1.5},{description:"Needs Partial Support",points:1},{description:"Needs Full Support",points:.5},{description:"No Evidence",points:0}],k=(yt=(St=window.CG_CONFIG)==null?void 0:St.OUTCOME_AND_RUBRIC_RATINGS)!=null?yt:vr,xr=[],It=(wt=(_t=window.CG_CONFIG)==null?void 0:_t.EXCLUDED_OUTCOME_KEYWORDS)!=null?wt:xr});function Ae(e,t,r={}){let n=new Date().toISOString(),s=R({timestamp:n,context:t,name:e.name,message:e.message},r);o.error(`[${t}] ${e.name}: ${e.message}`,s),o.isDebugEnabled()&&e.stack&&o.error("Stack trace:",e.stack),e instanceof H?(o.error(`  Status: ${e.statusCode}`),o.isDebugEnabled()&&e.responseText&&o.error(`  Response: ${e.responseText}`)):e instanceof j?o.error(`  Timeout: ${e.timeoutMs}ms`):e instanceof X&&e.field&&o.error(`  Field: ${e.field}`)}function Te(e){if(e instanceof P)return e.message||"Operation cancelled.";if(e instanceof j)return"The operation took too long and timed out. Please try again.";if(e instanceof X)return e.message;if(e instanceof H)return e.statusCode===401||e.statusCode===403?"You don't have permission to perform this action.":e.statusCode===404?"The requested resource was not found.":e.statusCode>=500?"Canvas server error. Please try again later.":`Canvas API error: ${e.message}`;let t=e.message||"An unknown error occurred";return["fetch","JSON","undefined","null","parse","response"].some(s=>t.toLowerCase().includes(s.toLowerCase()))?"An unexpected error occurred. Please try again or contact support.":t}function le(e,t,r={}){let{showAlert:n=!1,banner:s=null,metadata:a={}}=r;Ae(e,t,a);let i=Te(e);return s&&typeof s.setText=="function"&&s.setText(i),n&&!(e instanceof P)&&alert(i),i}async function Nt(e,t={},r="fetch"){try{let n=await fetch(e,t);if(!n.ok){let s=await n.text();throw new H(`HTTP ${n.status}: ${n.statusText}`,n.status,s)}return n}catch(n){throw n instanceof H?n:new H(`Network error: ${n.message}`,0,null)}}async function Gt(e,t="parseJSON"){let r=await e.text();try{return JSON.parse(r)}catch(n){throw o.isDebugEnabled()&&o.error(`[${t}] Failed to parse JSON:`,r),new H("Invalid JSON response from Canvas API",e.status,r)}}var H,P,j,X,Y=te(()=>{S();H=class extends Error{constructor(t,r,n){super(t),this.name="CanvasApiError",this.statusCode=r,this.responseText=n}},P=class extends Error{constructor(t="User cancelled the operation"){super(t),this.name="UserCancelledError"}},j=class extends Error{constructor(t,r){super(t),this.name="TimeoutError",this.timeoutMs=r}},X=class extends Error{constructor(t,r){super(t),this.name="ValidationError",this.field=r}}});var V,Ot,Q,G,F=te(()=>{Y();S();G=class{constructor(){He(this,V);if(this.csrfToken=W(this,V,Ot).call(this,"_csrf_token"),!this.csrfToken)throw new Error("CSRF token not found - user may not be authenticated");o.debug("CanvasApiClient initialized with cached CSRF token")}async get(t,r={},n="get"){return W(this,V,Q).call(this,t,"GET",null,r,n)}async post(t,r,n={},s="post"){return W(this,V,Q).call(this,t,"POST",r,n,s)}async put(t,r,n={},s="put"){return W(this,V,Q).call(this,t,"PUT",r,n,s)}async delete(t,r={},n="delete"){return W(this,V,Q).call(this,t,"DELETE",null,r,n)}async graphql(t,r={},n="graphql"){let s="/api/graphql",a={query:t,variables:r},i={headers:{"Content-Type":"application/json"}};return W(this,V,Q).call(this,s,"POST",a,i,n)}};V=new WeakSet,Ot=function(t){let r=document.cookie.split(";").map(n=>n.trim());for(let n of r){let[s,a]=n.split("=",2);if(s===t)return decodeURIComponent(a)}return null},Q=async function(t,r,n,s={},a="request"){let i=ee(R({"Content-Type":"application/json"},s.headers),{"X-CSRF-Token":this.csrfToken}),c=null;n&&((i["Content-Type"]||"application/json").includes("application/json")?(n.authenticity_token||(n=ee(R({},n),{authenticity_token:this.csrfToken})),c=JSON.stringify(n)):c=n);let g=s,{headers:d}=g,u=ze(g,["headers"]),l=await Nt(t,R({method:r,credentials:"same-origin",headers:i,body:c},u),a);return await Gt(l,a)}});var tr={};wr(tr,{GRADE_SOURCE:()=>O,clearGradeCache:()=>Zr,getCourseGrade:()=>ne,preCacheEnrollmentGrades:()=>oe});function Le(e){let t=re.get(e);return t?Date.now()>t.expiresAt?(re.delete(e),o.trace(`Cache expired for course ${e}`),null):(o.trace(`Cache hit for course ${e}, expires in ${Math.round((t.expiresAt-Date.now())/1e3)}s`),t.value):null}function De(e,t,r,n){let s=Date.now()+Qr;re.set(e,{value:{score:t,letterGrade:r,source:n},expiresAt:s}),o.trace(`Cached grade for course ${e}, expires at ${new Date(s).toISOString()}`)}function Zr(){let e=re.size;re.clear(),o.debug(`Grade cache cleared (${e} entries removed)`)}function oe(e){var r,n,s,a,i,c,d,u,l,g,m,E,h,w;o.debug(`Pre-caching enrollment grades for ${e.length} courses`);let t=0;for(let _ of e){let{id:C,enrollmentData:p}=_;if(!p){o.trace(`No enrollment data for course ${C}, skipping pre-cache`);continue}let b=null,y=null;p.grades&&(b=(r=p.grades.current_score)!=null?r:p.grades.final_score,y=(i=(a=(s=(n=p.grades.current_grade)!=null?n:p.grades.final_grade)!=null?s:null)==null?void 0:a.trim())!=null?i:null),b==null&&(b=(u=(d=(c=p.computed_current_score)!=null?c:p.calculated_current_score)!=null?d:p.computed_final_score)!=null?u:p.calculated_final_score),y===null&&b!==null&&(y=(w=(h=(E=(m=(g=(l=p.computed_current_grade)!=null?l:p.calculated_current_grade)!=null?g:p.computed_final_grade)!=null?m:p.calculated_final_grade)!=null?E:null)==null?void 0:h.trim())!=null?w:null),b!=null?(De(C,b,y,O.ENROLLMENT),t++,o.trace(`Pre-cached enrollment grade for course ${C}: ${b}% (${y||"no letter grade"})`)):o.trace(`No valid enrollment score for course ${C}, skipping pre-cache`)}o.debug(`Pre-cached ${t} enrollment grades`)}async function eo(e,t){try{let n=(await t.get(`/api/v1/courses/${e}/assignments?search_term=${encodeURIComponent(I)}`,{},"fetchAvgAssignment")).find(d=>d.name===I);if(!n)return o.trace(`AVG assignment "${I}" not found in course ${e}`),null;let s=await t.get(`/api/v1/courses/${e}/assignments/${n.id}/submissions/self`,{},"fetchAvgSubmission"),a=s==null?void 0:s.score;if(a==null)return o.trace(`No score found for AVG assignment in course ${e}`),null;let i=null,c=Le(e);return c&&c.source===O.ENROLLMENT?(i=c.letterGrade,o.trace(`Retrieved letter grade from pre-cached enrollment data for course ${e}: ${i||"no letter grade"}`)):o.trace(`No pre-cached enrollment data available for letter grade in course ${e}`),o.trace(`AVG assignment data for course ${e}: ${a} (${i||"no letter grade"})`),{score:a,letterGrade:i}}catch(r){return o.warn(`Failed to fetch AVG assignment score for course ${e}:`,r.message),null}}async function to(e,t){var n,s,a,i,c,d,u,l,g,m,E,h,w,_;let r=Le(e);if(r&&r.source===O.ENROLLMENT)return o.trace(`Using pre-cached enrollment grade for course ${e}: ${r.score}% (${r.letterGrade||"no letter grade"})`),{score:r.score,letterGrade:r.letterGrade};o.trace(`Enrollment grade not pre-cached for course ${e}, fetching via API`);try{let C=await t.get(`/api/v1/courses/${e}/enrollments?user_id=self&type[]=StudentEnrollment`,{},"fetchEnrollment");o.trace(`Enrollment response for course ${e}:`,C);let p=C.find(L=>L.type==="StudentEnrollment"||L.type==="student"||L.role==="StudentEnrollment");if(!p)return o.trace(`No student enrollment found for course ${e}`),o.isTraceEnabled()&&C.length>0&&o.trace("Available enrollment types:",C.map(L=>L.type||L.role)),null;o.trace(`Student enrollment for course ${e}:`,p);let b=null,y=null;return p.grades&&(b=(n=p.grades.current_score)!=null?n:p.grades.final_score,y=(c=(i=(a=(s=p.grades.current_grade)!=null?s:p.grades.final_grade)!=null?a:null)==null?void 0:i.trim())!=null?c:null),b==null&&(b=(l=(u=(d=p.computed_current_score)!=null?d:p.calculated_current_score)!=null?u:p.computed_final_score)!=null?l:p.calculated_final_score),y===null&&b!==null&&(y=(_=(w=(h=(E=(m=(g=p.computed_current_grade)!=null?g:p.calculated_current_grade)!=null?m:p.computed_final_grade)!=null?E:p.calculated_final_grade)!=null?h:null)==null?void 0:w.trim())!=null?_:null),b==null?(o.trace(`No enrollment score found for course ${e}`),o.trace("Enrollment object:",p),null):(o.trace(`Enrollment data for course ${e}: ${b}% (${y||"no letter grade"})`),{score:b,letterGrade:y})}catch(C){return o.warn(`Failed to fetch enrollment score for course ${e}:`,C.message),o.isDebugEnabled()&&o.warn("Full error:",C),null}}async function ne(e,t){o.trace(`[Grade Source Debug] Course ${e}: Starting grade fetch with fallback hierarchy`);let r=Le(e);if(r&&r.source===O.ASSIGNMENT)return o.trace(`[Grade Source Debug] Course ${e}: Using cached AVG assignment grade (score=${r.score}, letterGrade=${r.letterGrade})`),{score:r.score,letterGrade:r.letterGrade,source:r.source};o.trace(`[Grade Source Debug] Course ${e}: Checking priority 1 - AVG assignment...`);let n=await eo(e,t);if(n!==null)return o.trace(`[Grade Source Debug] Course ${e}: AVG assignment found! score=${n.score}, letterGrade=${n.letterGrade}`),De(e,n.score,n.letterGrade,O.ASSIGNMENT),{score:n.score,letterGrade:n.letterGrade,source:O.ASSIGNMENT};o.trace(`[Grade Source Debug] Course ${e}: AVG assignment not found, checking priority 2...`),o.trace(`[Grade Source Debug] Course ${e}: Checking priority 2 - enrollment grade...`);let s=await to(e,t);return s!==null?(o.trace(`[Grade Source Debug] Course ${e}: Enrollment grade found! score=${s.score}, letterGrade=${s.letterGrade}`),(!r||r.source!==O.ENROLLMENT)&&De(e,s.score,s.letterGrade,O.ENROLLMENT),{score:s.score,letterGrade:s.letterGrade,source:O.ENROLLMENT}):(o.trace(`[Grade Source Debug] Course ${e}: Enrollment grade not found`),o.trace(`[Grade Source Debug] Course ${e}: No grade available from any source`),null)}var O,Qr,re,he=te(()=>{v();S();F();O=Object.freeze({ASSIGNMENT:"assignment",ENROLLMENT:"enrollment"}),Qr=300*1e3,re=new Map});S();function ce(e,t){let r=document.querySelector(e);if(r){let n=getComputedStyle(r);return t.style.fontSize=n.fontSize,t.style.fontFamily=n.fontFamily,t.style.fontWeight=n.fontWeight,!0}return!1}var Tr="#0c7d9d";function We({label:e,id:t=null,onClick:r=null,type:n="primary",tooltip:s=null}){let a=document.createElement("button");a.textContent=e,t&&(a.id=t),s&&(a.title=s),ce(".css-1f65ace-view-link",a)||(a.style.fontSize="14px",a.style.fontFamily="inherit",a.style.fontWeight="600"),a.style.marginLeft="1rem",a.style.padding="0.5rem 1rem",a.style.border="none",a.style.borderRadius="5px",a.style.cursor="pointer",a.style.transition="background 0.3s, color 0.3s";let c=getComputedStyle(document.documentElement),d=c.getPropertyValue("--ic-brand-button--primary-bgd").trim()||Tr,u=c.getPropertyValue("--ic-brand-button--primary-text").trim()||"#ffffff",l=c.getPropertyValue("--ic-brand-button--secondary-bgd").trim()||"#e0e0e0",g=c.getPropertyValue("--ic-brand-button--secondary-text").trim()||"#ffffff";return n==="primary"?(a.style.background=d,a.style.color=u):n==="secondary"&&(a.style.background=l,a.style.color=g,a.style.border="1px solid #ccc"),r&&a.addEventListener("click",r),a}function Ke(){let e=document.createElement("div");return e.style.display="flex",e.style.flexDirection="row",e.style.gap="0.01rem",e.style.marginLeft="1rem",e}v();S();function N(){var n,s;let e=ENV==null?void 0:ENV.COURSE_ID,t=(s=(n=window.location.pathname.match(/courses\/(\d+)/))==null?void 0:n[1])!=null?s:null,r=e||t;return r||(o.error("Course ID not found on page."),null)}function vt(){let e=ENV!=null&&ENV.current_user_id?String(ENV.current_user_id):"unknown_user",t=`roleGroup_${e}`,r=`roleGroup_debug_${e}`,n=sessionStorage.getItem(t);if(n)return n;let s=new Set;Array.isArray(ENV==null?void 0:ENV.current_user_roles)&&ENV.current_user_roles.forEach(u=>s.add(String(u))),Array.isArray(ENV==null?void 0:ENV.current_user_types)&&ENV.current_user_types.forEach(u=>s.add(String(u))),ENV!=null&&ENV.current_user_is_admin&&s.add("admin"),ENV!=null&&ENV.current_user_is_student&&s.add("student"),ENV!=null&&ENV.current_user_is_teacher&&s.add("teacher"),ENV!=null&&ENV.current_user_is_observer&&s.add("observer");let a=Array.from(s).map(u=>u.toLowerCase());o.debug("[role debug] userId:",e),o.debug("[role debug] normalized roles:",a);let i=["teacher","admin","root_admin","designer","ta","accountadmin"],c=["student","observer"],d="other";return a.some(u=>c.includes(u))?d="student_like":a.some(u=>i.includes(u))&&(d="teacher_like"),sessionStorage.setItem(t,d),sessionStorage.setItem(r,JSON.stringify({userId:e,normRoles:a,decided:d})),d}function $e(){let e=window.location.pathname;return e==="/"||e.startsWith("/dashboard")}async function xt(){let e=N();if(!e)return!1;let t=`hasAvgAssignment_${e}`,r=sessionStorage.getItem(t);if(r!==null)return r==="true";try{let a=(await(await fetch(`/api/v1/courses/${e}/assignments?search_term=${encodeURIComponent(I)}`)).json()).some(i=>i.name===I);return sessionStorage.setItem(t,a?"true":"false"),a}catch(n){return console.warn("Could not verify assignment existence:",n),!1}}v();Y();S();S();var f={IDLE:"IDLE",CHECKING_SETUP:"CHECKING_SETUP",CREATING_OUTCOME:"CREATING_OUTCOME",CREATING_ASSIGNMENT:"CREATING_ASSIGNMENT",CREATING_RUBRIC:"CREATING_RUBRIC",CALCULATING:"CALCULATING",UPDATING_GRADES:"UPDATING_GRADES",POLLING_PROGRESS:"POLLING_PROGRESS",VERIFYING:"VERIFYING",VERIFYING_OVERRIDES:"VERIFYING_OVERRIDES",COMPLETE:"COMPLETE",ERROR:"ERROR"},Rt={[f.IDLE]:[f.CHECKING_SETUP],[f.CHECKING_SETUP]:[f.CREATING_OUTCOME,f.CREATING_ASSIGNMENT,f.CREATING_RUBRIC,f.CALCULATING,f.ERROR],[f.CREATING_OUTCOME]:[f.CHECKING_SETUP,f.ERROR],[f.CREATING_ASSIGNMENT]:[f.CHECKING_SETUP,f.ERROR],[f.CREATING_RUBRIC]:[f.CHECKING_SETUP,f.ERROR],[f.CALCULATING]:[f.UPDATING_GRADES,f.COMPLETE,f.ERROR],[f.UPDATING_GRADES]:[f.POLLING_PROGRESS,f.VERIFYING,f.ERROR],[f.POLLING_PROGRESS]:[f.POLLING_PROGRESS,f.VERIFYING,f.ERROR],[f.VERIFYING]:[f.VERIFYING,f.VERIFYING_OVERRIDES,f.ERROR],[f.VERIFYING_OVERRIDES]:[f.VERIFYING_OVERRIDES,f.COMPLETE,f.ERROR],[f.COMPLETE]:[f.IDLE],[f.ERROR]:[f.IDLE]},ue=class{constructor(t=f.IDLE,r={}){this.currentState=t,this.context=R({courseId:null,outcomeId:null,assignmentId:null,rubricId:null,rubricCriterionId:null,rollupData:null,averages:null,progressId:null,startTime:null,numberOfUpdates:0,banner:null,error:null,retryCount:0,updateMode:null},r),this.eventListeners={},this.stateHistory=[t]}getCurrentState(){return this.currentState}getContext(){return R({},this.context)}updateContext(t){this.context=R(R({},this.context),t)}canTransition(t){return(Rt[this.currentState]||[]).includes(t)}transition(t,r={}){var s;if(!this.canTransition(t))throw new Error(`Invalid transition from ${this.currentState} to ${t}. Valid transitions: ${((s=Rt[this.currentState])==null?void 0:s.join(", "))||"none"}`);let n=this.currentState;this.currentState=t,this.stateHistory.push(t),this.updateContext(r),o.debug(`State transition: ${n} \u2192 ${t}`),this.emit("stateChange",{from:n,to:t,context:this.getContext()})}on(t,r){this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(r)}emit(t,r){(this.eventListeners[t]||[]).forEach(s=>{try{s(r)}catch(a){o.error(`Error in event listener for ${t}:`,a)}})}getStateHistory(){return[...this.stateHistory]}reset(){this.currentState=f.IDLE,this.context={courseId:this.context.courseId,outcomeId:null,assignmentId:null,rubricId:null,rubricCriterionId:null,rollupData:null,averages:null,progressId:null,startTime:null,numberOfUpdates:0,banner:null,error:null,retryCount:0,updateMode:null},this.stateHistory=[f.IDLE],o.debug("State machine reset to IDLE"),this.emit("reset",{})}};S();v();Y();F();v();S();F();v();S();async function Dt(e,t){if(!A)return o.debug("Grade override is disabled in config, skipping"),!1;try{return o.debug("Enabling final grade override for course"),await t.put(`/api/v1/courses/${e}/settings`,{allow_final_grade_override:!0},{},"enableCourseOverride"),o.info("Final grade override enabled for course"),!0}catch(r){throw o.error("Failed to enable final grade override:",r),r}}async function Ie(e,t){var r;if(!A)return o.debug("Grade override is disabled in config, skipping fetch"),new Map;try{let n=await t.get(`/courses/${e}/gradebook/final_grade_overrides`,{},"fetchOverrideGrades"),s=new Map,a=n.final_grade_overrides||{};for(let[i,c]of Object.entries(a)){let d=(r=c==null?void 0:c.course_grade)==null?void 0:r.percentage;d!=null&&(s.set(i,d),o.trace(`Override grade for user ${i}: ${d}%`))}return o.debug(`Fetched ${s.size} override grades from Canvas API`),s}catch(n){throw o.error("Failed to fetch override grades:",n),n}}async function Lt(e,t,r,n,s=.01){if(!A)return o.debug("Grade override is disabled in config, skipping verification"),[];try{let a=await Ie(e,n),i=[],c=0;o.debug(`Verifying ${t.length} students' override grades...`);for(let{userId:d,average:u}of t){let l=M(u),g=a.get(String(d)),m=r.get(String(d));if(o.trace(`User ${d}: expected=${l}%, actual=${g}%`),g==null){i.push({userId:d,enrollmentId:m,expected:l,actual:null,reason:"No override grade found"}),o.trace(`  \u274C No override grade found for user ${d}`);continue}let E=Math.abs(g-l);E>s?(i.push({userId:d,enrollmentId:m,expected:l,actual:g,diff:E}),o.trace(`  \u274C Mismatch: expected ${l}%, got ${g}% (diff: ${E.toFixed(2)}%)`)):(c++,o.trace(`  \u2713 Match: ${g}%`))}return o.debug(`Override verification complete: ${c} matches, ${i.length} mismatches`),i.length>0&&o.debug("Mismatches found:",i.map(d=>({userId:d.userId,expected:d.expected,actual:d.actual,diff:d.diff}))),i}catch(a){throw o.error("Failed to verify override scores:",a),a}}function Nr(e){var r,n;let t={};return((n=(r=e==null?void 0:e.linked)==null?void 0:r.outcomes)!=null?n:[]).forEach(s=>{t[String(s.id)]=s.title}),t}function Gr(e,t){var n;let r=e.find(s=>{var a;return String((a=s.links)==null?void 0:a.outcome)===String(t)});return(n=r==null?void 0:r.score)!=null?n:null}function Rr(e,t,r,n){return e.filter(s=>{var c;let a=String((c=s.links)==null?void 0:c.outcome),i=(t[a]||"").toLowerCase();return typeof s.score=="number"&&!r.has(a)&&!n.some(d=>i.includes(d.toLowerCase()))})}function Or(e){let t=e.reduce((r,n)=>r+n.score,0);return Number((t/e.length).toFixed(2))}function Dr(e,t){return e!==t}function Lr(e,t,r,n){if(!r||r.size===0)return!1;let s=n(t),a=r.get(String(e));return a==null?!0:Math.abs(a-s)>.01}function Ur(e,t,r,n,s,a,i,c){let d=t.reduce((u,l)=>u+l.score,0);if(o.trace(`User ${e}: total=${d}, count=${t.length}, average=${n}`),o.trace(`  Old average: ${r}, New average: ${n}`),A&&i.size>0){let u=c(n),l=i.get(String(e));l==null?o.trace(`  Override: missing (expected ${u}%) - needs update`):Math.abs(l-u)>.01?o.trace(`  Override: mismatch (expected ${u}%, got ${l}%) - needs update`):o.trace(`  Override: matches (${l}%)`)}s||a?s&&a?o.trace(`  \u2713 Including user ${e}: both outcome and override need updates`):s?o.trace(`  \u2713 Including user ${e}: outcome needs update`):o.trace(`  \u2713 Including user ${e}: override needs update`):o.trace(`  \u2717 Skipping user ${e}: no updates needed`)}async function Ut(e,t,r,n){var d,u,l,g;o.info("Calculating student averages..."),o.debug(`Grading mode: ENABLE_OUTCOME_UPDATES=${$}, ENABLE_GRADE_OVERRIDE=${A}`);let s=Nr(e),a=new Set([String(t)]),i=new Map;if(A&&r&&n)try{o.debug("Fetching current override grades for initial check..."),i=await Ie(r,n),o.debug(`Fetched ${i.size} override grades for comparison`)}catch(m){o.warn("Failed to fetch override grades for initial check, continuing without override checking:",m)}let c=[];for(let m of(d=e==null?void 0:e.rollups)!=null?d:[]){let E=(u=m.links)==null?void 0:u.user;if(!E)continue;let h=Gr((l=m.scores)!=null?l:[],t),w=Rr((g=m.scores)!=null?g:[],s,a,It);if(w.length===0)continue;let _=Or(w),C=$&&Dr(h,_),p=A&&Lr(E,_,i,M);Ur(E,w,h,_,C,p,i,M),(C||p)&&c.push({userId:E,average:_})}return o.debug(`Calculation complete: ${c.length} students need updates`),$&&A&&i.size>0?o.debug("  (checked both outcome scores and override grades)"):$?o.debug("  (checked outcome scores only)"):A&&o.debug("  (checked override grades only)"),c}F();v();S();function z(e,t=Date.now()){if(!e)return 0;let r=e.getContext();if(!r.startTime)return 0;let n=new Date(r.startTime).getTime(),s=t instanceof Date?t.getTime():new Date(t).getTime();return Math.floor((s-n)/1e3)}function fe(e,t){if(!e||!t)return;let r=t.querySelector(".floating-banner__text")||t;ve(t);let n=/\(Elapsed time:\s*\d+s\)/,s=()=>{let a=z(e),i=r.textContent||"";n.test(i)?r.textContent=i.replace(n,`(Elapsed time: ${a}s)`):r.textContent=i.trim().length?`${i} (Elapsed time: ${a}s)`:`(Elapsed time: ${a}s)`};s(),t._elapsedTimerId=setInterval(s,1e3)}function ve(e){e&&e._elapsedTimerId&&(clearInterval(e._elapsedTimerId),delete e._elapsedTimerId)}function me(e,t){let r=e.querySelector("#avg-last-update");r||(r=document.createElement("div"),r.id="avg-last-update",r.style.fontSize="12px",r.style.marginTop="4px",r.style.opacity="0.8",e.appendChild(r));let n=localStorage.getItem(`lastUpdateAt_${t}`),s=parseInt(localStorage.getItem(`duration_${t}`),10),a=i=>Number.isFinite(i)?`${Math.floor(i/60)}m ${i%60}s`:"N/A";r.textContent=n?`Last update: ${new Date(n).toLocaleString()} | Duration: ${a(s)}`:"Last update: none yet"}F();v();Y();S();var xe=new Map;async function ge(e,t,r){var a,i,c,d,u;let s=await r.graphql(`
    mutation SetOverride($enrollmentId: ID!, $overrideScore: Float!) {
      setOverrideScore(input: { enrollmentId: $enrollmentId, overrideScore: $overrideScore }) {
        grades { customGradeStatusId overrideScore __typename }
        __typename
      }
    }`,{enrollmentId:String(e),overrideScore:Number(t)},"setOverrideScoreGQL");if(s.errors){let l=new Error(`GQL error: ${JSON.stringify(s.errors)}`);throw Ae(l,"setOverrideScoreGQL",{enrollmentId:e,overrideScore:t}),l}return(u=(d=(c=(i=(a=s.data)==null?void 0:a.setOverrideScore)==null?void 0:i.grades)==null?void 0:c[0])==null?void 0:d.overrideScore)!=null?u:null}async function Ne(e,t){let r=String(e);if(xe.has(r))return xe.get(r);let n=new Map,s=`/api/v1/courses/${r}/enrollments?type[]=StudentEnrollment&per_page=100`;for(;s;){let a=await t.get(s,{},"getAllEnrollmentIds");for(let i of a)i!=null&&i.user_id&&(i!=null&&i.id)&&n.set(String(i.user_id),String(i.id));s=null}return xe.set(r,n),n}async function pe(e,t,r){return(await Ne(e,r)).get(String(t))||null}Y();S();async function kr(e,t,r,n,s,a){if(!$){o.trace(`Outcome updates disabled, skipping rubric score submission for user ${r}`);return}let i=new Date().toLocaleString();o.trace("Submitting rubric score for student",r);let c={rubric_assessment:{[n.toString()]:{points:s}},submission:{posted_grade:s.toString(),score:s},comment:{text_comment:"Score: "+s+"  Updated: "+i}};o.trace("Submitting rubric score for student",r,c),await a.put(`/api/v1/courses/${e}/assignments/${t}/submissions/${r}`,c,{},`submitRubricScore:${r}`),o.trace("Score submitted successfully for user",r)}async function kt(e,t,r,n,s){if(!$)return o.debug("Outcome updates disabled, skipping bulk update"),"SKIPPED_NO_OUTCOME_UPDATES";let a=new Date().toLocaleString(),i={};o.debug("averages:",n);for(let{userId:u,average:l}of n)o.trace("userId:",u,"score:",l),i[u]={posted_grade:l,text_comment:"Score: "+l+"  Updated: "+a,rubric_assessment:{[r.toString()]:{points:l}}};o.debug("bulk gradeData payload:",i);let d=(await s.post(`/api/v1/courses/${e}/assignments/${t}/submissions/update_grades`,{grade_data:i},{},"beginBulkUpdate")).id;return localStorage.setItem(`progressId_${N()}`,d),o.info("Waiting for grading to complete progress ID:",d),d}async function Ft(e,t,r,n=12e5,s=2e3){let a=Date.now(),i="beginning upload",c=N(),d=localStorage.getItem(`progressId_${c}`);for(fe(r,e);Date.now()-a<n;){let u=await t.get(`/api/v1/progress/${d}`,{},"waitForBulkGrading"),l=z(r);switch(i=u.workflow_state,o.debug(`Bulk Uploading Status: ${i} (elapsed: ${l}s)`),i!=="completed"&&e.soft(`Bulk uploading status: ${i.toUpperCase()}. (Elapsed time: ${l}s)`),i){case"queued":break;case"running":break;case"failed":throw o.error("Bulk update job failed."),new Error("Bulk update failed.");case"completed":o.info("Bulk upload completed: "+u.updated_at);return;default:break}await new Promise(g=>setTimeout(g,s))}throw new j("Bulk update is taking longer than expected. In a few minutes try updating again. If there are no changes to be made the update completed",n)}async function Mt(e,t,r,n,s,a,i=!1){let d=e.length;o.debug(`Per-student grading mode: ENABLE_OUTCOME_UPDATES=${$}, ENABLE_GRADE_OVERRIDE=${A}`);let u=$&&A?`Updating "${T}" and grade overrides for ${d} students...`:$?`Updating "${T}" scores for ${d} students...`:`Updating grade overrides for ${d} students...`;s.setText(u);let l=[],g={},m=new Set;async function E(p,b=3){let{userId:y,average:L}=p,Z=null;for(let B=1;B<=b;B++)try{if(await kr(t,r,y,n,L,a),A)try{let x=await pe(t,y,a);if(x){let _e=M(L);await ge(x,_e,a),o.debug(`[override] user ${y} \u2192 enrollment ${x}: ${_e}`)}else o.warn(`[override] no enrollmentId for user ${y}`)}catch(x){o.warn(`[override] failed for user ${y}:`,(x==null?void 0:x.message)||x)}return g[y]=B,B>1&&m.add(y),!0}catch(x){Z=x,B===1?g[y]=1:g[y]++,o.warn(`Attempt ${B} failed for student ${y}:`,x.message)}return Z}let h=[];for(let p=0;p<d;p++){let b=e[p],y=await E(b,3);y!==!0&&h.push(ee(R({},b),{error:y.message})),(p%1===0||p===d-1)&&s.setText(`Updating "${T}"  ${p+1} of ${d} students processed`)}o.info(`Retrying ${h.length} students...`);for(let p of h){let b=await E(p,3);b!==!0&&l.push({userId:p.userId,average:p.average,error:b.message})}let w=m.size,_=Object.entries(g).filter(([p,b])=>b>1).map(([p,b])=>({userId:p,attempts:b}));o.info(`${w} students needed more than one attempt.`),console.table(_);let C=!1;return i&&(C=!0),l.length>0&&o.warn("Scores of the following students failed to update:",l),(l.length>0||_.length>0)&&!i&&(C=confirm(`Export grade update attempt counts and failure logs to a file? 


           Note: Your browser settings or extensions may block automatic file downloads.

           If nothing downloads, please check your pop-up or download permissions.`)),C&&Fr(_,l),z()}function Fr(e,t){let r=`Unless marked "UPDATE FAILED", the students score was successfully updated but took multiple attempts.
`,n=`User ID,Average Score,Attempts,Status,Error
`,s=Object.fromEntries(t.map(m=>[m.userId,m])),a=new Set([...e.map(m=>m.userId),...Object.keys(s)]),i=Object.fromEntries(e.map(m=>[m.userId,m.attempts])),c=Array.from(a).map(m=>{var p,b;let E=(p=i[m])!=null?p:"",h=s[m],w=(b=h==null?void 0:h.average)!=null?b:"",_=h?"UPDATE FAILED":"",C=h!=null&&h.error?`"${h.error.replace(/"/g,'""')}"`:"";return`${m},${w},${E},${_},${C}`}),d=r+n+c.join(`
`),u=new Blob([d],{type:"text/csv"}),l=URL.createObjectURL(u),g=document.createElement("a");g.href=l,g.download="canvas_upload_error_summary.csv",g.click(),URL.revokeObjectURL(l)}F();S();async function Pt(e,t,r,n,s,a,i=5e3,c=50){let d="verifying";for(let u=1;u<=c;u++){let l=z(a);n.soft(`Status ${d.toUpperCase()}. (Elapsed time: ${l}s)`),fe(a,n);let g=await s.get(`/api/v1/courses/${e}/outcome_rollups?outcome_ids[]=${r}&include[]=outcomes&include[]=users&per_page=100`,{},"verifyUIScores");o.debug("newRollupData: ",g);let m=[];for(let{userId:E,average:h}of t){let w=g.rollups.find(b=>b.links.user.toString()===E.toString());if(!w){m.push({userId:E,reason:"No rollup found."});continue}let _=w.scores[0];if(!_){m.push({userId:E,reason:"No score found."});continue}let C=_.score;Math.abs(C-h)<.001||m.push({userId:E,expected:h,actual:C})}if(m.length===0){o.info("All averages match backend scores."),localStorage.setItem(`lastUpdateAt_${N()}`,new Date().toISOString());let E=z(a);localStorage.setItem(`duration_${N()}`,E);return}else o.warn("Mismatches found:",m),o.info(`Waiting ${i/1e3} seconds before retrying...`),await new Promise(E=>setTimeout(E,i))}}Y();F();v();S();async function Vt(e,t){let r=await t.get(`/api/v1/courses/${e}/outcome_rollups?include[]=outcomes&include[]=users&per_page=100`,{},"getRollup");return o.debug("rollupData: ",r),r}function Ge(e){var s,a;let t=T;o.debug("Outcome Title:",t),o.debug("data:",e);let r=(a=(s=e==null?void 0:e.linked)==null?void 0:s.outcomes)!=null?a:[];if(o.debug("outcomes: ",r),r.length===0)return o.warn("No outcomes found in rollup data."),null;let n=r.find(i=>i.title===t);return o.debug("match: ",n),n||o.warn(`Outcome not found: "${t}"`),n!=null?n:null}async function Bt(e,t){let n=`MOREnet_${Math.random().toString(36).substring(2,10)}`,s=k.map(m=>`${m.points},"${m.description}"`).join(","),a=`vendor_guid,object_type,title,description,calculation_method,mastery_points
"${n}",outcome,"${T}","Auto-generated outcome: ${T}",latest,"${de}",${s}`;o.debug("Importing outcome via CSV...");let c=(await t.post(`/api/v1/courses/${e}/outcome_imports?import_type=instructure_csv`,a,{headers:{"Content-Type":"text/csv"}},"createOutcome")).id;o.debug(`Outcome import started: ID ${c}`);let d=0,u=null,l=15,g=2e3;for(;d++<l;){await new Promise(h=>setTimeout(h,g));let m=await t.get(`/api/v1/courses/${e}/outcome_imports/${c}`,{},"createOutcome:poll"),E=m.workflow_state;if(o.debug(`Poll attempt ${d}: ${E}`),E==="succeeded"){u=m;break}else if(E==="failed")throw new Error("Outcome import failed")}if(!u)throw new j("Timed out waiting for outcome import to complete",l*g);o.debug("Outcome fully created")}F();v();S();async function qt(e,t,r){var s;let n=(s=t.alignments)!=null?s:[];for(let a of n){if(!a.startsWith("assignment_"))continue;let i=a.split("_")[1];try{let c=await r.get(`/api/v1/courses/${e}/assignments/${i}`,{},"getAssignment");if(c.name===I)return o.debug("Assignment found:",c),c}catch(c){o.debug(`Assignment ${i} not accessible:`,c.message);continue}}return o.warn(`Assignment "${I}" not found in alignments`),null}async function zt(e,t){let r={assignment:{name:I,position:1,submission_types:["none"],published:!0,notify_of_update:!0,points_possible:J,grading_type:"gpa_scale",omit_from_final_grade:!0}},n=await t.post(`/api/v1/courses/${e}/assignments`,r,{},"createAssignment");return o.info("Assignment created:",n.name),n.id}F();v();S();async function Ht(e,t,r){let n=await r.get(`/api/v1/courses/${e}/assignments/${t}`,{},"getRubric"),s=n.rubric_settings;if(!s||s.title!==K)return null;let a=n.rubric;if(!a||!Array.isArray(a)||a.length===0)return null;let i=a[0].id,c=s.id;return o.debug("Found rubric and first criterion ID:",{rubricId:c,criterionId:i}),{rubricId:c,criterionId:i}}async function jt(e,t,r,n){let s={};k.forEach((c,d)=>{s[d]={description:c.description,points:c.points}});let a={rubric:{title:K,free_form_criterion_comments:!1,criteria:{0:{description:`${T} criteria was used to create this rubric`,criterion_use_range:!1,points:J,mastery_points:de,learning_outcome_id:r,ratings:s}}},rubric_association:{association_type:"Assignment",association_id:t,use_for_grading:!0,purpose:"grading",hide_points:!0}},i=await n.post(`/api/v1/courses/${e}/rubrics`,a,{},"createRubric");return o.debug("Rubric created and linked to outcome:",i),i.id}v();S();async function Yt(e){let n=(await(await fetch(`/api/v1/courses/${e}/assignments?per_page=100`)).json()).find(s=>s.name===I);return n?n.id:null}async function Mr(e){let{courseId:t,banner:r}=e.getContext(),n=new G,s=$?`Checking setup for "${T}"...`:"Checking setup for grade overrides...";r.setText(s),o.debug(`Grading mode: ENABLE_OUTCOME_UPDATES=${$}, ENABLE_GRADE_OVERRIDE=${A}`);let a=await Vt(t,n);if(e.updateContext({rollupData:a}),$){let i=Ge(a),c=i==null?void 0:i.id;if(!c){if(!confirm(`Outcome "${T}" not found.
Would you like to create it?`))throw new P("User declined to create missing outcome.");return f.CREATING_OUTCOME}e.updateContext({outcomeId:c});let d=await qt(t,i,n);if(!d){let E=await Yt(t);E&&(d=await n.get(`/api/v1/courses/${t}/assignments/${E}`,{},"getAssignment:fallback"),o.debug("Fallback assignment found by name:",d))}let u=d==null?void 0:d.id;if(!u){if(!confirm(`Assignment "${I}" not found.
Would you like to create it?`))throw new P("User declined to create missing assignment.");return f.CREATING_ASSIGNMENT}e.updateContext({assignmentId:u});let l=await Ht(t,u,n),g=l==null?void 0:l.rubricId,m=l==null?void 0:l.criterionId;if(!g){if(!confirm(`Rubric "${K}" not found.
Would you like to create it?`))throw new P("User declined to create missing rubric.");return f.CREATING_RUBRIC}e.updateContext({rubricId:g,rubricCriterionId:m})}else{o.debug("Outcome updates disabled, skipping outcome/assignment/rubric checks");let i=Ge(a),c=i==null?void 0:i.id;c?(e.updateContext({outcomeId:c}),o.debug(`Found outcomeId ${c} for exclusion from average calculation`)):o.debug("No outcome found - will calculate averages without excluding any outcome")}if(A)try{await Dt(t,n)}catch(i){o.warn("Failed to enable course override, continuing anyway:",i)}return f.CALCULATING}async function Pr(e){let{courseId:t,banner:r}=e.getContext(),n=new G;return r.setText(`Creating "${T}" Outcome...`),await Bt(t,n),f.CHECKING_SETUP}async function Vr(e){let{courseId:t,banner:r}=e.getContext(),n=new G;r.setText(`Creating "${I}" Assignment...`);let s=await zt(t,n);return e.updateContext({assignmentId:s}),f.CHECKING_SETUP}async function Br(e){let{courseId:t,assignmentId:r,outcomeId:n,banner:s}=e.getContext(),a=new G;s.setText(`Creating "${K}" Rubric...`);let i=await jt(t,r,n,a);return e.updateContext({rubricId:i}),f.CHECKING_SETUP}async function qr(e){let{rollupData:t,outcomeId:r,courseId:n,banner:s}=e.getContext(),a=new G,i=$?`Calculating "${T}" scores...`:"Calculating student averages for grade overrides...";s.setText(i);let c=await Ut(t,r,n,a),d=c.length;return e.updateContext({averages:c,numberOfUpdates:d,startTime:new Date().toISOString()}),d===0?(e.updateContext({zeroUpdates:!0}),f.COMPLETE):f.UPDATING_GRADES}async function zr(e){let{averages:t,courseId:r,assignmentId:n,rubricCriterionId:s,numberOfUpdates:a,banner:i}=e.getContext(),c=new G;if(!$)return o.debug("Outcome updates disabled, skipping UPDATING_GRADES state"),f.VERIFYING;let d=a<Tt,u=d?"per-student":"bulk";if(e.updateContext({updateMode:u}),d){let l=`Detected ${a} changes - updating scores one at a time for quicker processing.`;return i.hold(l,3e3),o.debug("Per student update..."),await Mt(t,r,n,s,i,c,!1),o.debug("handleUpdatingGrades complete, transitioning to VERIFYING"),f.VERIFYING}else{let l=`Detected ${a} changes - using bulk update`;i.hold(l,3e3),o.debug(`Bulk update, detected ${a} changes`);let g=await kt(r,n,s,t,c);return e.updateContext({progressId:g}),o.debug(`progressId: ${g}`),o.debug("handleUpdatingGrades complete, transitioning to POLLING_PROGRESS"),f.POLLING_PROGRESS}}async function Hr(e){let{banner:t}=e.getContext(),r=new G;return o.debug("Starting bulk update polling..."),await Ft(t,r,e),o.debug("handlePollingProgress complete, transitioning to VERIFYING"),f.VERIFYING}async function jr(e){let{courseId:t,averages:r,outcomeId:n,banner:s}=e.getContext(),a=new G;return $?(o.debug("Starting outcome score verification..."),await Pt(t,r,n,s,a,e),o.debug("handleVerifying complete, transitioning to VERIFYING_OVERRIDES"),f.VERIFYING_OVERRIDES):(o.debug("Outcome updates disabled, skipping VERIFYING state"),f.VERIFYING_OVERRIDES)}async function Yr(e){let{courseId:t,averages:r,banner:n}=e.getContext(),s=new G;if(!A)return o.debug("Grade override disabled, skipping VERIFYING_OVERRIDES state"),f.COMPLETE;o.debug("Starting grade override submission and verification..."),n.soft("Submitting grade overrides...");let a=0,i=0;for(let{userId:l,average:g}of r)try{let m=await pe(t,l,s);if(!m){o.warn(`[override] No enrollmentId for user ${l}`),i++;continue}let E=M(g);await ge(m,E,s),o.trace(`[override] user ${l} \u2192 enrollment ${m}: ${E}`),a++}catch(m){o.warn(`[override] Failed for user ${l}:`,(m==null?void 0:m.message)||m),i++}o.info(`Grade override submission complete: ${a} succeeded, ${i} failed`);let c=3,d=2e3,u=[];try{let l=await Ne(t,s);for(let g=1;g<=c;g++){if(n.soft(`Verifying grade overrides... (attempt ${g}/${c})`),o.debug(`Override verification attempt ${g}/${c}...`),u=await Lt(t,r,l,s),u.length===0){o.info(`All override scores verified successfully on attempt ${g}`);break}g<c?(o.warn(`Found ${u.length} override score mismatches on attempt ${g}, retrying in ${d/1e3}s...`),await new Promise(m=>setTimeout(m,d))):(o.warn(`Found ${u.length} override score mismatches after ${c} attempts`),o.warn("Final mismatches:",u.map(m=>({userId:m.userId,expected:m.expected,actual:m.actual}))))}}catch(l){o.warn("Override verification failed, continuing anyway:",l)}return o.debug("handleVerifyingOverrides complete, transitioning to COMPLETE"),f.COMPLETE}async function Wr(e){let{numberOfUpdates:t,banner:r,courseId:n,zeroUpdates:s}=e.getContext(),a=z(e);ve(r);let i=$&&A?`${T} and grade overrides`:$?T:"grade overrides";return s||t===0?(r.setText(`No changes to ${i} found.`),alert(`No changes to ${i} have been found. No updates performed.`),setTimeout(()=>{r.remove()},2e3),f.IDLE):(r.setText(`${t} student ${i} updated successfully! (elapsed time: ${a}s)`),localStorage.setItem(`duration_${n}`,a),localStorage.setItem(`lastUpdateAt_${n}`,new Date().toISOString()),alert(`All ${i} have been updated. (elapsed time: ${a}s)
You may need to refresh the page to see the new scores.`),f.IDLE)}async function Kr(e){let{error:t,banner:r}=e.getContext();return o.error("Update ended prematurely:",t),r&&(r.setText(`Update ended prematurely: ${t.message}. You can re-run the update to ensure all scores are correctly set.`),setTimeout(()=>r.remove(),5e3)),f.IDLE}var Wt={[f.CHECKING_SETUP]:Mr,[f.CREATING_OUTCOME]:Pr,[f.CREATING_ASSIGNMENT]:Vr,[f.CREATING_RUBRIC]:Br,[f.CALCULATING]:qr,[f.UPDATING_GRADES]:zr,[f.POLLING_PROGRESS]:Hr,[f.VERIFYING]:jr,[f.VERIFYING_OVERRIDES]:Yr,[f.COMPLETE]:Wr,[f.ERROR]:Kr};var Kt=(e,t)=>`${e}_${t}`;var Jr=getComputedStyle(document.documentElement).getPropertyValue("--ic-brand-primary").trim()||"#0c7d9d";function Jt({text:e="",duration:t=null,top:r="20px",right:n="20px",center:s=!1,backgroundColor:a=Jr,textColor:i="#ffffff",allowMultiple:c=!1,ariaLive:d="polite"}={}){c||document.querySelectorAll(".floating-banner").forEach(D=>D.remove());let u=document.querySelector(".ic-Layout-contentMain")||document.querySelector(".ic-app-header__menu-list-item__link")||document.body,l=getComputedStyle(u),g=l.fontFamily,m=l.fontSize,E=l.fontWeight,h=document.createElement("div");h.className="floating-banner",h.setAttribute("role","status"),d&&d!=="off"&&h.setAttribute("aria-live",d),Object.assign(h.style,{position:"fixed",top:r,background:a,padding:"10px 20px",borderRadius:"8px",boxShadow:"0 4px 8px rgba(0,0,0,0.2)",zIndex:"9999",fontSize:m,color:i,fontFamily:g,fontWeight:E,display:"inline-flex",alignItems:"center",gap:"12px",maxWidth:"min(90vw, 720px)",lineHeight:"1.35",wordBreak:"break-word"}),s?(h.style.left="50%",h.style.transform="translateX(-50%)"):h.style.right=n;let w=document.createElement("span");w.className="floating-banner__text",h.appendChild(w);let _=document.createElement("button");_.type="button",_.setAttribute("aria-label","Dismiss message"),_.textContent="\xD7",Object.assign(_.style,{cursor:"pointer",fontWeight:"bold",border:"none",background:"transparent",color:"inherit",fontSize:m,lineHeight:"1"}),_.onclick=()=>ae(),h.appendChild(_),document.body.appendChild(h);let C=0,p=null,b=null,y=null,L=()=>Date.now(),Z=()=>L()<C,B=N(),x=D=>{w.textContent=D,B&&localStorage.setItem(Kt("bannerLast",B),D)},_e=()=>{C=0,p!=null&&(x(p),p=null)};h.setText=D=>{Z()?p=D:x(D)},h.hold=(D,ke=3e3)=>{let Fe=Date.now();if(Fe<C){p=D;return}C=Fe+ke,x(D),b&&clearTimeout(b),b=setTimeout(()=>{C=0,p!=null&&(x(p),p=null)},ke)},h.soft=D=>{Z()||x(D)};function ae(){b&&clearTimeout(b),y&&clearTimeout(y),h.style.transition="opacity 150ms",h.style.opacity="0",setTimeout(()=>h.remove(),160)}return h.removeBanner=ae,t==="hold"?h.hold(e,3e3):h.setText(e),typeof t=="number"&&isFinite(t)&&t>=0&&(y=setTimeout(ae,t)),_.onclick=()=>{ae()},t==="hold"?h.hold(e,3e3):h.setText(e),h}S();function Xt(e){if(!o.isDebugEnabled())return;let t=document.getElementById("state-machine-debug-panel");t||(t=document.createElement("div"),t.id="state-machine-debug-panel",t.style.cssText=`
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 10000;
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #00ff00;
        `,document.body.appendChild(t));let r=e.getContext(),n=e.getStateHistory(),s=e.getCurrentState();t.innerHTML=`
        <div style="font-weight: bold; margin-bottom: 8px; color: #ffff00;">
            \u{1F527} STATE MACHINE DEBUG
        </div>
        <div style="margin-bottom: 4px;">
            <strong>Current State:</strong> <span style="color: #00ffff;">${s}</span>
        </div>
        <div style="margin-bottom: 4px;">
            <strong>Transitions:</strong> ${n.length-1}
        </div>
        <div style="margin-bottom: 4px;">
            <strong>Update Mode:</strong> ${r.updateMode||"N/A"}
        </div>
        <div style="margin-bottom: 4px;">
            <strong>Updates:</strong> ${r.numberOfUpdates||0}
        </div>
        <div style="margin-bottom: 8px; font-size: 10px; color: #888;">
            Last 3: ${n.slice(-3).join(" \u2192 ")}
        </div>
        <div style="font-size: 10px; color: #666; cursor: pointer;" onclick="this.parentElement.remove()">
            [Click to close]
        </div>
    `}function Re(){let e=document.getElementById("state-machine-debug-panel");e&&e.remove()}Y();S();function Qt(){let e=N();if(e)try{let t=`updateFlow_state_${e}`;localStorage.getItem(t)&&(localStorage.removeItem(t),o.debug(`Cleaned up legacy state machine data for course ${e}`))}catch(t){o.error("Failed to clean up localStorage:",t)}}v();S();async function Zt(e=null){var a;let t=N();if(!t)throw new X("Course ID not found","courseId");let r=new ue,n=$&&A?`Preparing to update "${T}" and grade overrides: checking setup...`:$?`Preparing to update "${T}": checking setup...`:"Preparing to update grade overrides: checking setup...",s=Jt({text:n});r.updateContext({courseId:t,banner:s,button:e}),alert("You may minimize this browser or switch to another tab, but please keep this tab open until the process is fully complete.");try{for(r.transition(f.CHECKING_SETUP);r.getCurrentState()!==f.IDLE;){let c=r.getCurrentState();if(c===f.IDLE||c===f.ERROR)break;o.debug(`Executing state: ${c}`);let d=Wt[c];if(!d)throw new Error(`No handler found for state: ${c}`);let u=await d(r);u!==c&&r.transition(u),Xt(r)}let i=(a=document.querySelector("#update-scores-button"))==null?void 0:a.parentElement;i&&me(i,t),Oe(e),Re()}catch(i){if(r.updateContext({error:i}),r.transition(f.ERROR),i instanceof P){let c=Te(i);alert(`Update cancelled: ${c}`),s.remove()}else{let c=le(i,"startUpdateFlow",{banner:s});setTimeout(()=>{s.remove()},3e3)}Oe(e),Re()}finally{Qt()}}function er(){Xr(e=>{let t=N(),r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="flex-end";let n=We({label:we,id:"update-scores-button",onClick:async()=>{try{await Zt(n)}catch(a){le(a,"updateScores",{showAlert:!0})}},type:"primary"});r.appendChild(n),me(r,t);let s=Ke();s.appendChild(r),e.appendChild(s)})}function Oe(e){if(!e)return;e.textContent=we,e.title="",e.disabled=!1,e.style.cursor="pointer",e.style.opacity="1";let r=getComputedStyle(document.documentElement).getPropertyValue("--ic-brand-button--primary-bgd").trim()||"#0c7d9d";e.style.backgroundColor=r,o.debug("Button reset to normal state")}function Xr(e){let t=0,r=setInterval(()=>{let n=window.location.pathname.includes("/gradebook"),s=document.readyState==="complete",a=document.querySelector('.outcome-gradebook-container nav, [data-testid="gradebook-toolbar"]');n&&s&&a?(clearInterval(r),o.debug("Gradebook page and toolbar found."),e(a)):t++>33&&(clearInterval(r),o.warn("Gradebook toolbar not found after 10 seconds, UI not injected."))},300)}S();F();he();S();v();he();var rr="cg-dashboard-grade",ro=[".ic-DashboardCard",'[class*="DashboardCard"]','[class*="CourseCard"]',".course-list-item",".dashboard-card"],oo=[".ic-DashboardCard__header_hero",'[class*="hero"]','[class*="Hero"]',".ic-DashboardCard__header",'[class*="header"]','[class*="Header"]'];function or(e){let t=document.querySelector(`[data-course-id="${e}"]`);if(t)return o.trace(`Found card for course ${e} using data-course-id`),t;let r=`/courses/${e}`,n=document.querySelectorAll(`a[href*="${r}"]`);for(let s of n)for(let a of ro){let i=s.closest(a);if(i&&i.querySelector(`a[href*="${r}"]`))return o.trace(`Found card for course ${e} using href strategy with selector: ${a}`),i}for(let s of n){if(s.closest(".ic-app-header")||s.closest('[role="navigation"]')||s.closest(".menu"))continue;let a=s;for(let i=0;i<5&&(a=a.parentElement,!!a);i++)if(a.className&&(a.className.includes("Card")||a.className.includes("card")||a.className.includes("course")))return o.trace(`Found card for course ${e} using parent traversal`),a}return o.trace(`Dashboard card not found for course ${e}`),null}function no(e){if(!e)return o.trace("[Letter Grade Validation] letterGrade is empty/null/undefined"),!1;let r=k.find(n=>n.description===e)!==void 0;return o.trace(`[Letter Grade Validation] Checking "${e}" against rating scale: ${r?"MATCH FOUND":"NO MATCH"}`),!r&&k.length>0&&o.trace("[Letter Grade Validation] Available rating descriptions:",k.map(n=>n.description)),r}function so(e){return e/100*J}function ao(e){let{score:t,letterGrade:r,source:n}=e;o.trace(`[Grade Conversion Debug] Formatting grade data: source=${n}, score=${t}, letterGrade=${r}`);let s,a;if(n===O.ASSIGNMENT){let i=t.toFixed(2);r?(s=`${i} (${r})`,a=`Grade: ${i}, letter grade ${r}`):(s=i,a=`Grade: ${i}`),o.trace(`[Grade Conversion Debug] Assignment grade: display=${s}`)}else if(n===O.ENROLLMENT){let i=no(r);if(o.trace(`[Grade Conversion Debug] isValidLetterGrade("${r}") = ${i}`),i){let c=so(t),d=c.toFixed(2);s=`${d} (${r})`,a=`Grade: ${d}, letter grade ${r}`,o.trace(`[Grade Conversion Debug] Converted to points: ${t}% -> ${c} -> display="${s}"`)}else{let c=`${t.toFixed(2)}%`;r?(s=`${c} (${r})`,a=`Grade: ${c}, letter grade ${r}`,o.trace(`[Grade Conversion Debug] Letter grade "${r}" not in rating scale, using percentage: display="${s}"`)):(s=c,a=`Grade: ${c}`,o.trace(`[Grade Conversion Debug] No letter grade, using percentage: display="${s}"`))}}else{o.warn(`[Grade Conversion Debug] Unknown grade source: ${n}`);let i=`${t.toFixed(2)}%`;r?(s=`${i} (${r})`,a=`Grade: ${i}, letter grade ${r}`):(s=i,a=`Grade: ${i}`)}return{displayValue:s,ariaLabel:a}}function io(e,t=null){let{source:r}=e,{displayValue:n,ariaLabel:s}=ao(e),a=document.createElement("div");a.className=`${rr}`,a.setAttribute("data-source",r),a.setAttribute("role","status"),a.setAttribute("aria-label",s),a.textContent=n;let i="rgba(64, 64, 64, 0.85)";if(t){let d=window.getComputedStyle(t).backgroundColor;d&&d!=="transparent"&&d!=="rgba(0, 0, 0, 0)"&&(i=co(d),o.trace(`Derived badge background from hero color: ${d} -> ${i}`))}return a.style.cssText=`
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 0.875rem;
        line-height: 1.4;
        border-radius: 8px;
        background: ${i};
        color: #fff;
        display: inline-block;
        text-align: center;
        box-sizing: border-box;
        padding: 6px 10px;
        font-weight: 600;
        white-space: nowrap;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 10;
    `,a}function co(e){let t=lo(e);if(!t)return"rgba(64, 64, 64, 0.75)";let r=Math.max(0,Math.floor(t.r*.7)),n=Math.max(0,Math.floor(t.g*.7)),s=Math.max(0,Math.floor(t.b*.7));return`rgba(${r}, ${n}, ${s}, 0.75)`}function lo(e){let t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(t)return{r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10)};let r=e.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}function uo(e){for(let r of oo){let n=e.querySelector(r);if(n)return window.getComputedStyle(n).position==="static"&&(n.style.position="relative"),o.trace(`Using container for grade badge placement: ${r}`),n}return o.warn("Could not find hero or header element, using card itself (fallback)"),window.getComputedStyle(e).position==="static"&&(e.style.position="relative"),e}function nr(e,t){fo(e);let r=uo(e);if(!r){o.warn("Could not find suitable container for grade badge"),o.warn("Card element:",e);return}let n=io(t,r);if(r.appendChild(n),o.isTraceEnabled()){let s=t.letterGrade?`${t.score}% (${t.letterGrade})`:`${t.score}`;o.trace(`Grade badge rendered (${s}, source: ${t.source})`),o.trace(`Badge placed in: ${r.className||r.tagName}`)}else o.debug(`Grade badge rendered on card (source: ${t.source})`)}function fo(e){let t=e.querySelector(`.${rr}`);t&&(t.remove(),o.trace("Existing grade badge removed from card"))}var sr=!1,Ee=null,ar=3;async function ir(e){var t;try{let r=await e.get("/api/v1/courses?enrollment_state=active&include[]=total_scores",{},"fetchActiveCourses");o.trace("Raw courses response:",r),o.trace(`Number of courses returned: ${(r==null?void 0:r.length)||0}`),r&&r.length>0&&(o.trace("First course structure:",r[0]),o.trace("First course enrollments:",r[0].enrollments));let s=r.filter(a=>{let i=a.enrollments||[],c=i.some(d=>d.type==="student"||d.type==="StudentEnrollment"||d.role==="StudentEnrollment");return o.isTraceEnabled()&&i.length>0&&o.trace(`Course ${a.id} (${a.name}): enrollments =`,i.map(d=>d.type)),c}).map(a=>{let c=(a.enrollments||[]).find(d=>d.type==="student"||d.type==="StudentEnrollment"||d.role==="StudentEnrollment");return{id:String(a.id),name:a.name,enrollmentData:c||null}});if(o.info(`Found ${s.length} active student courses out of ${r.length} total courses`),o.isTraceEnabled()&&s.length>0){let a=s[0];o.trace("First course enrollment data:",a.enrollmentData),(t=a.enrollmentData)!=null&&t.grades&&o.trace("First course grades object:",a.enrollmentData.grades)}return s}catch(r){return o.error("Failed to fetch active courses:",r),[]}}async function mo(e,t){try{let r=or(e);if(!r){o.trace(`Card element not found for course ${e}, skipping`);return}let n=await ne(e,t);if(!n){o.trace(`No grade available for course ${e}, skipping`);return}nr(r,n);let s=n.letterGrade?`${n.score}% (${n.letterGrade})`:`${n.score}`;o.trace(`Grade displayed for course ${e}: ${s} (source: ${n.source})`)}catch(r){o.warn(`Failed to update grade for course ${e}:`,r.message)}}async function cr(){try{let e=performance.now(),t=new G,r=await ir(t);if(r.length===0){o.info("No active student courses found");return}o.info(`Updating grades for ${r.length} courses`),oe(r);let n=ar,s=r.map(w=>w.id),a=0,i=0,c=0;async function d(){for(;s.length>0;){let w=s.shift();if(!w)break;try{await mo(w,t),a++,i++,a%5===0&&o.debug(`Progress: ${a}/${r.length} courses processed`)}catch(_){a++,c++,o.warn(`Worker failed to process course ${w}:`,_.message)}}}let u=performance.now();o.debug(`Starting ${n} concurrent workers for ${r.length} courses`),await Promise.all(Array.from({length:n},()=>d()));let l=performance.now()-u,g=performance.now()-e,m=l/r.length;o.info("Dashboard grade display update complete"),o.info(`Performance: ${r.length} courses processed in ${g.toFixed(0)}ms total (${l.toFixed(0)}ms processing)`),o.info(`Success: ${i}/${r.length} courses, ${c} errors`),o.info(`Average: ${m.toFixed(0)}ms per course with ${n} concurrent workers`);let h=m*r.length/l;o.debug(`Estimated speedup: ${h.toFixed(1)}x faster than sequential processing`)}catch(e){o.error("Failed to update dashboard grades:",e)}}function be(){return["[data-course-id]",".ic-DashboardCard",'[class*="DashboardCard"]',".course-list-item",'[class*="CourseCard"]','div[id^="dashboard_card_"]',".dashboard-card"]}function go(){let e=be();for(let r of e){let n=document.querySelectorAll(r);if(n.length>0)return o.trace(`Found ${n.length} dashboard cards using selector: ${r}`),n}let t=document.querySelectorAll('a[href*="/courses/"]');if(t.length>0){o.trace(`Found ${t.length} course links as fallback`);let r=Array.from(t).filter(n=>!n.closest(".ic-app-header")&&!n.closest('[role="navigation"]')&&!n.closest(".menu"));if(r.length>0)return o.trace(`Found ${r.length} dashboard course links`),r}return o.trace("No dashboard cards found with any selector"),null}function po(e=5e3){return new Promise(t=>{let r=Date.now(),n=()=>{let s=go();if(s&&s.length>0){o.info(`Dashboard cards found: ${s.length}`),o.isTraceEnabled()&&s[0]&&(o.trace("First card element:",s[0]),o.trace("First card classes:",s[0].className),o.trace("First card attributes:",Array.from(s[0].attributes).map(a=>`${a.name}="${a.value}"`))),t(!0);return}if(Date.now()-r>e){o.warn("Timeout waiting for dashboard cards"),o.warn("Tried selectors:",be()),o.warn("Current URL:",window.location.href),o.warn("Dashboard container exists:",!!document.querySelector("#dashboard")),t(!1);return}setTimeout(n,100)};n()})}function ho(e){var n,s;if(e.nodeType!==Node.ELEMENT_NODE)return!1;let t=e;if((n=t.hasAttribute)!=null&&n.call(t,"data-course-id"))return!0;let r=t.className||"";return!!(typeof r=="string"&&(r.includes("DashboardCard")||r.includes("CourseCard")||r.includes("course-list-item")||r.includes("dashboard-card"))||(s=t.querySelector)!=null&&s.call(t,'a[href*="/courses/"]'))}function Eo(){Ee&&Ee.disconnect(),Ee=new MutationObserver(t=>{t.some(n=>Array.from(n.addedNodes).some(s=>{var a;return ho(s)||((a=s.querySelector)==null?void 0:a.call(s,be().join(",")))}))&&(o.trace("Dashboard cards detected via MutationObserver, updating grades"),cr())});let e=document.querySelector("#dashboard")||document.querySelector("#content")||document.body;Ee.observe(e,{childList:!0,subtree:!0}),o.trace("Dashboard observer setup complete, observing:",e.id||e.tagName)}function bo(){console.log("=== Dashboard Card Diagnostic ==="),console.log("Current URL:",window.location.href),console.log("Is dashboard page:",window.location.pathname==="/"||window.location.pathname.startsWith("/dashboard"));let e=be();console.log("Trying selectors:",e),e.forEach(n=>{try{let s=document.querySelectorAll(n);s.length>0?(console.log(`\u2713 Found ${s.length} elements with selector: ${n}`),console.log("  First element:",s[0])):console.log(`\u2717 No elements found with selector: ${n}`)}catch(s){console.log(`\u2717 Error with selector ${n}:`,s.message)}});let t=document.querySelectorAll('a[href*="/courses/"]');console.log(`Found ${t.length} total course links`);let r=Array.from(t).filter(n=>!n.closest(".ic-app-header")&&!n.closest('[role="navigation"]')&&!n.closest(".menu"));console.log(`Found ${r.length} dashboard course links`),r.length>0&&(console.log("First dashboard link:",r[0]),console.log("First dashboard link parent:",r[0].parentElement)),console.log("=== End Diagnostic ===")}async function dr(){if(sr){o.trace("Dashboard grade display already initialized");return}sr=!0,o.info("Initializing dashboard grade display"),window.CG||(window.CG={}),window.CG.diagnosticDashboard=bo,window.CG.testConcurrentPerformance=Co,o.info("Diagnostic function available: window.CG.diagnosticDashboard()"),o.info("Performance test available: window.CG.testConcurrentPerformance()"),await po()||(o.warn("Dashboard cards not found, grade display may not work"),o.warn("Run window.CG.diagnosticDashboard() in console for more info")),await cr(),Eo()}async function Co(){try{o.info("=== Performance Test: Sequential vs Concurrent Processing ===");let e=new G,t=await ir(e);if(t.length===0)return o.warn("No courses found for performance testing"),{error:"No courses found"};o.info(`Testing with ${t.length} courses`),oe(t),o.info("Test 1: Sequential processing...");let r=performance.now();for(let E of t)try{await ne(E.id,e)}catch(h){o.trace(`Sequential test error for course ${E.id}:`,h.message)}let n=performance.now()-r;o.info(`Sequential: ${n.toFixed(0)}ms total, ${(n/t.length).toFixed(0)}ms per course`);let{clearGradeCache:s}=await Promise.resolve().then(()=>(he(),tr));s(),oe(t),o.info("Test 2: Concurrent processing...");let a=performance.now(),i=ar,c=t.map(E=>E.id);async function d(){for(;c.length>0;){let E=c.shift();if(!E)break;try{await ne(E,e)}catch(h){o.trace(`Concurrent test error for course ${E}:`,h.message)}}}await Promise.all(Array.from({length:i},()=>d()));let u=performance.now()-a;o.info(`Concurrent: ${u.toFixed(0)}ms total, ${(u/t.length).toFixed(0)}ms per course`);let l=n/u,g=(n-u)/n*100,m={courses:t.length,concurrency:i,sequential:{total:Math.round(n),perCourse:Math.round(n/t.length)},concurrent:{total:Math.round(u),perCourse:Math.round(u/t.length)},speedup:l.toFixed(2),improvement:g.toFixed(1)+"%",timeSaved:Math.round(n-u)+"ms"};return o.info("=== Performance Test Results ==="),o.info(`Speedup: ${m.speedup}x faster (${m.improvement} improvement)`),o.info(`Time saved: ${m.timeSaved}`),o.info("Full results:",m),m}catch(e){return o.error("Performance test failed:",e),{error:e.message}}}S();var lr=!1,Ce=null,se="grading-box-extended";function Se(){let e=document.getElementById(se);if(!e){o.trace(`Grading dropdown element #${se} not found`);return}if(!e.hasAttribute("disabled")&&!e.hasAttribute("readonly")&&!e.hasAttribute("aria-disabled")){o.trace("Grading dropdown already active");return}e.removeAttribute("disabled"),e.removeAttribute("readonly"),e.removeAttribute("aria-disabled"),e.classList.remove("ui-state-disabled"),o.debug("Grading dropdown activated - removed disabled/readonly attributes")}function So(){Ce&&Ce.disconnect(),Ce=new MutationObserver(e=>{e.forEach(t=>{t.type==="childList"?t.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&(r.id===se?(o.trace("Grading dropdown added to DOM, activating"),Se()):r.querySelector&&r.querySelector(`#${se}`)&&(o.trace("Grading dropdown found in added subtree, activating"),Se()))}):t.type==="attributes"&&t.target.id===se&&(o.trace(`Grading dropdown attribute changed: ${t.attributeName}`),Se())})}),Ce.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","readonly","aria-disabled","class"]}),o.trace("Grading dropdown observer setup complete")}function ur(){if(lr){o.trace("SpeedGrader grading dropdown already initialized");return}lr=!0,o.info("Initializing SpeedGrader grading dropdown auto-activator"),Se(),So(),o.info("SpeedGrader grading dropdown auto-activator started")}v();v();v();S();function yo(e){var n;let t=typeof e=="string"?parseFloat(e):e;if(isNaN(t))return o.trace(`Invalid score for grade level conversion: ${e}`),null;let r=[...k].sort((s,a)=>a.points-s.points);for(let s of r)if(t>=s.points)return s.description;return((n=r[r.length-1])==null?void 0:n.description)||null}function ye(){var t,r;let e=document.querySelectorAll('a[href*="/assignments/"]');for(let n of e){if(n.textContent.trim()!==I)continue;let s=n.closest("tr");if(!s)continue;let a=[s.querySelector(".original_score"),s.querySelector(".original_points"),s.querySelector(".assignment_score .grade")],i=null;for(let u of a){if(!u)continue;let l=(t=u.textContent)==null?void 0:t.trim();if(!l)continue;let g=l.match(/(\d+(?:\.\d+)?)/);if(g){i=g[1],o.trace(`Found ${I} score in table: ${i} (from ${u.className})`);break}}if(!i)continue;let c=null,d=[s.querySelector(".assignment_score .tooltip"),s.querySelector(".assignment_score"),s.querySelector(".letter-grade"),s.querySelector(".grade-display")];for(let u of d){if(!u)continue;let l=(r=u.textContent)==null?void 0:r.trim();if(l){for(let g of k)if(l.includes(g.description)){c=g.description,o.trace(`Found letter grade in table: ${c}`);break}if(c)break}}return c||(c=yo(i),o.trace(`Calculated letter grade from score: ${c}`)),o.trace(`Extracted ${I}: score=${i}, letterGrade=${c}`),{score:i,letterGrade:c}}return o.trace(`No ${I} found on page`),null}S();var Ue=!1;function _o(){return document.querySelector('li[aria-controls="assignments"]')}function wo(){return document.querySelector('li[aria-controls="outcomes"] a[href="#outcomes"]')}function $o(){return document.querySelector("#right-side-wrapper")||document.querySelector("#right-side")}function mr(e=20,t=250){let r=_o();return r?(r.remove(),o.debug("Assignments tab removed"),!0):(e>0?setTimeout(()=>mr(e-1,t),t):o.trace("Assignments tab not found after retries"),!1)}function gr(){location.hash!=="#tab-outcomes"&&(history.replaceState(null,"",location.pathname+location.search+"#tab-outcomes"),window.dispatchEvent(new HashChangeEvent("hashchange")));let e=wo();e?e.click():setTimeout(gr,300)}function Ao(e,t){return t?`${e} (${t})`:e}function To(e){let{score:t,letterGrade:r}=e,n=Ao(t,r),s=$o();if(!s){o.trace("Right sidebar not found; deferring...");return}if(s.dataset.processed){let c=document.getElementById("mastery-right-side");if(c){let d=c.querySelector(".mastery-grade");d&&(d.textContent=n)}return}s.style.display="none",s.dataset.processed="true";let a=document.createElement("aside");a.id="mastery-right-side",a.setAttribute("role","complementary"),a.style.cssText=`
        color: inherit; font-weight: inherit; font-size: inherit; font-family: inherit;
        margin: inherit; padding: inherit; background: inherit; border: inherit;
    `,a.innerHTML=`
        <div id="student-grades-right-content">
            <div class="student_assignment mastery_total">
                ${T}: <span class="mastery-grade">${n}</span>
            </div>
        </div>
    `;let i=a.querySelector(".mastery_total");i&&(ce("h1.screenreader-only, h1, .ic-app-nav-toggle-and-crumbs h1",i)||(i.style.fontSize="1.5em",i.style.fontWeight="bold")),s.parentNode.insertBefore(a,s.nextSibling),o.debug(`Sidebar replaced with ${T}: ${n}`)}function Io(e){return Ue?!1:(At&&(mr(),gr()),To(e),Ue=!0,!0)}function fr(){if(Ue)return!0;let e=ye();return e===null?!1:Io(e)}function pr(){if(o.debug("Initializing grade page customizer"),!fr()){let t=new MutationObserver(()=>{fr()&&(t.disconnect(),o.debug("Student grade customization applied after DOM updates"))});t.observe(document.body,{childList:!0,subtree:!0,attributes:!0}),setTimeout(()=>{t.disconnect(),o.trace("Student grade customization observer disconnected (timeout)")},3e4)}}v();S();function hr(){document.querySelectorAll(".score-display").forEach(e=>{let t=e.innerHTML,r=t.replace(/<\/b>\s*\/\s*\d+(\.\d+)?\s*pts/i,"</b>");t!==r&&(e.innerHTML=r)}),document.querySelectorAll("span.tooltip").forEach(e=>{Array.from(e.children).forEach(t=>{t.childNodes.length===1&&t.childNodes[0].nodeType===Node.TEXT_NODE&&/^\/\s*\d+(\.\d+)?$/.test(t.textContent.trim())&&t.remove()})}),document.querySelectorAll("span, div, td").forEach(e=>{e.childNodes.length===1&&e.childNodes[0].nodeType===Node.TEXT_NODE&&/\/\s*\d+(\.\d+)?\s*pts/i.test(e.textContent)&&(e.textContent=e.textContent.replace(/\/\s*\d+(\.\d+)?\s*pts/gi,""))}),document.querySelectorAll(".screenreader-only").forEach(e=>{let t=e.textContent,r=t.replace(/out of\s*\d+(\.\d+)?\s*points?\.?/i,"").trim();t!==r&&(e.textContent=r)}),document.querySelectorAll("span.css-1jyml41-text").forEach(e=>{let r=e.textContent.trim().match(/^(\d+(\.\d+)?)[/]\s*\d+(\.\d+)?$/);r&&(e.textContent=r[1])}),document.querySelectorAll("span.points-value strong").forEach(e=>{let r=e.textContent.trim().match(/^(\d+(\.\d+)?)[/]\s*\d+(\.\d+)?$/);r&&(e.textContent=r[1])}),document.querySelectorAll("span.css-7cbhck-text").forEach(e=>{let r=e.textContent.trim().match(/^(\d+(\.\d+)?)[/]\s*\d+(\.\d+)?$/);r&&(e.textContent=r[1])}),document.querySelectorAll('a[data-track-category="dashboard"][data-track-label="recent feedback"]').forEach(e=>{let t=e.querySelector(".recent_feedback_title"),r=e.querySelector(".event-details strong");if(!t||!r)return;let n=t.textContent.trim().replace(/\s+/g," ").toLowerCase(),s=I.trim().replace(/\s+/g," ").toLowerCase();if(n!==s)return;let i=r.textContent.trim().match(/^(\d+(\.\d+)?)\s+out of\s+\d+(\.\d+)?$/i);i&&(r.textContent=i[1])}),vo(),No()}function vo(){document.querySelectorAll("tr.student_assignment.hard_coded.group_total").forEach(e=>{let t=e.querySelector(".assignment_score .tooltip .grade");if(t){let n=t.textContent.trim();/^\d+(\.\d+)?%?$/.test(n)&&(t.textContent="")}let r=e.querySelector(".details .possible.points_possible");if(r){let n=r.textContent.trim();/^\d+(\.\d+)?\s*\/\s*\d+(\.\d+)?$/.test(n)&&(r.textContent="")}})}function xo(e,t){return t?`${e} (${t})`:e}function No(){document.querySelectorAll("tr.student_assignment.hard_coded.final_grade").forEach(e=>{let t=e.querySelector(".assignment_score .tooltip .grade"),r=e.querySelector(".details .possible.points_possible");if(t){let n=ye();if(n&&n.score){let s=xo(n.score,n.letterGrade);t.textContent=s}else{let s=t.textContent.trim();/^\d+(\.\d+)?%$/.test(s)&&(t.textContent="")}}if(r){let n=r.textContent.trim();/^\d+(\.\d+)?\s*\/\s*\d+(\.\d+)?$/.test(n)&&(r.textContent="")}})}S();function Go(e,t){let r;return function(){clearTimeout(r),r=setTimeout(()=>e(),t)}}function Ro(){let e=window.location.pathname;return window.location.href.includes("/courses/")&&(e.includes("/grades")||e.includes("/assignments")||/^\/courses\/\d+$/.test(e))}function Er(){return $e()||Ro()}function br(){o.debug("Starting cleanup observers for grade normalization");let e=Go(()=>{Er()&&hr()},100);setTimeout(()=>{e();let t=new MutationObserver(()=>{e()});Er()&&(t.observe(document.body,{childList:!0,subtree:!0}),o.debug("MutationObserver started for grade cleanup"));let r=location.href;setInterval(()=>{location.href!==r&&(r=location.href,e())},1e3)},500)}async function Cr(){if($e())o.debug("Initializing cleanup observers for dashboard"),br();else{if(!await xt()){o.debug("Skipping fraction cleanup \u2014 no Current Score Assignment in this course");return}o.debug("Initializing cleanup observers for course page"),br()}}S();function Oo(){return window.location.href.includes("/courses/")&&window.location.pathname.includes("/grades")}function Sr(){if(!$t){o.debug("Student grade customization disabled");return}if(vt()!=="student_like"){o.debug("User is not student-like, skipping student customizations");return}o.info("Initializing student grade customizations"),Oo()&&(o.debug("On student grades page, initializing grade page customizer"),pr()),Cr()}function Do(){let e=window.location.pathname;return e==="/"||e==="/dashboard"||e.startsWith("/dashboard/")}function Lo(){return window.location.pathname.includes("/speed_grader")}(function(){je("prod","2026-01-15 5:05:09 PM (prod, 1271e52)"),Ye("prod","2026-01-15 5:05:09 PM (prod, 1271e52)"),o.info("Running in PROD mode"),o.info("Build environment: prod"),window.location.pathname.includes("/gradebook")&&er(),Do()&&dr(),Lo()&&ur(),Sr()})();})();
